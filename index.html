<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeLink - ì‹œê°„ì„ ìŒì•…ìœ¼ë¡œ</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary: #667eea;
            --primary-dark: #5568d3;
            --secondary: #764ba2;
            --accent: #f093fb;
            --success: #4CAF50;
            --warning: #ff9800;
            --danger: #f44336;
            --dark: #1a1a2e;
            --light: #f8f9fa;
            --text: #2d3748;
            --text-light: #718096;
            --border: #e2e8f0;
            --shadow: rgba(0, 0, 0, 0.1);
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: var(--text);
        }

        /* ===== ì¸ì¦ í™”ë©´ ===== */
        #authContainer {
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 100vh;
            padding: 20px;
        }

        .auth-card {
            background: white;
            border-radius: 30px;
            padding: 50px;
            max-width: 450px;
            width: 100%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .logo {
            text-align: center;
            margin-bottom: 40px;
        }

        .logo-icon {
            width: 80px;
            height: 80px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 20px;
            display: inline-flex;
            align-items: center;
            justify-content: center;
            font-size: 40px;
            margin-bottom: 15px;
        }

        .logo h1 {
            font-size: 32px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 5px;
        }

        .logo p {
            color: var(--text-light);
            font-size: 14px;
        }

        .input-group {
            margin-bottom: 20px;
        }

        .input-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text);
        }

        .input-group input {
            width: 100%;
            padding: 15px 20px;
            border: 2px solid var(--border);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.3s;
        }

        .input-group input:focus {
            outline: none;
            border-color: var(--primary);
            box-shadow: 0 0 0 4px rgba(102, 126, 234, 0.1);
        }

        .btn-primary {
            width: 100%;
            padding: 16px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.3);
        }

        .btn-secondary {
            width: 100%;
            padding: 16px;
            background: white;
            color: var(--primary);
            border: 2px solid var(--primary);
            border-radius: 12px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            margin-top: 10px;
        }

        .btn-secondary:hover {
            background: var(--primary);
            color: white;
        }

        /* ===== ë©”ì¸ ì•± ===== */
        #appContainer {
            display: none;
            min-height: 100vh;
            background: var(--light);
        }

        /* í—¤ë” */
        .header {
            background: white;
            padding: 20px 30px;
            box-shadow: 0 2px 10px var(--shadow);
            display: flex;
            justify-content: space-between;
            align-items: center;
            position: sticky;
            top: 0;
            z-index: 100;
        }

        .header-left {
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .header-logo {
            width: 50px;
            height: 50px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            border-radius: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .header-title h1 {
            font-size: 24px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .header-title p {
            font-size: 12px;
            color: var(--text-light);
        }

        .header-right {
            display: flex;
            align-items: center;
            gap: 20px;
        }

        .balance-card {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            padding: 12px 20px;
            border-radius: 12px;
            color: white;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .balance-amount {
            font-size: 20px;
            font-weight: 700;
        }

        .balance-label {
            font-size: 11px;
            opacity: 0.9;
        }

        .user-menu {
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
            padding: 8px 15px;
            border-radius: 12px;
            transition: background 0.2s;
        }

        .user-menu:hover {
            background: var(--light);
        }

        .user-avatar {
            width: 40px;
            height: 40px;
            background: linear-gradient(135deg, var(--accent) 0%, var(--warning) 100%);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-weight: 700;
        }

        /* ë©”ì¸ ì»¨í…Œì´ë„ˆ */
        .main-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 30px;
            display: grid;
            grid-template-columns: 250px 1fr;
            gap: 30px;
        }

        /* ì‚¬ì´ë“œë°” */
        .sidebar {
            background: white;
            border-radius: 20px;
            padding: 20px;
            height: fit-content;
            position: sticky;
            top: 110px;
            box-shadow: 0 4px 20px var(--shadow);
        }

        .nav-item {
            padding: 15px 20px;
            margin-bottom: 8px;
            border-radius: 12px;
            cursor: pointer;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            gap: 12px;
            color: var(--text);
            font-weight: 500;
        }

        .nav-item:hover {
            background: var(--light);
        }

        .nav-item.active {
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            color: white;
        }

        .nav-item-icon {
            font-size: 20px;
        }

        /* ì½˜í…ì¸  ì˜ì—­ */
        .content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            box-shadow: 0 4px 20px var(--shadow);
            min-height: 600px;
        }

        .page {
            display: none;
        }

        .page.active {
            display: block;
            animation: fadeIn 0.3s;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* í˜ì´ì§€ í—¤ë” */
        .page-header {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 2px solid var(--border);
        }

        .page-title {
            font-size: 32px;
            font-weight: 700;
            margin-bottom: 8px;
            color: var(--text);
        }

        .page-subtitle {
            color: var(--text-light);
            font-size: 16px;
        }

        /* ìŒì•… ì¹´ë“œ */
        .music-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(200px, 1fr));
            gap: 20px;
        }

        .music-card {
            background: white;
            border-radius: 16px;
            overflow: hidden;
            cursor: pointer;
            transition: transform 0.2s, box-shadow 0.2s;
            border: 2px solid var(--border);
        }

        .music-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .music-cover {
            width: 100%;
            height: 200px;
            background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 60px;
            position: relative;
        }

        .play-overlay {
            position: absolute;
            inset: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: opacity 0.2s;
        }

        .music-card:hover .play-overlay {
            opacity: 1;
        }

        .play-button {
            width: 60px;
            height: 60px;
            background: white;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
        }

        .music-info {
            padding: 15px;
        }

        .music-title {
            font-weight: 600;
            margin-bottom: 5px;
            font-size: 15px;
        }

        .music-meta {
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-size: 12px;
            color: var(--text-light);
        }

        .music-badge {
            display: inline-block;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 600;
            margin-top: 8px;
        }

        .badge-shared {
            background: #fff3e0;
            color: #f57c00;
        }

        .badge-commercial {
            background: #e8eaf6;
            color: #5e35b1;
        }

        /* ì—…ë¡œë“œ ì˜ì—­ */
        .upload-zone {
            border: 3px dashed var(--border);
            border-radius: 20px;
            padding: 60px 20px;
            text-align: center;
            background: var(--light);
        }

        .upload-icon {
            font-size: 80px;
            margin-bottom: 20px;
        }

        .upload-text {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 10px;
        }

        .upload-hint {
            color: var(--text-light);
            font-size: 14px;
        }

        /* ì¶©ì „ ì˜µì…˜ */
        .charge-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 30px;
        }

        .charge-option {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            border: 3px solid var(--border);
            border-radius: 20px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s;
        }

        .charge-option:hover {
            transform: translateY(-5px);
            border-color: var(--primary);
            box-shadow: 0 10px 30px var(--shadow);
        }

        .charge-icon {
            font-size: 50px;
            margin-bottom: 15px;
        }

        .charge-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .charge-amount {
            font-size: 32px;
            font-weight: 700;
            color: var(--primary);
            margin: 15px 0;
        }

        .charge-price {
            color: var(--text-light);
            font-size: 14px;
        }

        .discount-badge {
            display: inline-block;
            background: var(--success);
            color: white;
            padding: 5px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            margin-top: 10px;
        }

        /* í† ìŠ¤íŠ¸ */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 25px;
            border-radius: 12px;
            box-shadow: 0 10px 40px var(--shadow);
            display: none;
            align-items: center;
            gap: 15px;
            max-width: 400px;
            z-index: 1000;
            animation: slideIn 0.3s;
        }

        @keyframes slideIn {
            from { transform: translateX(400px); }
            to { transform: translateX(0); }
        }

        .toast.show {
            display: flex;
        }

        .toast-icon {
            font-size: 24px;
        }

        .toast-message {
            flex: 1;
            font-size: 14px;
        }

        .toast.success {
            border-left: 4px solid var(--success);
        }

        .toast.error {
            border-left: 4px solid var(--danger);
        }

        /* ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal.show {
            display: flex;
        }

        .modal-content {
            background: white;
            border-radius: 20px;
            padding: 40px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-header {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 20px;
        }

        .modal-close {
            float: right;
            font-size: 28px;
            cursor: pointer;
            color: var(--text-light);
        }

        .modal-close:hover {
            color: var(--text);
        }

        /* ë°˜ì‘í˜• */
        @media (max-width: 1024px) {
            .main-container {
                grid-template-columns: 1fr;
            }

            .sidebar {
                position: static;
                margin-bottom: 20px;
            }

            .nav-item {
                display: inline-flex;
                margin-right: 8px;
            }
        }

        @media (max-width: 768px) {
            .header {
                padding: 15px 20px;
                flex-wrap: wrap;
            }

            .header-title h1 {
                font-size: 18px;
            }

            .header-title p {
                display: none;
            }

            .balance-card {
                padding: 6px 10px;
            }

            .balance-amount {
                font-size: 14px;
            }

            .balance-label {
                font-size: 10px;
            }

            .main-container {
                padding: 15px;
            }

            .content {
                padding: 20px;
            }

            .page-title {
                font-size: 24px;
            }

            .music-grid {
                grid-template-columns: repeat(auto-fill, minmax(150px, 1fr));
                gap: 15px;
            }

            .charge-grid {
                grid-template-columns: 1fr;
            }
        }

        /* ë¡œë”© */
        .loading {
            text-align: center;
            padding: 60px;
            color: var(--text-light);
        }

        .spinner {
            width: 50px;
            height: 50px;
            border: 4px solid var(--border);
            border-top-color: var(--primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto 20px;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 80px 20px;
        }

        .empty-icon {
            font-size: 80px;
            margin-bottom: 20px;
            opacity: 0.3;
        }

        .empty-title {
            font-size: 20px;
            font-weight: 600;
            margin-bottom: 10px;
            color: var(--text);
        }

        .empty-subtitle {
            color: var(--text-light);
            font-size: 14px;
        }

        /* ìƒì—… ë°©ì†¡êµ­ íŠ¹ë³„ ìŠ¤íƒ€ì¼ */
        .commercial-header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 40px;
            border-radius: 20px;
            margin-bottom: 30px;
        }

        .commercial-title {
            font-size: 28px;
            font-weight: 700;
            margin-bottom: 10px;
        }

        .commercial-subtitle {
            font-size: 16px;
            opacity: 0.95;
            margin-bottom: 25px;
        }

        .commercial-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 20px;
            background: rgba(255, 255, 255, 0.2);
            padding: 25px;
            border-radius: 15px;
            backdrop-filter: blur(10px);
        }

        .stat-item {
            text-align: center;
        }

        .stat-value {
            font-size: 24px;
            font-weight: 700;
            margin-bottom: 5px;
        }

        .stat-label {
            font-size: 12px;
            opacity: 0.9;
        }

        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            inset: 0;
            background: #ccc;
            border-radius: 30px;
            transition: 0.4s;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            border-radius: 50%;
            transition: 0.4s;
        }

        input:checked + .toggle-slider {
            background: var(--primary);
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }
    </style>
</head>
<body>
    <!-- ì¸ì¦ ì»¨í…Œì´ë„ˆ -->
    <div id="authContainer">
        <div class="auth-card">
            <div class="logo">
                <div class="logo-icon">ğŸµ</div>
                <h1>TimeLink</h1>
                <p>ì‹œê°„ì„ ìŒì•…ìœ¼ë¡œ, ìŒì•…ì„ ê°€ì¹˜ë¡œ</p>
            </div>

            <div id="loginForm">
                <div class="input-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="loginEmail" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
                <button class="btn-secondary" onclick="showSignup()">íšŒì›ê°€ì…</button>
            </div>

            <div id="signupForm" style="display: none;">
                <div class="input-group">
                    <label>ì´ë¦„</label>
                    <input type="text" id="signupUsername" placeholder="í™ê¸¸ë™">
                </div>
                <div class="input-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="signupEmail" placeholder="your@email.com">
                </div>
                <div class="input-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="btn-primary" onclick="signup()">ê°€ì…í•˜ê¸°</button>
                <button class="btn-secondary" onclick="showLogin()">ë¡œê·¸ì¸ìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

    <!-- ì•± ì»¨í…Œì´ë„ˆ -->
    <div id="appContainer">
        <!-- í—¤ë” -->
        <div class="header">
            <div class="header-left">
                <div class="header-logo">ğŸµ</div>
                <div class="header-title">
                    <h1>TimeLink</h1>
                    <p>ì‹œê°„ì„ ìŒì•…ìœ¼ë¡œ</p>
                </div>
            </div>
            <div class="header-right">
                <div class="balance-card" style="background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);">
                    <div>
                        <div class="balance-amount" id="headerTL">0</div>
                        <div class="balance-label">TL (â‚©<span id="headerWon">0</span>)</div>
                    </div>
                </div>
                <div class="balance-card" style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); color: #000;">
                    <div>
                        <div class="balance-amount" id="headerTLC">0</div>
                        <div class="balance-label">TLC (ì±„êµ´)</div>
                    </div>
                </div>
                <div class="user-menu" onclick="logout()">
                    <div class="user-avatar" id="headerAvatar">U</div>
                    <div>
                        <div style="font-weight: 600; font-size: 14px;" id="headerUsername">ì‚¬ìš©ì</div>
                        <div style="font-size: 12px; color: var(--text-light);">ë¡œê·¸ì•„ì›ƒ</div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ë©”ì¸ ì»¨í…Œì´ë„ˆ -->
        <div class="main-container">
            <!-- ì‚¬ì´ë“œë°” -->
            <div class="sidebar">
                <div class="nav-item active" onclick="switchPage('discover')">
                    <span class="nav-item-icon">ğŸµ</span>
                    <span>ìŒì•… ë°œê²¬</span>
                </div>
                <div class="nav-item" onclick="switchPage('library')">
                    <span class="nav-item-icon">ğŸ“š</span>
                    <span>ë‚´ ë¼ì´ë¸ŒëŸ¬ë¦¬</span>
                </div>
                <div class="nav-item" onclick="switchPage('upload')">
                    <span class="nav-item-icon">ğŸ“¤</span>
                    <span>ì—…ë¡œë“œ</span>
                </div>
                <div class="nav-item" onclick="switchPage('mining')">
                    <span class="nav-item-icon">â›ï¸</span>
                    <span>ì±„êµ´ & ìˆ˜ìµ</span>
                </div>
                <div class="nav-item" onclick="switchPage('commercial')">
                    <span class="nav-item-icon">ğŸ“»</span>
                    <span>ìƒì—… ë°©ì†¡êµ­</span>
                </div>
                <div class="nav-item" onclick="switchPage('charge')">
                    <span class="nav-item-icon">ğŸ’°</span>
                    <span>TL ì¶©ì „</span>
                </div>
            </div>

            <!-- ì½˜í…ì¸  -->
            <div class="content">
                <!-- ìŒì•… ë°œê²¬ í˜ì´ì§€ -->
                <div id="pageDiscover" class="page active">
                    <div class="page-header">
                        <div class="page-title">ìŒì•… ë°œê²¬</div>
                        <div class="page-subtitle">TimeLinkì˜ ë‹¤ì–‘í•œ ìŒì•…ì„ ë§Œë‚˜ë³´ì„¸ìš”</div>
                    </div>
                    <div id="discoverContent" class="music-grid"></div>
                </div>

                <!-- ë‚´ ë¼ì´ë¸ŒëŸ¬ë¦¬ í˜ì´ì§€ -->
                <div id="pageLibrary" class="page">
                    <div class="page-header">
                        <div class="page-title">ë‚´ ë¼ì´ë¸ŒëŸ¬ë¦¬</div>
                        <div class="page-subtitle">ë‚´ê°€ ì—…ë¡œë“œí•œ ìŒì•…</div>
                    </div>
                    <div id="libraryContent" class="music-grid"></div>
                </div>

                <!-- ì—…ë¡œë“œ í˜ì´ì§€ -->
                <div id="pageUpload" class="page">
                    <div class="page-header">
                        <div class="page-title">ìŒì•… ì—…ë¡œë“œ</div>
                        <div class="page-subtitle">ë‹¹ì‹ ì˜ ìŒì•…ì„ ì„¸ìƒê³¼ ë‚˜ëˆ„ì„¸ìš”</div>
                    </div>
                    
                    <div class="upload-zone" id="uploadZone">
                        <div class="upload-icon">ğŸ“</div>
                        <div class="upload-text">íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
                        <div class="upload-hint">MP3, MP4, JPG ì§€ì›</div>
                        <div style="position: relative; display: inline-block; margin-top: 20px;">
                            <div class="btn-primary" style="pointer-events: none;">
                                ğŸ“‚ íŒŒì¼ ì„ íƒ
                            </div>
                            <input 
                                type="file" 
                                id="fileInput" 
                                accept="audio/mpeg,audio/mp3,audio/wav,audio/m4a,video/mp4,video/webm,image/jpeg,image/jpg,image/png,image/gif"
                                onchange="handleFileSelect(event)"
                                style="position: absolute; top: 0; left: 0; width: 100%; height: 100%; opacity: 0; cursor: pointer;">
                        </div>
                    </div>
                    
                    <div id="uploadForm" style="display: none; margin-top: 30px;"></div>
                </div>

                <!-- ì±„êµ´ & ìˆ˜ìµ í˜ì´ì§€ -->
                <div id="pageMining" class="page">
                    <div class="page-header">
                        <div class="page-title">â›ï¸ ì±„êµ´ & ìˆ˜ìµ</div>
                        <div class="page-subtitle">TLê³¼ TLC, ë‘ ê°€ì§€ ìˆ˜ìµ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”</div>
                    </div>

                    <!-- TLC ì”ì•¡ -->
                    <div style="background: linear-gradient(135deg, #ffd700 0%, #ffed4e 100%); padding: 30px; border-radius: 20px; margin-bottom: 30px; color: #000;">
                        <div style="text-align: center;">
                            <div style="font-size: 16px; margin-bottom: 10px; opacity: 0.8;">ğŸ’ TLC ì”ì•¡</div>
                            <div style="font-size: 48px; font-weight: 700; margin-bottom: 10px;" id="tlcBalance">0</div>
                            <div style="font-size: 14px; opacity: 0.7;">TimeLink Coin (ì±„êµ´ í† í°)</div>
                        </div>
                    </div>

                    <!-- ìˆ˜ìµ ë°©ì‹ ì„¤ëª… -->
                    <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 30px;">
                        <!-- 7:3 ë°©ì‹ -->
                        <div style="background: white; border: 3px solid var(--primary); border-radius: 20px; padding: 30px;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 40px; margin-bottom: 10px;">ğŸ’µ</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 5px;">7:3 ë°©ì‹</div>
                                <div style="font-size: 14px; color: var(--text-light);">TL ì¦‰ì‹œ ìˆ˜ë ¹</div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; color: var(--text); margin-bottom: 10px; font-weight: 600;">ğŸ’° ìˆ˜ìµ ë¶„ë°°</div>
                                <div style="background: var(--light); padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>ì°½ì‘ì</span>
                                        <span style="font-weight: 700; color: var(--primary);">70%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>í”Œë«í¼</span>
                                        <span style="font-weight: 700; color: var(--text-light);">30%</span>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: var(--text); line-height: 1.6;">
                                <div style="margin-bottom: 8px;">âœ… <strong>ì¦‰ì‹œ ìˆ˜ë ¹:</strong> TLë¡œ ë°”ë¡œ ë°›ìŒ</div>
                                <div style="margin-bottom: 8px;">âœ… <strong>ì•ˆì •ì :</strong> ë³€ë™ ì—†ëŠ” ìˆ˜ìµ</div>
                                <div style="margin-bottom: 8px;">âœ… <strong>ê°„í¸í•¨:</strong> ì¶”ê°€ ì„¤ì • ë¶ˆí•„ìš”</div>
                                <div>ğŸ“Š <strong>ì˜ˆì‹œ:</strong> 1,000 TL ì†Œë¹„ â†’ 700 TL ìˆ˜ë ¹</div>
                            </div>
                        </div>

                        <!-- 5:5 ë°©ì‹ -->
                        <div style="background: white; border: 3px solid #ffd700; border-radius: 20px; padding: 30px;">
                            <div style="text-align: center; margin-bottom: 20px;">
                                <div style="font-size: 40px; margin-bottom: 10px;">â›ï¸</div>
                                <div style="font-size: 24px; font-weight: 700; color: #ffd700; margin-bottom: 5px;">5:5 ë°©ì‹</div>
                                <div style="font-size: 14px; color: var(--text-light);">TLC ì±„êµ´</div>
                            </div>
                            <div style="margin-bottom: 20px;">
                                <div style="font-size: 14px; color: var(--text); margin-bottom: 10px; font-weight: 600;">â›ï¸ ìˆ˜ìµ ë¶„ë°°</div>
                                <div style="background: #fff9e6; padding: 15px; border-radius: 10px; margin-bottom: 10px;">
                                    <div style="display: flex; justify-content: space-between; margin-bottom: 5px;">
                                        <span>ì°½ì‘ì (TL)</span>
                                        <span style="font-weight: 700; color: var(--primary);">50%</span>
                                    </div>
                                    <div style="display: flex; justify-content: space-between;">
                                        <span>í”Œë«í¼ (TLC ì±„êµ´)</span>
                                        <span style="font-weight: 700; color: #ffd700;">50%</span>
                                    </div>
                                </div>
                            </div>
                            <div style="font-size: 13px; color: var(--text); line-height: 1.6;">
                                <div style="margin-bottom: 8px;">âœ… <strong>TLC íšë“:</strong> í”Œë«í¼ ê¸°ì—¬ë¡œ ì±„êµ´</div>
                                <div style="margin-bottom: 8px;">âœ… <strong>ì¥ê¸° ê°€ì¹˜:</strong> TLC ê°€ì¹˜ ìƒìŠ¹ ê°€ëŠ¥</div>
                                <div style="margin-bottom: 8px;">âœ… <strong>ì´ì¤‘ ìˆ˜ìµ:</strong> TL + TLC</div>
                                <div>ğŸ“Š <strong>ì˜ˆì‹œ:</strong> 1,000 TL ì†Œë¹„ â†’ 500 TL + TLC ì±„êµ´</div>
                            </div>
                        </div>
                    </div>

                    <!-- ì±„êµ´ í†µê³„ -->
                    <div style="background: white; border-radius: 20px; padding: 30px; margin-bottom: 20px; border: 2px solid var(--border);">
                        <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>ğŸ“Š</span>
                            <span>ë‚´ ì±„êµ´ í†µê³„</span>
                        </h3>
                        <div style="display: grid; grid-template-columns: repeat(4, 1fr); gap: 20px;">
                            <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 15px;">
                                <div style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">ì´ ì±„êµ´ëŸ‰</div>
                                <div style="font-size: 24px; font-weight: 700; color: #ffd700;" id="totalMined">0 TLC</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 15px;">
                                <div style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">ê¸°ì—¬ë„ ì ìˆ˜</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--primary);" id="contributionScore">0</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 15px;">
                                <div style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">5:5 íŒŒì¼</div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--success);" id="miningFiles">0ê°œ</div>
                            </div>
                            <div style="text-align: center; padding: 20px; background: var(--light); border-radius: 15px;">
                                <div style="font-size: 14px; color: var(--text-light); margin-bottom: 8px;">ì±„êµ´ë¥ </div>
                                <div style="font-size: 24px; font-weight: 700; color: var(--warning);" id="miningRate">0%</div>
                            </div>
                        </div>
                    </div>

                    <!-- ë‚´ íŒŒì¼ ìˆ˜ìµ ì„¤ì • -->
                    <div style="background: white; border-radius: 20px; padding: 30px; border: 2px solid var(--border);">
                        <h3 style="margin-bottom: 20px; display: flex; align-items: center; gap: 10px;">
                            <span>âš™ï¸</span>
                            <span>íŒŒì¼ë³„ ìˆ˜ìµ ì„¤ì •</span>
                        </h3>
                        <div id="miningFileList"></div>
                    </div>
                </div>

                <!-- ìƒì—… ë°©ì†¡êµ­ í˜ì´ì§€ -->
                <div id="pageCommercial" class="page">
                    <div class="commercial-header">
                        <div class="commercial-title">ğŸ“» ìƒì—… ë°©ì†¡êµ­</div>
                        <div class="commercial-subtitle">ì¹´í˜, ë ˆìŠ¤í† ë‘ì„ ìœ„í•œ í”„ë¦¬ë¯¸ì—„ ìŒì•… ì„œë¹„ìŠ¤</div>
                        <div class="commercial-stats">
                            <div class="stat-item">
                                <div class="stat-value">5,000 TL</div>
                                <div class="stat-label">ê³µìœ  ë“±ë¡ë¹„</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">20%</div>
                                <div class="stat-label">ì¬ìƒ ê°€ì¤‘ì¹˜</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">36 TL</div>
                                <div class="stat-label">3ë¶„ê³¡ 1íšŒ ìˆ˜ìµ</div>
                            </div>
                            <div class="stat-item">
                                <div class="stat-value">139íšŒ</div>
                                <div class="stat-label">ì†ìµë¶„ê¸°</div>
                            </div>
                        </div>
                    </div>

                    <div style="margin-bottom: 30px;">
                        <label style="display: flex; align-items: center; gap: 15px; cursor: pointer; padding: 20px; background: var(--light); border-radius: 15px;">
                            <label class="toggle-switch">
                                <input type="checkbox" id="commercialToggle" onchange="toggleCommercialMode()">
                                <span class="toggle-slider"></span>
                            </label>
                            <div>
                                <div style="font-weight: 600; font-size: 16px;">ìƒì—… ëª¨ë“œ</div>
                                <div style="font-size: 13px; color: var(--text-light); margin-top: 5px;">í™œì„±í™”í•˜ë©´ ì°½ì‘ìì—ê²Œ 20% ê°€ì¤‘ì¹˜ë¡œ ìˆ˜ìµì´ ì§€ê¸‰ë©ë‹ˆë‹¤</div>
                            </div>
                        </label>
                    </div>

                    <div id="commercialContent" class="music-grid"></div>
                </div>

                <!-- TL ì¶©ì „ í˜ì´ì§€ -->
                <div id="pageCharge" class="page">
                    <div class="page-header">
                        <div class="page-title">TL ì¶©ì „</div>
                        <div class="page-subtitle">1 TL = 1ì› = 1ì´ˆ ì¬ìƒ</div>
                    </div>

                    <div class="charge-grid">
                        <div class="charge-option" onclick="watchAd()">
                            <div class="charge-icon">ğŸ“º</div>
                            <div class="charge-title">ê´‘ê³  ì‹œì²­</div>
                            <div class="charge-amount">+10 TL</div>
                            <div class="charge-price">30ì´ˆ ê´‘ê³  ë¬´ë£Œ</div>
                        </div>

                        <div class="charge-option" onclick="buyTL(1000)">
                            <div class="charge-icon">ğŸ’³</div>
                            <div class="charge-title">ê¸°ë³¸</div>
                            <div class="charge-amount">1,000 TL</div>
                            <div class="charge-price">â‚©1,000</div>
                        </div>

                        <div class="charge-option" onclick="buyTL(5000)">
                            <div class="charge-icon">ğŸ</div>
                            <div class="charge-title">ì¸ê¸°</div>
                            <div class="charge-amount">5,000 TL</div>
                            <div class="charge-price">â‚©4,500</div>
                            <div class="discount-badge">10% í• ì¸</div>
                        </div>

                        <div class="charge-option" onclick="buyTL(10000)">
                            <div class="charge-icon">ğŸ’</div>
                            <div class="charge-title">í”„ë¦¬ë¯¸ì—„</div>
                            <div class="charge-amount">10,000 TL</div>
                            <div class="charge-price">â‚©8,000</div>
                            <div class="discount-badge">20% í• ì¸</div>
                        </div>

                        <div class="charge-option" onclick="buyTL(50000)">
                            <div class="charge-icon">ğŸ‘‘</div>
                            <div class="charge-title">VIP</div>
                            <div class="charge-amount">50,000 TL</div>
                            <div class="charge-price">â‚©35,000</div>
                            <div class="discount-badge">30% í• ì¸</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- í† ìŠ¤íŠ¸ -->
    <div id="toast" class="toast">
        <div class="toast-icon" id="toastIcon"></div>
        <div class="toast-message" id="toastMessage"></div>
    </div>

    <!-- ê´‘ê³  ëª¨ë‹¬ -->
    <div id="adModal" class="modal">
        <div class="modal-content" style="text-align: center;">
            <div style="font-size: 80px; margin: 20px 0;">ğŸ“º</div>
            <h2>ê´‘ê³  ì‹œì²­ ì¤‘...</h2>
            <div style="font-size: 48px; font-weight: 700; color: var(--primary); margin: 30px 0;" id="adTimer">30</div>
            <p style="color: var(--text-light);">ê´‘ê³ ê°€ ëë‚˜ë©´ 10 TL (â‚©10)ì´ ì§€ê¸‰ë©ë‹ˆë‹¤</p>
        </div>
    </div>

    <!-- TL ì¶©ì „ ëª¨ë‹¬ -->
    <div id="chargeModal" class="modal">
        <div class="modal-content">
            <span class="modal-close" onclick="closeChargeModal()">&times;</span>
            <h2 class="modal-header">ğŸ’° TL ì¶©ì „</h2>
            <div id="chargeModalContent"></div>
        </div>
    </div>

    <!-- ê³µìœ  ë“±ë¡ ëª¨ë‹¬ -->
    <div id="shareModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="modal-close" onclick="closeShareModal()">&times;</span>
            <h2 class="modal-header">ğŸ“» ìƒì—… ë°©ì†¡êµ­ ê³µìœ  ë“±ë¡</h2>
            <div id="shareModalContent"></div>
        </div>
    </div>

    <!-- í”Œë ˆì´ì–´ ëª¨ë‹¬ -->
    <div id="playerModal" class="modal">
        <div class="modal-content" style="max-width: 800px;">
            <span class="modal-close" onclick="closePlayer()">&times;</span>
            <h2 class="modal-header" id="playerTitle">ì¬ìƒ ì¤‘</h2>
            <div id="playerDisplay" style="margin: 20px 0; min-height: 300px; display: flex; align-items: center; justify-content: center; background: var(--light); border-radius: 15px;"></div>
            <div style="text-align: center; padding: 20px;">
                <div style="font-size: 24px; font-weight: 700; color: var(--primary); margin-bottom: 10px;">
                    ğŸ’ <span id="playerTL">0</span> TL
                </div>
                <div style="font-size: 14px; color: var(--text-light);">
                    ì¬ìƒ ì‹œê°„: <span id="playerTime">0:00</span> / <span id="playerDuration">0:00</span>
                </div>
            </div>
            <button class="btn-primary" onclick="closePlayer()" style="width: 100%;">ë‹«ê¸°</button>
        </div>
    </div>

    <script>
        // ì „ì—­ ë³€ìˆ˜
        let users = JSON.parse(localStorage.getItem('timelink_users_v3')) || [];
        let currentUser = null;
        let uploadedFiles = [];
        let fileBlobCache = {};  // Blob URL ìºì‹œ
        const COMMERCIAL_PLAY_WEIGHT = 0.2;
        const SHARE_FEE = 5000;
        let isCommercialMode = false;

        // ì¸ì¦
        function showSignup() {
            document.getElementById('loginForm').style.display = 'none';
            document.getElementById('signupForm').style.display = 'block';
        }

        function showLogin() {
            document.getElementById('signupForm').style.display = 'none';
            document.getElementById('loginForm').style.display = 'block';
        }

        async function signup() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;

            if (!username || !email || !password) {
                showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            if (users.find(u => u.email === email)) {
                showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤', 'error');
                return;
            }

            const newUser = {
                id: Date.now().toString(),
                username,
                email,
                password,
                tlBalance: 10000,
                tlcBalance: 0,
                contributionScore: 0,
                uploadedFiles: 0,
                createdAt: Date.now()
            };

            users.push(newUser);
            localStorage.setItem('timelink_users_v3', JSON.stringify(users));

            showToast('âœ… íšŒì›ê°€ì… ì„±ê³µ!\nğŸ 10,000 TL (â‚©10,000) ì§€ê¸‰!', 'success');
            
            setTimeout(() => {
                showLogin();
            }, 2000);
        }

        async function login() {
            const email = document.getElementById('loginEmail').value.trim();
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.email === email && u.password === password);

            if (!user) {
                showToast('ì´ë©”ì¼ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤', 'error');
                return;
            }

            currentUser = user;
            await showApp();
        }

        function logout() {
            currentUser = null;
            document.getElementById('authContainer').style.display = 'flex';
            document.getElementById('appContainer').style.display = 'none';
        }

        async function showApp() {
            await initDB();
            uploadedFiles = await getFilesFromIndexedDB();
            
            // Blob URL ë¯¸ë¦¬ ìƒì„± (ë¹ ë¥¸ ì¬ìƒì„ ìœ„í•´!)
            prepareBlobURLs();
            
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            
            document.getElementById('headerUsername').textContent = currentUser.username;
            document.getElementById('headerAvatar').textContent = currentUser.username.charAt(0).toUpperCase();
            
            updateHeader();
            updateAllPages();
        }

        // í˜ì´ì§€ ì „í™˜
        function switchPage(pageName) {
            document.querySelectorAll('.nav-item').forEach(item => item.classList.remove('active'));
            document.querySelectorAll('.page').forEach(page => page.classList.remove('active'));
            
            event.target.closest('.nav-item').classList.add('active');
            document.getElementById('page' + pageName.charAt(0).toUpperCase() + pageName.slice(1)).classList.add('active');
            
            if (pageName === 'discover') updateDiscover();
            else if (pageName === 'library') updateLibrary();
            else if (pageName === 'mining') updateMining();
            else if (pageName === 'commercial') updateCommercial();
        }

        // í—¤ë” ì—…ë°ì´íŠ¸
        function updateHeader() {
            document.getElementById('headerTL').textContent = currentUser.tlBalance.toLocaleString();
            document.getElementById('headerWon').textContent = currentUser.tlBalance.toLocaleString();
            document.getElementById('headerTLC').textContent = (currentUser.tlcBalance || 0).toLocaleString();
        }

        // í† ìŠ¤íŠ¸
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const icon = document.getElementById('toastIcon');
            const msg = document.getElementById('toastMessage');
            
            toast.className = 'toast show ' + type;
            icon.textContent = type === 'success' ? 'âœ…' : 'âŒ';
            msg.textContent = message;
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }

        // ê´‘ê³  ì‹œì²­
        function watchAd() {
            document.getElementById('adModal').classList.add('show');
            
            let seconds = 30;
            const timer = setInterval(() => {
                seconds--;
                document.getElementById('adTimer').textContent = seconds;
                
                if (seconds <= 0) {
                    clearInterval(timer);
                    currentUser.tlBalance += 10;
                    saveUsers();
                    updateHeader();
                    document.getElementById('adModal').classList.remove('show');
                    showToast('âœ… 10 TL (â‚©10) ì§€ê¸‰ ì™„ë£Œ!', 'success');
                }
            }, 1000);
        }

        // TL êµ¬ë§¤
        function buyTL(amount) {
            currentUser.tlBalance += amount;
            saveUsers();
            updateHeader();
            showToast(`âœ… ${amount.toLocaleString()} TL (â‚©${amount.toLocaleString()}) êµ¬ë§¤ ì™„ë£Œ!`, 'success');
        }

        // ì‚¬ìš©ì ì €ì¥
        function saveUsers() {
            const userIndex = users.findIndex(u => u.id === currentUser.id);
            if (userIndex !== -1) {
                users[userIndex] = currentUser;
                localStorage.setItem('timelink_users_v3', JSON.stringify(users));
            }
        }

        // í˜ì´ì§€ ì—…ë°ì´íŠ¸
        function updateAllPages() {
            updateDiscover();
            updateLibrary();
            updateMining();
            updateCommercial();
        }

        function updateDiscover() {
            const container = document.getElementById('discoverContent');
            const allFiles = uploadedFiles.filter(f => f.isShared);
            
            if (allFiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸµ</div>
                        <div class="empty-title">ì•„ì§ ê³µìœ ëœ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-subtitle">ì²« ë²ˆì§¸ ìŒì•…ì„ ê³µìœ í•´ë³´ì„¸ìš”!</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = allFiles.map(file => createMusicCard(file)).join('');
        }

        function updateLibrary() {
            const container = document.getElementById('libraryContent');
            const myFiles = uploadedFiles.filter(f => f.creatorId === currentUser.id);
            
            if (myFiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“š</div>
                        <div class="empty-title">ë¼ì´ë¸ŒëŸ¬ë¦¬ê°€ ë¹„ì–´ìˆìŠµë‹ˆë‹¤</div>
                        <div class="empty-subtitle">ìŒì•…ì„ ì—…ë¡œë“œí•´ë³´ì„¸ìš”!</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = myFiles.map(file => createMusicCard(file, true)).join('');
        }

        function updateCommercial() {
            const container = document.getElementById('commercialContent');
            const sharedFiles = uploadedFiles.filter(f => f.isShared);
            
            if (sharedFiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-icon">ğŸ“»</div>
                        <div class="empty-title">ê³µìœ ëœ ìŒì•…ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-subtitle">ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ ìŒì•…ì„ ê³µìœ í•˜ì„¸ìš”</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = sharedFiles.map(file => createCommercialCard(file)).join('');
        }

        // ì±„êµ´ í˜ì´ì§€ ì—…ë°ì´íŠ¸
        function updateMining() {
            // TLC ì”ì•¡ í‘œì‹œ
            document.getElementById('tlcBalance').textContent = (currentUser.tlcBalance || 0).toLocaleString();
            
            // ì´ ì±„êµ´ëŸ‰
            document.getElementById('totalMined').textContent = (currentUser.tlcBalance || 0).toLocaleString() + ' TLC';
            
            // ê¸°ì—¬ë„ ì ìˆ˜
            document.getElementById('contributionScore').textContent = (currentUser.contributionScore || 0).toLocaleString();
            
            // 5:5 íŒŒì¼ ê°œìˆ˜
            const miningFiles = uploadedFiles.filter(f => f.creatorId === currentUser.id && f.revenueModel === '55');
            document.getElementById('miningFiles').textContent = miningFiles.length + 'ê°œ';
            
            // ì±„êµ´ë¥  ê³„ì‚° (ê¸°ì—¬ë„ ê¸°ë°˜)
            const score = currentUser.contributionScore || 0;
            let miningRate = 0.5; // ê¸°ë³¸ 0.5%
            if (score >= 10000) miningRate = 5.0;
            else if (score >= 5000) miningRate = 3.0;
            else if (score >= 1000) miningRate = 1.0;
            else if (score >= 100) miningRate = 0.5;
            document.getElementById('miningRate').textContent = miningRate.toFixed(1) + '%';
            
            // íŒŒì¼ ëª©ë¡
            const myFiles = uploadedFiles.filter(f => f.creatorId === currentUser.id && f.contentType === 'audio');
            const container = document.getElementById('miningFileList');
            
            if (myFiles.length === 0) {
                container.innerHTML = `
                    <div class="empty-state" style="padding: 40px;">
                        <div class="empty-icon">ğŸµ</div>
                        <div class="empty-title">ìŒì•… íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>
                        <div class="empty-subtitle">ë¨¼ì € ìŒì•…ì„ ì—…ë¡œë“œí•˜ì„¸ìš”</div>
                    </div>
                `;
                return;
            }
            
            container.innerHTML = myFiles.map(file => {
                const is55 = file.revenueModel === '55';
                const isShared = file.isShared;
                return `
                    <div style="display: flex; justify-content: space-between; align-items: center; padding: 20px; border: 2px solid ${is55 ? '#ffd700' : 'var(--border)'}; border-radius: 15px; margin-bottom: 15px; background: ${is55 ? '#fffef0' : 'white'};">
                        <div style="flex: 1;">
                            <div style="display: flex; align-items: center; gap: 10px; margin-bottom: 5px;">
                                <div style="font-weight: 600; font-size: 16px;">ğŸµ ${file.fileName}</div>
                                ${isShared ? '<div class="music-badge badge-shared" style="font-size: 11px; padding: 3px 8px;">ğŸ“» ê³µìœ ì¤‘</div>' : ''}
                            </div>
                            <div style="font-size: 13px; color: var(--text-light);">
                                ${is55 ? 'â›ï¸ 5:5 ì±„êµ´ ëª¨ë“œ - TL 50% + TLC ì±„êµ´' : 'ğŸ’µ 7:3 ê¸°ë³¸ ëª¨ë“œ - TL 70%'}
                            </div>
                            ${isShared ? `<div style="font-size: 12px; color: var(--success); margin-top: 5px;">âœ… ê³µìœ  ë“±ë¡ ì™„ë£Œ (ì–¸ì œë“  ìˆ˜ìµ ëª¨ë¸ ë³€ê²½ ê°€ëŠ¥)</div>` : '<div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">ğŸ’¡ ê³µìœ  ë“±ë¡ ì‹œ ìˆ˜ìµ ëª¨ë¸ ì„ íƒ</div>'}
                        </div>
                        <div style="display: flex; gap: 10px;">
                            <button 
                                class="btn-primary" 
                                style="padding: 10px 20px; font-size: 14px; ${is55 ? 'opacity: 0.5;' : ''}" 
                                onclick="${is55 ? '' : `setRevenueModel('${file.id}', '55')`}"
                                ${is55 ? 'disabled' : ''}>
                                ${is55 ? 'âœ… 5:5 ì ìš©ì¤‘' : 'â›ï¸ 5:5ë¡œ ë³€ê²½'}
                            </button>
                            <button 
                                class="btn-secondary" 
                                style="padding: 10px 20px; font-size: 14px; ${!is55 ? 'opacity: 0.5;' : ''}" 
                                onclick="${!is55 ? '' : `setRevenueModel('${file.id}', '73')`}"
                                ${!is55 ? 'disabled' : ''}>
                                ${!is55 ? 'âœ… 7:3 ì ìš©ì¤‘' : 'ğŸ’µ 7:3ë¡œ ë³€ê²½'}
                            </button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        // ìˆ˜ìµ ëª¨ë¸ ë³€ê²½
        async function setRevenueModel(fileId, model) {
            const file = uploadedFiles.find(f => f.id === fileId);
            if (!file) return;
            
            const modelName = model === '55' ? '5:5 (TLC ì±„êµ´)' : '7:3 (TL ì¦‰ì‹œ)';
            const description = model === '55' 
                ? 'í”Œë«í¼ì— 50% ê¸°ì—¬í•˜ê³  TLCë¥¼ ì±„êµ´í•©ë‹ˆë‹¤.\nì¥ê¸°ì ìœ¼ë¡œ ë” í° ê°€ì¹˜ë¥¼ ì–»ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.'
                : 'TLì˜ 70%ë¥¼ ì¦‰ì‹œ ë°›ìŠµë‹ˆë‹¤.\nì•ˆì •ì ì¸ ìˆ˜ìµì„ ì›í•  ë•Œ ì„ íƒí•˜ì„¸ìš”.';
            
            if (!confirm(`${file.fileName}ì„(ë¥¼) ${modelName} ëª¨ë“œë¡œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\n${description}`)) {
                return;
            }
            
            file.revenueModel = model;
            await updateFileInIndexedDB(file);
            
            showToast(`âœ… ${file.fileName}\n${modelName} ëª¨ë“œë¡œ ë³€ê²½ë˜ì—ˆìŠµë‹ˆë‹¤!`, 'success');
            updateMining();
            updateLibrary();
        }

        // ìŒì•… ì¹´ë“œ ìƒì„±
        function createMusicCard(file, showActions = false) {
            const icon = file.contentType === 'audio' ? 'ğŸµ' : file.contentType === 'video' ? 'ğŸ¬' : 'ğŸ–¼ï¸';
            const duration = file.duration > 0 ? `${Math.floor(file.duration / 60)}:${(file.duration % 60).toString().padStart(2, '0')}` : 'Image';
            
            // íŒŒì¼ í¬ê¸° í‘œì‹œ
            let sizeText = '';
            if (file.fileSize) {
                const mb = file.fileSize / 1024 / 1024;
                sizeText = mb >= 1 ? `${mb.toFixed(1)}MB` : `${(file.fileSize / 1024).toFixed(0)}KB`;
            }
            
            // ìˆ˜ìµ ëª¨ë¸ í‘œì‹œ (ë‚´ íŒŒì¼ë§Œ)
            let revenueModelBadge = '';
            if (showActions && file.contentType === 'audio') {
                const is55 = file.revenueModel === '55';
                revenueModelBadge = `
                    <div class="music-badge" style="background: ${is55 ? '#ffd700' : 'var(--primary)'}; color: ${is55 ? '#000' : '#fff'}; margin-top: 5px;">
                        ${is55 ? 'â›ï¸ 5:5 ì±„êµ´' : 'ğŸ’µ 7:3 ê¸°ë³¸'}
                    </div>
                `;
            }
            
            let actionButtons = '';
            if (showActions) {
                actionButtons = `
                    <div style="display: flex; gap: 8px; margin-top: 10px;">
                        <button class="btn-primary" style="flex: 1; padding: 8px; font-size: 12px;" onclick="openChargeModal('${file.id}')">ğŸ’° ì¶©ì „</button>
                        ${!file.isShared && file.contentType === 'audio' ? 
                            `<button class="btn-primary" style="flex: 1; padding: 8px; font-size: 12px; background: var(--warning);" onclick="shareFile('${file.id}')">ğŸ“» ê³µìœ </button>` : ''}
                    </div>
                `;
            }
            
            return `
                <div class="music-card">
                    <div class="music-cover" onclick="playFile('${file.id}')" style="cursor: pointer;">
                        ${icon}
                        <div class="play-overlay">
                            <div class="play-button">â–¶ï¸</div>
                        </div>
                    </div>
                    <div class="music-info">
                        <div class="music-title" onclick="playFile('${file.id}')" style="cursor: pointer;">${file.fileName}</div>
                        <div class="music-meta">
                            <span>â±ï¸ ${duration}</span>
                            <span>ğŸ’ ${Math.floor(file.remainingTL)} TL</span>
                        </div>
                        ${sizeText ? `<div style="font-size: 11px; color: var(--text-light); margin-top: 5px;">ğŸ“¦ ${sizeText}</div>` : ''}
                        ${file.isShared ? '<div class="music-badge badge-shared">ğŸ“» ê³µìœ ì¤‘</div>' : ''}
                        ${revenueModelBadge}
                        ${actionButtons}
                    </div>
                </div>
            `;
        }

        function createCommercialCard(file) {
            const duration = `${Math.floor(file.duration / 60)}:${(file.duration % 60).toString().padStart(2, '0')}`;
            const earnings = Math.floor(file.duration * COMMERCIAL_PLAY_WEIGHT);
            const breakEven = Math.ceil(SHARE_FEE / earnings);
            const progress = Math.min(100, ((file.commercialPlays || 0) / breakEven) * 100);
            
            // ìˆ˜ìµ ëª¨ë¸ì— ë”°ë¥¸ ìˆ˜ìµ ê³„ì‚°
            const is55 = file.revenueModel === '55';
            const creatorEarnings = is55 ? Math.floor(earnings * 0.5) : Math.floor(earnings * 0.7);
            const revenueModelText = is55 ? '5:5 (50% TL + TLC ì±„êµ´)' : '7:3 (70% TL)';
            const revenueModelColor = is55 ? '#ffd700' : 'var(--primary)';
            
            return `
                <div class="music-card">
                    <div class="music-cover" style="background: linear-gradient(135deg, #ff9800 0%, #ff5722 100%); cursor: pointer;" onclick="${isCommercialMode ? `playCommercial('${file.id}')` : ''}">
                        ğŸµ
                        ${isCommercialMode ? `
                            <div class="play-overlay">
                                <div class="play-button">â–¶ï¸</div>
                            </div>
                        ` : ''}
                    </div>
                    <div class="music-info">
                        <div class="music-title">${file.fileName}</div>
                        <div class="music-meta">
                            <span>â±ï¸ ${duration}</span>
                            <span>ğŸ’° ${creatorEarnings} TL/íšŒ</span>
                        </div>
                        <div class="music-badge" style="background: ${revenueModelColor}; color: ${is55 ? '#000' : '#fff'}; margin-top: 8px;">
                            ${is55 ? 'â›ï¸' : 'ğŸ’µ'} ${revenueModelText}
                        </div>
                        <div style="margin-top: 10px; font-size: 11px; color: var(--text-light);">
                            ì§„í–‰: ${file.commercialPlays || 0}/${breakEven}íšŒ (${progress.toFixed(0)}%)
                        </div>
                        <div style="background: var(--border); height: 6px; border-radius: 3px; margin-top: 5px; overflow: hidden;">
                            <div style="background: linear-gradient(90deg, var(--warning), var(--success)); height: 100%; width: ${progress}%; transition: width 0.3s;"></div>
                        </div>
                        <div style="margin-top: 8px; font-size: 12px; color: var(--success); font-weight: 600;">
                            ğŸ’° ëˆ„ì  ìˆ˜ìµ: ${Math.floor(file.totalEarnings || 0).toLocaleString()} TL
                        </div>
                    </div>
                </div>
            `;
        }

        // íŒŒì¼ ê³µìœ 
        let shareTargetFile = null;
        
        async function shareFile(fileId) {
            const file = uploadedFiles.find(f => f.id === fileId);
            if (!file) return;
            
            if (currentUser.tlBalance < SHARE_FEE) {
                showToast(`âš ï¸ TLì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ${SHARE_FEE.toLocaleString()} TL í•„ìš”`, 'error');
                return;
            }
            
            shareTargetFile = file;
            
            // ì˜ˆìƒ ìˆ˜ìµ ê³„ì‚° (3ë¶„ ê³¡ ê¸°ì¤€)
            const duration = file.duration || 180;
            const totalEarnings = Math.floor(duration * COMMERCIAL_PLAY_WEIGHT);
            const earnings73 = Math.floor(totalEarnings * 0.7);
            const earnings55 = Math.floor(totalEarnings * 0.5);
            
            // ê¸°ì—¬ë„ ê¸°ë°˜ ì±„êµ´ë¥ 
            const score = currentUser.contributionScore || 0;
            let miningRate = 0.005;
            if (score >= 10000) miningRate = 0.05;
            else if (score >= 5000) miningRate = 0.03;
            else if (score >= 1000) miningRate = 0.01;
            else if (score >= 100) miningRate = 0.005;
            
            const tlcMined = Math.floor(earnings55 * miningRate * 100) / 100;
            
            const modal = document.getElementById('shareModal');
            const content = document.getElementById('shareModalContent');
            
            content.innerHTML = `
                <div style="padding: 20px 0;">
                    <div style="text-align: center; margin-bottom: 30px;">
                        <div style="font-size: 60px; margin-bottom: 15px;">ğŸµ</div>
                        <h3 style="margin-bottom: 10px;">${file.fileName}</h3>
                        <p style="color: var(--text-light); font-size: 14px;">ìƒì—… ë°©ì†¡êµ­ì— ê³µìœ í•˜ê³  ìˆ˜ìµì„ ì°½ì¶œí•˜ì„¸ìš”</p>
                    </div>
                    
                    <div style="background: var(--light); padding: 20px; border-radius: 15px; margin-bottom: 30px;">
                        <div style="font-weight: 600; margin-bottom: 10px; text-align: center;">ğŸ“Š ë“±ë¡ ì •ë³´</div>
                        <div style="display: flex; justify-content: space-around; font-size: 14px;">
                            <div style="text-align: center;">
                                <div style="color: var(--text-light); margin-bottom: 5px;">ë“±ë¡ë¹„</div>
                                <div style="font-weight: 700; font-size: 18px;">${SHARE_FEE.toLocaleString()} TL</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--text-light); margin-bottom: 5px;">ì¬ìƒë‹¹ ìˆ˜ìµ</div>
                                <div style="font-weight: 700; font-size: 18px;">${totalEarnings} TL</div>
                            </div>
                            <div style="text-align: center;">
                                <div style="color: var(--text-light); margin-bottom: 5px;">ì†ìµë¶„ê¸°</div>
                                <div style="font-weight: 700; font-size: 18px;">${Math.ceil(SHARE_FEE / totalEarnings)}íšŒ</div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="margin-bottom: 20px;">
                        <h4 style="margin-bottom: 15px; text-align: center;">ğŸ’° ìˆ˜ìµ ë°©ì‹ ì„ íƒ</h4>
                        
                        <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px;">
                            <!-- 7:3 ë°©ì‹ -->
                            <div id="revenueOption73" onclick="selectRevenueModel('73')" style="border: 3px solid var(--border); border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">ğŸ’µ</div>
                                    <div style="font-size: 18px; font-weight: 700; color: var(--primary);">7:3 ë°©ì‹</div>
                                    <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">ì•ˆì •ì  ìˆ˜ìµ</div>
                                </div>
                                <div style="background: var(--light); padding: 12px; border-radius: 10px; margin-bottom: 10px;">
                                    <div style="font-size: 13px; margin-bottom: 5px;">ì¬ìƒë‹¹ ìˆ˜ë ¹</div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${earnings73} TL</div>
                                    <div style="font-size: 11px; color: var(--text-light); margin-top: 3px;">ì´ ìˆ˜ìµì˜ 70%</div>
                                </div>
                                <div style="font-size: 12px; color: var(--text);">
                                    âœ… TLë¡œ ì¦‰ì‹œ ìˆ˜ë ¹<br>
                                    âœ… ì•ˆì •ì  ìˆ˜ìµ<br>
                                    âœ… ì˜ˆì¸¡ ê°€ëŠ¥
                                </div>
                            </div>
                            
                            <!-- 5:5 ë°©ì‹ -->
                            <div id="revenueOption55" onclick="selectRevenueModel('55')" style="border: 3px solid var(--border); border-radius: 15px; padding: 20px; cursor: pointer; transition: all 0.3s;">
                                <div style="text-align: center; margin-bottom: 15px;">
                                    <div style="font-size: 32px; margin-bottom: 8px;">â›ï¸</div>
                                    <div style="font-size: 18px; font-weight: 700; color: #ffd700;">5:5 ë°©ì‹</div>
                                    <div style="font-size: 12px; color: var(--text-light); margin-top: 5px;">TLC ì±„êµ´</div>
                                </div>
                                <div style="background: #fff9e6; padding: 12px; border-radius: 10px; margin-bottom: 10px;">
                                    <div style="font-size: 13px; margin-bottom: 5px;">ì¬ìƒë‹¹ ìˆ˜ë ¹</div>
                                    <div style="font-size: 20px; font-weight: 700; color: var(--primary);">${earnings55} TL</div>
                                    <div style="font-size: 11px; color: var(--text-light); margin-top: 3px;">ì´ ìˆ˜ìµì˜ 50%</div>
                                    <div style="font-size: 13px; margin-top: 8px; color: #ffd700; font-weight: 600;">+ ${tlcMined} TLC ì±„êµ´</div>
                                </div>
                                <div style="font-size: 12px; color: var(--text);">
                                    âœ… TL + TLC ì´ì¤‘ ìˆ˜ìµ<br>
                                    âœ… ì¥ê¸° ê°€ì¹˜ ì¦ëŒ€<br>
                                    âœ… í”Œë«í¼ ì„±ì¥ ì°¸ì—¬
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div style="display: flex; gap: 10px; margin-top: 30px;">
                        <button class="btn-secondary" onclick="closeShareModal()" style="flex: 1;">ì·¨ì†Œ</button>
                        <button class="btn-primary" onclick="executeShare()" style="flex: 1;" id="shareConfirmBtn" disabled>
                            ìˆ˜ìµ ë°©ì‹ì„ ì„ íƒí•˜ì„¸ìš”
                        </button>
                    </div>
                </div>
            `;
            
            modal.classList.add('show');
        }
        
        let selectedRevenueModel = null;
        
        function selectRevenueModel(model) {
            selectedRevenueModel = model;
            
            // ëª¨ë“  ì˜µì…˜ ì´ˆê¸°í™”
            document.getElementById('revenueOption73').style.border = '3px solid var(--border)';
            document.getElementById('revenueOption73').style.background = 'white';
            document.getElementById('revenueOption55').style.border = '3px solid var(--border)';
            document.getElementById('revenueOption55').style.background = 'white';
            
            // ì„ íƒëœ ì˜µì…˜ ê°•ì¡°
            if (model === '73') {
                document.getElementById('revenueOption73').style.border = '3px solid var(--primary)';
                document.getElementById('revenueOption73').style.background = 'rgba(102, 126, 234, 0.05)';
            } else {
                document.getElementById('revenueOption55').style.border = '3px solid #ffd700';
                document.getElementById('revenueOption55').style.background = '#fffef0';
            }
            
            // í™•ì¸ ë²„íŠ¼ í™œì„±í™”
            const btn = document.getElementById('shareConfirmBtn');
            btn.disabled = false;
            btn.textContent = model === '73' ? 'ğŸ’µ 7:3 ë°©ì‹ìœ¼ë¡œ ê³µìœ í•˜ê¸°' : 'â›ï¸ 5:5 ë°©ì‹ìœ¼ë¡œ ê³µìœ í•˜ê¸°';
        }
        
        async function executeShare() {
            if (!selectedRevenueModel || !shareTargetFile) return;
            
            const modelName = selectedRevenueModel === '55' ? '5:5 (TLC ì±„êµ´)' : '7:3 (ì•ˆì • ìˆ˜ìµ)';
            
            currentUser.tlBalance -= SHARE_FEE;
            shareTargetFile.isShared = true;
            shareTargetFile.sharedAt = Date.now();
            shareTargetFile.commercialPlays = 0;
            shareTargetFile.totalEarnings = 0;
            shareTargetFile.revenueModel = selectedRevenueModel;
            
            await updateFileInIndexedDB(shareTargetFile);
            saveUsers();
            
            closeShareModal();
            
            showToast(
                `âœ… ê³µìœ  ë“±ë¡ ì™„ë£Œ!\n` +
                `ğŸ’° ë“±ë¡ë¹„ ${SHARE_FEE.toLocaleString()} TL ì°¨ê°\n` +
                `${selectedRevenueModel === '55' ? 'â›ï¸' : 'ğŸ’µ'} ${modelName} ì ìš©`,
                'success'
            );
            
            updateHeader();
            updateAllPages();
        }
        
        function closeShareModal() {
            document.getElementById('shareModal').classList.remove('show');
            selectedRevenueModel = null;
            shareTargetFile = null;
        }

        // TL ì¶©ì „ ëª¨ë‹¬
        let chargeTargetFile = null;

        function openChargeModal(fileId) {
            const file = uploadedFiles.find(f => f.id === fileId);
            if (!file) return;
            
            chargeTargetFile = file;
            const modal = document.getElementById('chargeModal');
            const content = document.getElementById('chargeModalContent');
            
            content.innerHTML = `
                <div style="text-align: center; padding: 20px 0;">
                    <div style="font-size: 60px; margin-bottom: 15px;">${file.contentType === 'audio' ? 'ğŸµ' : file.contentType === 'video' ? 'ğŸ¬' : 'ğŸ–¼ï¸'}</div>
                    <h3 style="margin-bottom: 10px;">${file.fileName}</h3>
                    <p style="color: var(--text-light); font-size: 14px;">í˜„ì¬ TL: ${Math.floor(file.remainingTL).toLocaleString()} TL</p>
                </div>
                
                <div class="input-group">
                    <label>ì¶©ì „í•  TL</label>
                    <input type="number" id="chargeAmount" placeholder="1000" min="1" value="1000">
                    <p style="color: var(--text-light); font-size: 14px; margin-top: 8px;">
                        1 TL = 1ì´ˆ = â‚©1<br>
                        í˜„ì¬ ì”ì•¡: ${currentUser.tlBalance.toLocaleString()} TL
                    </p>
                </div>
                
                <div style="display: flex; gap: 10px; margin-top: 20px;">
                    <button class="btn-secondary" onclick="closeChargeModal()" style="flex: 1;">ì·¨ì†Œ</button>
                    <button class="btn-primary" onclick="executeCharge()" style="flex: 1;">ì¶©ì „</button>
                </div>
            `;
            
            modal.classList.add('show');
        }

        function closeChargeModal() {
            document.getElementById('chargeModal').classList.remove('show');
            chargeTargetFile = null;
        }

        async function executeCharge() {
            const amount = parseInt(document.getElementById('chargeAmount').value) || 0;
            
            if (amount <= 0) {
                showToast('ì¶©ì „í•  TLì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            if (amount > currentUser.tlBalance) {
                showToast('TLì´ ë¶€ì¡±í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            // TL ì°¨ê°
            currentUser.tlBalance -= amount;
            
            // íŒŒì¼ì— TL ì¶©ì „
            chargeTargetFile.remainingTL += amount;
            chargeTargetFile.totalTL += amount;
            
            // ê¸°ì—¬ë„ ì ìˆ˜ ì¶”ê°€
            const contributionPoints = Math.floor(amount / 1000) * 10;
            if (contributionPoints > 0) {
                currentUser.contributionScore = (currentUser.contributionScore || 0) + contributionPoints;
            }
            
            await updateFileInIndexedDB(chargeTargetFile);
            saveUsers();
            
            closeChargeModal();
            showToast(`âœ… ${amount.toLocaleString()} TL ì¶©ì „ ì™„ë£Œ!${contributionPoints > 0 ? `\nğŸ¯ ê¸°ì—¬ë„ +${contributionPoints}ì !` : ''}`, 'success');
            updateHeader();
            updateAllPages();
        }

        // ìƒì—… ëª¨ë“œ í† ê¸€
        function toggleCommercialMode() {
            isCommercialMode = document.getElementById('commercialToggle').checked;
            showToast(isCommercialMode ? 'ğŸ“» ìƒì—… ëª¨ë“œ í™œì„±í™”' : 'ìƒì—… ëª¨ë“œ ë¹„í™œì„±í™”', 'success');
            updateCommercial();
        }

        // IndexedDB (ê°„ë‹¨ ë²„ì „)
        let db;
        
        async function initDB() {
            return new Promise((resolve, reject) => {
                const request = indexedDB.open('TimeLink', 1);
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    resolve(db);
                };
                request.onupgradeneeded = (event) => {
                    db = event.target.result;
                    if (!db.objectStoreNames.contains('files')) {
                        db.createObjectStore('files', { keyPath: 'id' });
                    }
                };
            });
        }

        async function getFilesFromIndexedDB() {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['files'], 'readonly');
                const store = transaction.objectStore('files');
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }

        // Blob URL ìºì‹œ ìƒì„± (ë¯¸ë¦¬ ì¤€ë¹„!)
        function prepareBlobURLs() {
            console.log('ğŸš€ Blob URL ìºì‹œ ìƒì„± ì¤‘...');
            
            uploadedFiles.forEach(file => {
                if (file.fileBlob && !fileBlobCache[file.id]) {
                    fileBlobCache[file.id] = URL.createObjectURL(file.fileBlob);
                    console.log(`âœ… ${file.fileName} ì¤€ë¹„ ì™„ë£Œ`);
                }
            });
            
            console.log(`âœ… ì´ ${Object.keys(fileBlobCache).length}ê°œ íŒŒì¼ ì¤€ë¹„ ì™„ë£Œ!`);
        }

        // ìºì‹œ ì •ë¦¬
        function clearBlobCache() {
            Object.values(fileBlobCache).forEach(url => {
                URL.revokeObjectURL(url);
            });
            fileBlobCache = {};
        }

        async function updateFileInIndexedDB(file) {
            return new Promise((resolve, reject) => {
                const transaction = db.transaction(['files'], 'readwrite');
                const store = transaction.objectStore('files');
                const request = store.put(file);
                request.onsuccess = () => resolve();
                request.onerror = () => reject(request.error);
            });
        }

        // íŒŒì¼ ì—…ë¡œë“œ ì²˜ë¦¬ (ê¸°ë³¸)
        let pendingFile = null;
        let pendingFileData = null;

        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            console.log('ğŸ“ íŒŒì¼ ì„ íƒë¨:', file.name, 'í¬ê¸°:', (file.size / 1024 / 1024).toFixed(2), 'MB');
            
            // íŒŒì¼ í¬ê¸° ì²´í¬ (50MB ì œí•œ)
            if (file.size > 50 * 1024 * 1024) {
                showToast('âš ï¸ íŒŒì¼ì´ ë„ˆë¬´ í½ë‹ˆë‹¤ (ìµœëŒ€ 50MB)', 'error');
                return;
            }
            
            pendingFile = file;
            
            // Blob URL ìƒì„± (ë¹ ë¦„!)
            pendingFileData = URL.createObjectURL(file);
            
            showUploadForm();
        }

        function showUploadForm() {
            const form = document.getElementById('uploadForm');
            form.style.display = 'block';
            form.innerHTML = `
                <div class="input-group">
                    <label>íŒŒì¼ ì´ë¦„</label>
                    <input type="text" id="uploadFileName" placeholder="ë©‹ì§„ ìŒì•…" value="${pendingFile.name.replace(/\.[^/.]+$/, '')}">
                </div>
                <p style="color: var(--text-light); font-size: 14px; margin-top: 8px;">
                    ğŸ’¡ ì—…ë¡œë“œ í›„ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ TLì„ ì¶©ì „í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤
                </p>
                <button class="btn-primary" onclick="uploadFile()">ì—…ë¡œë“œ</button>
            `;
        }

        async function uploadFile() {
            const fileName = document.getElementById('uploadFileName').value.trim();
            
            if (!fileName) {
                showToast('íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            showToast('ğŸ“¤ ì—…ë¡œë“œ ì¤‘...', 'success');
            
            const mimeType = pendingFile.type;
            let contentType;
            if (mimeType.startsWith('audio/')) contentType = 'audio';
            else if (mimeType.startsWith('video/')) contentType = 'video';
            else if (mimeType.startsWith('image/')) contentType = 'image';
            else {
                showToast('ì§€ì›í•˜ì§€ ì•ŠëŠ” íŒŒì¼ í˜•ì‹ì…ë‹ˆë‹¤', 'error');
                return;
            }
            
            // Blob ì €ì¥ (ë¹ ë¦„!)
            const fileObj = {
                id: Date.now().toString(),
                fileName,
                contentType,
                mimeType,
                fileBlob: pendingFile,  // ì›ë³¸ Blob ì €ì¥
                fileSize: pendingFile.size,
                duration: contentType === 'image' ? 0 : 180,
                remainingTL: 0,  // ì´ˆê¸° TLì€ 0
                totalTL: 0,      // ì´ˆê¸° TLì€ 0
                revenueModel: '73',
                creatorId: currentUser.id,
                uploadedAt: Date.now(),
                isShared: false,
                commercialPlays: 0,
                totalEarnings: 0
            };
            
            await updateFileInIndexedDB(fileObj);
            uploadedFiles.push(fileObj);
            
            // Blob URL ìºì‹œì— ì¶”ê°€ (ë¹ ë¥¸ ì¬ìƒì„ ìœ„í•´!)
            fileBlobCache[fileObj.id] = URL.createObjectURL(pendingFile);
            console.log(`âœ… ${fileName} ìºì‹œ ì¶”ê°€ ì™„ë£Œ`);
            
            // TL ì°¨ê° ì—†ìŒ
            currentUser.contributionScore = (currentUser.contributionScore || 0) + 100;
            currentUser.uploadedFiles++;
            saveUsers();
            
            document.getElementById('uploadForm').style.display = 'none';
            document.getElementById('fileInput').value = '';
            
            // ì„ì‹œ Blob URL í•´ì œ (ìºì‹œì— ìˆìœ¼ë‹ˆê¹Œ)
            URL.revokeObjectURL(pendingFileData);
            pendingFile = null;
            pendingFileData = null;
            
            showToast(`âœ… "${fileName}" ì—…ë¡œë“œ ì™„ë£Œ!\nğŸ¯ ê¸°ì—¬ë„ +100ì !\nğŸ’¡ ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ TL ì¶©ì „í•˜ì„¸ìš”`, 'success');
            updateHeader();
            updateAllPages();
            switchPage('library');
        }

        // ê°„ë‹¨í•œ ì¬ìƒ (ëª¨ë‹¬ì€ ìƒëµ, í† ìŠ¤íŠ¸ë§Œ)
        // ì¬ìƒ ì‹œìŠ¤í…œ
        let currentPlayingFile = null;
        let playbackInterval = null;
        let currentMediaElement = null;
        let currentBlobURL = null;

        function playFile(fileId) {
            console.log('ğŸµ playFile í˜¸ì¶œë¨:', fileId);
            
            const file = uploadedFiles.find(f => f.id === fileId);
            if (!file) {
                console.error('âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', fileId);
                return;
            }
            
            console.log('ğŸ“ íŒŒì¼ ì •ë³´:', file);
            console.log('ğŸ’ TL:', file.remainingTL, 'íƒ€ì…:', file.contentType);
            
            if (file.remainingTL <= 0 && file.contentType !== 'image') {
                showToast('âš ï¸ TLì´ ë¶€ì¡±í•©ë‹ˆë‹¤. ì¶©ì „í•˜ì„¸ìš”', 'error');
                return;
            }
            
            currentPlayingFile = file;
            
            // í”Œë ˆì´ì–´ ëª¨ë‹¬ ì—´ê¸°
            document.getElementById('playerTitle').textContent = file.fileName;
            document.getElementById('playerTL').textContent = Math.floor(file.remainingTL).toLocaleString();
            
            const display = document.getElementById('playerDisplay');
            display.innerHTML = '<div style="padding: 40px; text-align: center;">â³ ë¡œë”© ì¤‘...</div>';
            
            console.log('ğŸ¬ ë¯¸ë””ì–´ ìƒì„± ì‹œì‘...');
            
            // ìºì‹œëœ Blob URL ì‚¬ìš© (ì¦‰ì‹œ ì¬ìƒ!)
            if (fileBlobCache[file.id]) {
                currentBlobURL = fileBlobCache[file.id];
                console.log('âœ… ìºì‹œëœ URL ì‚¬ìš© - ì¦‰ì‹œ ì¬ìƒ!');
            } else if (file.fileBlob) {
                currentBlobURL = URL.createObjectURL(file.fileBlob);
                fileBlobCache[file.id] = currentBlobURL;  // ìºì‹œì— ì €ì¥
                console.log('âš¡ URL ìƒì„± ë° ìºì‹œ ì €ì¥');
            } else if (file.fileData) {
                // êµ¬ ë°©ì‹ í˜¸í™˜ì„±
                currentBlobURL = file.fileData;
            } else {
                showToast('íŒŒì¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            try {
                if (file.contentType === 'audio') {
                    console.log('ğŸµ ì˜¤ë””ì˜¤ ì¬ìƒ');
                    const audio = new Audio();
                    audio.src = currentBlobURL;
                    audio.controls = true;
                    audio.style.width = '100%';
                    audio.style.borderRadius = '15px';
                    audio.preload = 'auto';
                    
                    currentMediaElement = audio;
                    
                    audio.addEventListener('loadedmetadata', () => {
                        console.log('âœ… ì˜¤ë””ì˜¤ ë¡œë“œ ì™„ë£Œ, duration:', audio.duration);
                        document.getElementById('playerDuration').textContent = formatTime(audio.duration);
                        file.duration = Math.floor(audio.duration);
                        display.innerHTML = '';
                        display.appendChild(audio);
                    });
                    
                    audio.addEventListener('timeupdate', () => {
                        document.getElementById('playerTime').textContent = formatTime(audio.currentTime);
                        handlePlayback(audio.currentTime);
                    });
                    
                    audio.addEventListener('ended', () => {
                        console.log('âœ… ì˜¤ë””ì˜¤ ì¬ìƒ ì™„ë£Œ');
                        stopPlayback();
                    });
                    
                    audio.addEventListener('error', (e) => {
                        console.error('âŒ ì˜¤ë””ì˜¤ ì—ëŸ¬:', e);
                        showToast('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨', 'error');
                    });
                    
                    audio.play().then(() => {
                        console.log('â–¶ï¸ ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘!');
                    }).catch(err => {
                        console.log('âš ï¸ ìë™ ì¬ìƒ ë°©ì§€ë¨, ìˆ˜ë™ìœ¼ë¡œ ì¬ìƒí•˜ì„¸ìš”');
                    });
                    
                } else if (file.contentType === 'video') {
                    console.log('ğŸ¬ ë¹„ë””ì˜¤ ì¬ìƒ');
                    const video = document.createElement('video');
                    video.src = currentBlobURL;
                    video.controls = true;
                    video.style.width = '100%';
                    video.style.maxHeight = '400px';
                    video.style.borderRadius = '15px';
                    video.preload = 'auto';
                    
                    currentMediaElement = video;
                    
                    video.addEventListener('loadstart', () => {
                        console.log('â³ ë¹„ë””ì˜¤ ë¡œë”© ì‹œì‘...');
                    });
                    
                    video.addEventListener('loadedmetadata', () => {
                        console.log('âœ… ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ, duration:', video.duration);
                        document.getElementById('playerDuration').textContent = formatTime(video.duration);
                        file.duration = Math.floor(video.duration);
                    });
                    
                    video.addEventListener('canplay', () => {
                        console.log('âœ… ë¹„ë””ì˜¤ ì¬ìƒ ê°€ëŠ¥!');
                        display.innerHTML = '';
                        display.appendChild(video);
                    });
                    
                    video.addEventListener('timeupdate', () => {
                        document.getElementById('playerTime').textContent = formatTime(video.currentTime);
                        handlePlayback(video.currentTime);
                    });
                    
                    video.addEventListener('ended', () => {
                        console.log('âœ… ë¹„ë””ì˜¤ ì¬ìƒ ì™„ë£Œ');
                        stopPlayback();
                    });
                    
                    video.addEventListener('error', (e) => {
                        console.error('âŒ ë¹„ë””ì˜¤ ì—ëŸ¬:', e, video.error);
                        display.innerHTML = '<div style="color: red; padding: 20px;">ë¹„ë””ì˜¤ ë¡œë“œ ì‹¤íŒ¨</div>';
                        showToast('ë¹„ë””ì˜¤ ì¬ìƒ ì‹¤íŒ¨', 'error');
                    });
                    
                    video.play().then(() => {
                        console.log('â–¶ï¸ ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘!');
                    }).catch(err => {
                        console.log('âš ï¸ ìë™ ì¬ìƒ ë°©ì§€ë¨:', err);
                    });
                    
                } else if (file.contentType === 'image') {
                    console.log('ğŸ–¼ï¸ ì´ë¯¸ì§€ í‘œì‹œ');
                    const img = document.createElement('img');
                    img.src = currentBlobURL;
                    img.style.maxWidth = '100%';
                    img.style.maxHeight = '400px';
                    img.style.borderRadius = '15px';
                    
                    img.onload = () => {
                        display.innerHTML = '';
                        display.appendChild(img);
                    };
                    
                    document.getElementById('playerTime').textContent = 'ì´ë¯¸ì§€';
                    document.getElementById('playerDuration').textContent = 'ë¬´ì œí•œ';
                }
                
                document.getElementById('playerModal').classList.add('show');
                console.log('âœ… í”Œë ˆì´ì–´ ëª¨ë‹¬ í‘œì‹œë¨');
                
            } catch (error) {
                console.error('âŒ ë¯¸ë””ì–´ ìƒì„± ì—ëŸ¬:', error);
                showToast('ë¯¸ë””ì–´ ë¡œë“œ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: ' + error.message, 'error');
            }
        }

        let lastPlaybackSecond = 0;

        function handlePlayback(currentTime) {
            if (!currentPlayingFile) return;
            if (currentPlayingFile.contentType === 'image') return;
            
            const currentSecond = Math.floor(currentTime);
            
            // 1ì´ˆë§ˆë‹¤ TL ì°¨ê°
            if (currentSecond > lastPlaybackSecond) {
                const secondsPlayed = currentSecond - lastPlaybackSecond;
                
                for (let i = 0; i < secondsPlayed; i++) {
                    if (currentPlayingFile.remainingTL > 0) {
                        currentPlayingFile.remainingTL -= 1;
                        
                        // ì¬ìƒ ì‹œê°„ìœ¼ë¡œ ê¸°ì—¬ë„ ì¶”ê°€ (1ë¶„ë§ˆë‹¤ +1ì )
                        if ((currentSecond + i) % 60 === 0) {
                            currentUser.contributionScore = (currentUser.contributionScore || 0) + 1;
                        }
                    } else {
                        // TL ì†Œì§„ ì‹œ ì¬ìƒ ì¤‘ì§€
                        if (currentMediaElement) {
                            currentMediaElement.pause();
                        }
                        showToast('âš ï¸ TLì´ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤', 'error');
                        stopPlayback();
                        return;
                    }
                }
                
                lastPlaybackSecond = currentSecond;
                document.getElementById('playerTL').textContent = Math.floor(currentPlayingFile.remainingTL).toLocaleString();
            }
        }

        async function stopPlayback() {
            if (currentPlayingFile) {
                await updateFileInIndexedDB(currentPlayingFile);
                saveUsers();
                updateAllPages();
            }
            
            lastPlaybackSecond = 0;
            currentPlayingFile = null;
            currentMediaElement = null;
        }

        function closePlayer() {
            if (currentMediaElement) {
                if (currentMediaElement.pause) {
                    currentMediaElement.pause();
                }
                currentMediaElement = null;
            }
            
            // currentBlobURLë§Œ null (ìºì‹œëŠ” ìœ ì§€!)
            currentBlobURL = null;
            
            stopPlayback();
            document.getElementById('playerModal').classList.remove('show');
        }

        function formatTime(seconds) {
            const mins = Math.floor(seconds / 60);
            const secs = Math.floor(seconds % 60);
            return `${mins}:${secs.toString().padStart(2, '0')}`;
        }

        async function playCommercial(fileId) {
            if (!isCommercialMode) {
                showToast('âš ï¸ ìƒì—… ëª¨ë“œë¥¼ ë¨¼ì € í™œì„±í™”í•˜ì„¸ìš”', 'error');
                return;
            }
            
            const file = uploadedFiles.find(f => f.id === fileId);
            if (!file) return;
            
            // ìƒì—… ì¬ìƒì€ ì¼ë°˜ ì¬ìƒê³¼ ë™ì¼í•˜ì§€ë§Œ TL ì°¨ê° ì—†ìŒ
            currentPlayingFile = file;
            
            document.getElementById('playerTitle').textContent = `ğŸ“» ${file.fileName} (ìƒì—… ì¬ìƒ)`;
            document.getElementById('playerTL').textContent = 'ìƒì—… ëª¨ë“œ';
            
            const display = document.getElementById('playerDisplay');
            display.innerHTML = '<div style="padding: 40px; text-align: center;">â³ ë¡œë”© ì¤‘...</div>';
            
            // ìºì‹œëœ Blob URL ì‚¬ìš© (ì¦‰ì‹œ ì¬ìƒ!)
            if (fileBlobCache[file.id]) {
                currentBlobURL = fileBlobCache[file.id];
                console.log('âœ… ìºì‹œëœ URL ì‚¬ìš© - ì¦‰ì‹œ ì¬ìƒ!');
            } else if (file.fileBlob) {
                currentBlobURL = URL.createObjectURL(file.fileBlob);
                fileBlobCache[file.id] = currentBlobURL;
            } else if (file.fileData) {
                currentBlobURL = file.fileData;
            }
            
            try {
                const audio = new Audio();
                audio.src = currentBlobURL;
                audio.controls = true;
                audio.style.width = '100%';
                audio.style.borderRadius = '15px';
                audio.preload = 'auto';
                
                currentMediaElement = audio;
                
                audio.addEventListener('loadedmetadata', () => {
                    document.getElementById('playerDuration').textContent = formatTime(audio.duration);
                    display.innerHTML = '';
                    display.appendChild(audio);
                });
                
                audio.addEventListener('timeupdate', () => {
                    document.getElementById('playerTime').textContent = formatTime(audio.currentTime);
                });
                
                audio.addEventListener('ended', async () => {
                    // ì¬ìƒ ì™„ë£Œ ì‹œ ìˆ˜ìµ ì§€ê¸‰
                    const totalEarnings = Math.floor(file.duration * COMMERCIAL_PLAY_WEIGHT);
                    
                    // ì°½ì‘ìì—ê²Œ ìˆ˜ìµ ì§€ê¸‰
                    if (file.creatorId === currentUser.id) {
                        let creatorEarnings = 0;
                        let platformEarnings = 0;
                        let tlcMined = 0;
                        
                        if (file.revenueModel === '55') {
                            // 5:5 ë°©ì‹ - ì°½ì‘ì 50% TL, í”Œë«í¼ 50% TLC ì±„êµ´
                            creatorEarnings = Math.floor(totalEarnings * 0.5);
                            platformEarnings = Math.floor(totalEarnings * 0.5);
                            
                            // ê¸°ì—¬ë„ ê¸°ë°˜ ì±„êµ´ë¥  ê³„ì‚°
                            const score = currentUser.contributionScore || 0;
                            let miningRate = 0.005; // ê¸°ë³¸ 0.5%
                            if (score >= 10000) miningRate = 0.05;
                            else if (score >= 5000) miningRate = 0.03;
                            else if (score >= 1000) miningRate = 0.01;
                            else if (score >= 100) miningRate = 0.005;
                            
                            // TLC ì±„êµ´ (í”Œë«í¼ ìˆ˜ìµì˜ ì±„êµ´ë¥ ë§Œí¼)
                            tlcMined = Math.floor(platformEarnings * miningRate);
                            currentUser.tlcBalance = (currentUser.tlcBalance || 0) + tlcMined;
                            
                            currentUser.tlBalance += creatorEarnings;
                            
                            showToast(
                                `âœ… ìƒì—… ì¬ìƒ ì™„ë£Œ! (5:5 ëª¨ë“œ)\n` +
                                `ğŸ’° ì°½ì‘ì ìˆ˜ìµ: ${creatorEarnings} TL (50%)\n` +
                                `â›ï¸ TLC ì±„êµ´: ${tlcMined} TLC\n` +
                                `ğŸ“Š í”Œë«í¼ ê¸°ì—¬: ${platformEarnings} TL (50%)`,
                                'success'
                            );
                        } else {
                            // 7:3 ë°©ì‹ - ì°½ì‘ì 70% TL, í”Œë«í¼ 30% TL
                            creatorEarnings = Math.floor(totalEarnings * 0.7);
                            platformEarnings = Math.floor(totalEarnings * 0.3);
                            
                            currentUser.tlBalance += creatorEarnings;
                            
                            showToast(
                                `âœ… ìƒì—… ì¬ìƒ ì™„ë£Œ! (7:3 ëª¨ë“œ)\n` +
                                `ğŸ’° ì°½ì‘ì ìˆ˜ìµ: ${creatorEarnings} TL (70%)\n` +
                                `ğŸ“Š í”Œë«í¼ ìˆ˜ìµ: ${platformEarnings} TL (30%)`,
                                'success'
                            );
                        }
                        
                        file.totalEarnings = (file.totalEarnings || 0) + creatorEarnings;
                        saveUsers();
                    }
                    
                    file.commercialPlays = (file.commercialPlays || 0) + 1;
                    
                    await updateFileInIndexedDB(file);
                    
                    showToast(`âœ… ìƒì—… ì¬ìƒ ì™„ë£Œ!\nğŸ’° ì°½ì‘ì ìˆ˜ìµ: ${earnings} TL`, 'success');
                    updateHeader();
                    updateCommercial();
                    
                    closePlayer();
                });
                
                audio.play().catch(err => console.log('Auto-play prevented'));
                
                document.getElementById('playerModal').classList.add('show');
                
            } catch (error) {
                console.error('Media error:', error);
                showToast('ì¬ìƒ ì¤‘ ì˜¤ë¥˜ ë°œìƒ', 'error');
            }
        }

        // ì´ˆê¸°í™”
        window.addEventListener('load', () => {
            // ìë™ ë¡œê·¸ì¸ í…ŒìŠ¤íŠ¸ìš©
            if (users.length > 0) {
                document.getElementById('loginEmail').value = users[0].email;
                document.getElementById('loginPassword').value = users[0].password;
            }
        });
    </script>
</body>
</html>
