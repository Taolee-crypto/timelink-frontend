<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeLink - ì°½ì‘ìë¥¼ ìœ„í•œ ì¦‰ì‹œ ì •ì‚° í”Œë«í¼</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        /* ë¡œê·¸ì¸/ê°€ì… */
        .auth-container {
            display: flex;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            padding: 20px;
        }
        
        .auth-box {
            background: white;
            padding: 40px;
            border-radius: 20px;
            box-shadow: 0 20px 60px rgba(0,0,0,0.3);
            max-width: 400px;
            width: 100%;
        }
        
        .auth-box h1 {
            text-align: center;
            margin-bottom: 10px;
            color: #667eea;
            font-size: 2rem;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #333;
            font-weight: 600;
        }
        
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
        }
        
        .btn {
            width: 100%;
            padding: 14px;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .btn-secondary {
            background: white;
            color: #667eea;
            border: 2px solid #667eea;
            margin-top: 10px;
        }
        
        /* ë©”ì¸ ì•± */
        .app-container {
            display: none;
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }
        
        .app-header {
            background: white;
            padding: 20px 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .balance {
            text-align: right;
        }
        
        .balance-value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #667eea;
        }
        
        .btn-logout {
            padding: 8px 16px;
            background: #ef4444;
            color: white;
            border: none;
            border-radius: 6px;
            cursor: pointer;
        }
        
        /* íƒ­ */
        .tabs {
            display: flex;
            gap: 10px;
            background: white;
            padding: 10px;
            border-radius: 15px;
            margin-bottom: 20px;
        }
        
        .tab {
            flex: 1;
            padding: 12px;
            background: transparent;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-weight: 600;
            color: #666;
        }
        
        .tab.active {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        
        .tab-content {
            display: none;
        }
        
        .tab-content.active {
            display: block;
        }
        
        /* ì¹´ë“œ */
        .card {
            background: white;
            padding: 30px;
            border-radius: 15px;
            margin-bottom: 20px;
            box-shadow: 0 4px 6px rgba(0,0,0,0.1);
        }
        
        .card-title {
            font-size: 1.3rem;
            font-weight: bold;
            margin-bottom: 20px;
        }
        
        /* íŒŒì¼ ì—…ë¡œë“œ */
        .upload-box {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            padding: 40px 20px;
            border-radius: 20px;
            text-align: center;
            margin-bottom: 20px;
        }
        
        .upload-box input[type="file"] {
            width: 100%;
            padding: 15px;
            font-size: 18px;
            border: 2px solid white;
            border-radius: 10px;
            background: white;
            cursor: pointer;
        }
        
        /* íŒŒì¼ ë¦¬ìŠ¤íŠ¸ */
        .file-list {
            display: grid;
            gap: 15px;
        }
        
        .file-item {
            background: #f8f9ff;
            padding: 20px;
            border-radius: 12px;
            border-left: 4px solid #667eea;
        }
        
        .file-title {
            font-weight: bold;
            font-size: 1.1rem;
            margin-bottom: 10px;
        }
        
        .file-meta {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 10px;
        }
        
        .file-actions {
            display: flex;
            gap: 10px;
            margin-top: 10px;
        }
        
        .btn-sm {
            padding: 8px 16px;
            border: none;
            border-radius: 6px;
            font-weight: 600;
            cursor: pointer;
        }
        
        .btn-play {
            background: #10b981;
            color: white;
        }
        
        .btn-recharge {
            background: #f59e0b;
            color: white;
        }
        
        /* í”Œë ˆì´ì–´ ëª¨ë‹¬ */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal.active {
            display: flex;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 20px;
            max-width: 800px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .player-media {
            width: 100%;
            max-height: 400px;
            border-radius: 10px;
            margin: 20px 0;
        }
        
        .player-controls {
            display: flex;
            gap: 10px;
            margin-top: 20px;
        }
        
        .tl-display {
            font-size: 2rem;
            font-weight: bold;
            color: #667eea;
            text-align: center;
            margin: 20px 0;
        }
        
        /* ì•Œë¦¼ */
        .toast {
            position: fixed;
            bottom: 30px;
            right: 30px;
            background: white;
            padding: 20px 30px;
            border-radius: 12px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.3);
            display: none;
            z-index: 2000;
        }
        
        .toast.active {
            display: block;
        }
        
        .toast.success {
            border-left: 4px solid #10b981;
        }
        
        .hidden {
            display: none !important;
        }
        
        /* AI ë¶„ì„ */
        .ai-analysis {
            background: #f0f9ff;
            padding: 20px;
            border-radius: 10px;
            margin-top: 20px;
            border: 2px solid #0ea5e9;
        }
        
        .ai-badge {
            display: inline-block;
            padding: 4px 12px;
            background: #0ea5e9;
            color: white;
            border-radius: 20px;
            font-size: 0.85rem;
            margin-right: 5px;
        }
    </style>
</head>
<body>

    <!-- ë¡œê·¸ì¸/ê°€ì… -->
    <div id="authContainer" class="auth-container">
        <div class="auth-box">
            <h1>â±ï¸ TimeLink</h1>
            <p style="text-align: center; color: #667eea; font-weight: 600; margin-bottom: 10px;">
                timelink.digital
            </p>
            <p style="text-align: center; color: #666; margin-bottom: 30px; font-size: 0.95rem;">
                ì°½ì‘ìë¥¼ ìœ„í•œ ì¦‰ì‹œ ì •ì‚° í”Œë«í¼<br>
                <span style="font-size: 0.85rem;">ì†Œë¹„í•˜ê³  ë³´ìƒë°›ëŠ” ìƒˆë¡œìš´ ê²½ì œ</span>
            </p>
            
            <div id="loginForm">
                <div class="form-group">
                    <label>ì‚¬ìš©ì ì´ë¦„</label>
                    <input type="text" id="loginUsername" placeholder="username">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <button class="btn btn-primary" onclick="login()">ë¡œê·¸ì¸</button>
                <button class="btn btn-secondary" onclick="showSignup()">íšŒì›ê°€ì…</button>
            </div>
            
            <div id="signupForm" class="hidden">
                <div class="form-group">
                    <label>ì‚¬ìš©ì ì´ë¦„</label>
                    <input type="text" id="signupUsername" placeholder="username">
                </div>
                <div class="form-group">
                    <label>ì´ë©”ì¼</label>
                    <input type="email" id="signupEmail" placeholder="you@example.com">
                </div>
                <div class="form-group">
                    <label>ë¹„ë°€ë²ˆí˜¸</label>
                    <input type="password" id="signupPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢">
                </div>
                <div class="form-group">
                    <label>ë‚˜ì˜ ê¸°ì—¬ ë¶„ì•¼ (AI ë¶„ì„ì— ì‚¬ìš©)</label>
                    <textarea id="signupContribution" rows="3" placeholder="ì˜ˆ: ìŒì•… ì‘ê³¡, ì˜ìƒ í¸ì§‘, ë””ìì¸ ë“±..."></textarea>
                </div>
                <div class="form-group">
                    <label>ì‚¬ìš©í•˜ëŠ” AI ë„êµ¬</label>
                    <input type="text" id="signupAITools" placeholder="ì˜ˆ: Suno AI, ChatGPT, Midjourney">
                </div>
                <button class="btn btn-primary" onclick="signup()">ê°€ì…í•˜ê¸° (10,000 TL ì§€ê¸‰)</button>
                <button class="btn btn-secondary" onclick="showLogin()">ë¡œê·¸ì¸ìœ¼ë¡œ</button>
            </div>
        </div>
    </div>

    <!-- ë©”ì¸ ì•± -->
    <div id="appContainer" class="app-container">
        <div class="app-header">
            <div>
                <h1 style="margin: 0;">â±ï¸ TimeLink</h1>
                <p style="font-size: 0.75rem; color: #667eea; margin-top: 2px;">ì¦‰ì‹œ ì •ì‚° í”Œë«í¼</p>
            </div>
            <div style="display: flex; align-items: center; gap: 20px;">
                <div style="background: #f8f9ff; padding: 15px 20px; border-radius: 12px; border: 2px solid #667eea;">
                    <div style="font-size: 0.75rem; color: #667eea; font-weight: 600; margin-bottom: 8px; text-align: center;">ğŸ’¼ í†µí•© ì§€ê°‘</div>
                    <div style="display: flex; gap: 20px;">
                        <div class="balance">
                            <div style="font-size: 0.7rem; color: #666;">TL</div>
                            <div class="balance-value" id="tlBalance" style="font-size: 1.1rem;">0</div>
                        </div>
                        <div class="balance">
                            <div style="font-size: 0.7rem; color: #666;">TLC</div>
                            <div class="balance-value" id="tlcBalance" style="font-size: 1.1rem;">0.00</div>
                        </div>
                    </div>
                </div>
                <button class="btn-logout" onclick="logout()">ë¡œê·¸ì•„ì›ƒ</button>
            </div>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab('dashboard')">ğŸ“Š ëŒ€ì‹œë³´ë“œ</button>
            <button class="tab" onclick="switchTab('upload')">ğŸ“¤ ì—…ë¡œë“œ</button>
            <button class="tab" onclick="switchTab('browse')">ğŸµ íƒìƒ‰</button>
            <button class="tab" onclick="switchTab('mining')">â›ï¸ ì±„êµ´</button>
        </div>

        <!-- ëŒ€ì‹œë³´ë“œ -->
        <div id="tabDashboard" class="tab-content active">
            <div class="card">
                <div class="card-title">ë‚´ í”„ë¡œí•„</div>
                <div id="userProfile"></div>
            </div>
            
            <div class="card">
                <div class="card-title">ë‚´ íŒŒì¼</div>
                <div id="myFilesList" class="file-list"></div>
            </div>
            
            <div class="card">
                <div class="card-title">ğŸ“Š ìµœê·¼ í–‰ë™ ë‚´ì—­ (ê¸°ì—¬ë„ ë¶„ì„ìš©)</div>
                <div id="recentActions" style="font-size: 0.9rem;"></div>
            </div>
        </div>

        <!-- ì—…ë¡œë“œ -->
        <div id="tabUpload" class="tab-content">
            <div class="card">
                <div class="card-title">íŒŒì¼ ì—…ë¡œë“œ ë° TL3/TL4 ë³€í™˜</div>
                
                <div class="upload-box">
                    <div style="font-size: 3rem; color: white; margin-bottom: 15px;">ğŸ“</div>
                    <div style="color: white; font-size: 1.3rem; font-weight: bold; margin-bottom: 20px;">
                        íŒŒì¼ ì„ íƒ (ìŒì•…, ì˜ìƒ, ì´ë¯¸ì§€)
                    </div>
                    <input type="file" id="fileInput" accept="audio/*,video/*,image/*" onchange="handleFileSelect(event)">
                    <div style="color: white; font-size: 0.9rem; margin-top: 15px; opacity: 0.9;">
                        ì¬ìƒ ì‹œê°„ì´ ìë™ìœ¼ë¡œ ê°ì§€ë©ë‹ˆë‹¤
                    </div>
                    <div style="background: rgba(255,255,255,0.2); padding: 12px; border-radius: 8px; margin-top: 15px; font-size: 0.85rem; color: white;">
                        ğŸ’¾ <strong>IndexedDB ì‚¬ìš© - ìš©ëŸ‰ ì œí•œ ì—†ìŒ!</strong><br>
                        100MB+ íŒŒì¼ë„ ì—…ë¡œë“œ ê°€ëŠ¥
                    </div>
                </div>

                <div id="uploadForm" class="hidden">
                    <div class="form-group">
                        <label>íŒŒì¼ ì´ë¦„</label>
                        <input type="text" id="fileName">
                    </div>
                    
                    <div class="form-group">
                        <label>ì½˜í…ì¸  íƒ€ì…</label>
                        <select id="contentType">
                            <option value="audio">ğŸµ ìŒì•… (Audio) â†’ TL3</option>
                            <option value="video">ğŸ¬ ì˜ìƒ (Video) â†’ TL4</option>
                            <option value="image">ğŸ–¼ï¸ ì´ë¯¸ì§€ (Image) â†’ TL4</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label>ì¬ìƒ ì‹œê°„ (ìë™ ê°ì§€ë¨)</label>
                        <input type="text" id="fileDuration" readonly style="background: #f0f0f0;">
                    </div>
                    
                    <div class="form-group">
                        <label>ì´ˆê¸° ì¶©ì „ TL (1ì´ˆ = 1 TL)</label>
                        <input type="number" id="initialCharge" value="1000" min="1">
                    </div>
                    
                    <div class="form-group">
                        <label>AI ë„êµ¬ ì‚¬ìš©</label>
                        <div style="display: grid; grid-template-columns: repeat(2, 1fr); gap: 10px;">
                            <label><input type="checkbox" class="aiTool" value="Suno AI"> Suno AI</label>
                            <label><input type="checkbox" class="aiTool" value="ChatGPT"> ChatGPT</label>
                            <label><input type="checkbox" class="aiTool" value="Runway"> Runway</label>
                            <label><input type="checkbox" class="aiTool" value="Midjourney"> Midjourney</label>
                        </div>
                    </div>
                    
                    <div class="form-group">
                        <label>ì¸ê°„ ê¸°ì—¬ë„: <span id="humanContribValue">50</span>%</label>
                        <input type="range" id="humanContrib" min="0" max="100" value="50" 
                            oninput="document.getElementById('humanContribValue').textContent = this.value">
                    </div>
                    
                    <button type="button" class="btn btn-primary" onclick="uploadFile()">ğŸš€ TL íŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ì—…ë¡œë“œ</button>
                </div>
            </div>
        </div>

        <!-- íƒìƒ‰ -->
        <div id="tabBrowse" class="tab-content">
            <div class="card">
                <div class="card-title">ëª¨ë“  íŒŒì¼</div>
                <div id="allFilesList" class="file-list"></div>
            </div>
        </div>

        <!-- ì±„êµ´ -->
        <div id="tabMining" class="tab-content">
            <div class="card">
                <div class="card-title">TL â†’ TLC ì±„êµ´</div>
                <div class="form-group">
                    <label>ë³€í™˜í•  TL ì–‘</label>
                    <input type="number" id="miningAmount" min="1" placeholder="1000">
                </div>
                <button class="btn btn-primary" onclick="executeMining()">â›ï¸ ì±„êµ´ ì‹¤í–‰</button>
            </div>
        </div>
    </div>

    <!-- í”Œë ˆì´ì–´ ëª¨ë‹¬ -->
    <div id="playerModal" class="modal">
        <div class="modal-content">
            <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                <h2 id="playerTitle" style="margin: 0;"></h2>
                <button onclick="closePlayer()" style="background: #ef4444; color: white; border: none; padding: 8px 16px; border-radius: 6px; cursor: pointer;">ë‹«ê¸°</button>
            </div>
            
            <div class="tl-display">
                ë‚¨ì€ TL: <span id="playerTL">0</span>
            </div>
            
            <audio id="audioPlayer" class="player-media hidden" controls></audio>
            <video id="videoPlayer" class="player-media hidden" controls></video>
            <img id="imagePlayer" class="player-media hidden" alt="ì´ë¯¸ì§€">
            
            <div style="text-align: center; margin-top: 20px; color: #666;">
                <div id="playerStatus">ì¬ìƒ ì¤‘... (1ì´ˆë‹¹ 1 TL ì°¨ê°)</div>
            </div>
        </div>
    </div>

    <!-- ì•Œë¦¼ -->
    <div id="toast" class="toast"></div>

    <script>
        // ===== ì„¤ì • =====
        const ALLOW_SELF_PLAY = true; // trueë¡œ ì„¤ì •í•˜ë©´ ìê¸° íŒŒì¼ë„ ì¬ìƒ ê°€ëŠ¥ (í…ŒìŠ¤íŠ¸ìš©)
        
        // ===== ì‚¬ìš©ì í–‰ë™ ê¸°ë¡ (ê¸°ì—¬ë„ ë¶„ì„ìš©) =====
        async function recordAction(actionType, details) {
            if (!currentUser) return;
            
            // currentUser ë™ê¸°í™”
            const user = users.find(u => u.id === currentUser.id);
            if (!user) return;
            
            // actions ë°°ì—´ ì´ˆê¸°í™”
            if (!user.actions) {
                user.actions = [];
            }
            
            // í–‰ë™ ê¸°ë¡
            const action = {
                type: actionType, // 'upload', 'charge', 'play', 'mine'
                details: details,
                timestamp: Date.now()
            };
            
            user.actions.push(action);
            
            // ìµœê·¼ 100ê°œë§Œ ìœ ì§€
            if (user.actions.length > 100) {
                user.actions = user.actions.slice(-100);
            }
            
            currentUser = user;
            await saveUsers();
            
            console.log('ğŸ“Š í–‰ë™ ê¸°ë¡:', actionType, details);
        }
        
        // ===== IndexedDB ì´ˆê¸°í™” =====
        const DB_NAME = 'PoCNetworkDB';
        const DB_VERSION = 1;
        let db = null;
        
        async function initDB() {
            return new Promise((resolve, reject) => {
                console.log('IndexedDB ì´ˆê¸°í™”...');
                const request = indexedDB.open(DB_NAME, DB_VERSION);
                
                request.onerror = () => reject(request.error);
                request.onsuccess = () => {
                    db = request.result;
                    console.log('âœ… IndexedDB ì—°ê²° ì„±ê³µ!');
                    resolve(db);
                };
                
                request.onupgradeneeded = (event) => {
                    const db = event.target.result;
                    if (!db.objectStoreNames.contains('users')) {
                        db.createObjectStore('users', { keyPath: 'id' });
                    }
                    if (!db.objectStoreNames.contains('files')) {
                        db.createObjectStore('files', { keyPath: 'id' });
                    }
                };
            });
        }
        
        async function dbGetAll(storeName) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], 'readonly');
                const store = tx.objectStore(storeName);
                const request = store.getAll();
                request.onsuccess = () => resolve(request.result || []);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function dbPut(storeName, data) {
            return new Promise((resolve, reject) => {
                const tx = db.transaction([storeName], 'readwrite');
                const store = tx.objectStore(storeName);
                const request = store.put(data);
                request.onsuccess = () => resolve(request.result);
                request.onerror = () => reject(request.error);
            });
        }
        
        async function dbPutAll(storeName, dataArray) {
            const tx = db.transaction([storeName], 'readwrite');
            const store = tx.objectStore(storeName);
            for (const item of dataArray) {
                store.put(item);
            }
            return new Promise((resolve, reject) => {
                tx.oncomplete = () => resolve();
                tx.onerror = () => reject(tx.error);
            });
        }
        
        // ===== ì „ì—­ ë³€ìˆ˜ =====
        let currentUser = null;
        let users = [];
        let files = [];
        
        let currentFile = null;
        let currentMediaElement = null;
        let tlDeductionInterval = null;
        let selectedFileData = null;
        
        // localStorageì—ì„œ ë°ì´í„° ë¡œë“œ â†’ IndexedDBë¡œ ë³€ê²½
        async function loadData() {
            try {
                users = await dbGetAll('users');
                files = await dbGetAll('files');
                console.log('ë°ì´í„° ë¡œë“œ:', users.length, 'ëª…,', files.length, 'ê°œ íŒŒì¼');
            } catch (error) {
                console.error('ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨:', error);
                users = [];
                files = [];
            }
        }

        // ===== ì´ˆê¸°í™” =====
        window.onload = async function() {
            try {
                // IndexedDB ì´ˆê¸°í™”
                await initDB();
                
                // ë°ì´í„° ë¡œë“œ
                await loadData();
                
                // ìë™ ë¡œê·¸ì¸ ì²´í¬ (localStorage ì‚¬ìš©)
                const savedUsername = localStorage.getItem('currentUser');
                if (savedUsername) {
                    currentUser = users.find(u => u.username === savedUsername);
                    if (currentUser) {
                        showApp();
                    }
                }
                
                console.log('ì•± ì´ˆê¸°í™” ì™„ë£Œ!');
            } catch (error) {
                console.error('ì´ˆê¸°í™” ì‹¤íŒ¨:', error);
                alert('ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì‹¤íŒ¨!\n\n' + error.message);
            }
        };

        // ===== ì¸ì¦ =====
        function showSignup() {
            document.getElementById('loginForm').classList.add('hidden');
            document.getElementById('signupForm').classList.remove('hidden');
        }

        function showLogin() {
            document.getElementById('signupForm').classList.add('hidden');
            document.getElementById('loginForm').classList.remove('hidden');
        }

        async function signup() {
            const username = document.getElementById('signupUsername').value.trim();
            const email = document.getElementById('signupEmail').value.trim();
            const password = document.getElementById('signupPassword').value;
            const contribution = document.getElementById('signupContribution').value.trim();
            const aiTools = document.getElementById('signupAITools').value.trim();

            if (!username || !email || !password) {
                showToast('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }

            if (users.find(u => u.username === username)) {
                showToast('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì‚¬ìš©ìì…ë‹ˆë‹¤', 'error');
                return;
            }

            // AI ë¶„ì„ (ì‹œë®¬ë ˆì´ì…˜)
            const aiAnalysis = analyzeUserContribution(contribution, aiTools);

            const user = {
                id: 'user_' + Date.now(),
                username: username,
                email: email,
                password: password,
                createdAt: Date.now(),
                
                tlBalance: 10000, // í™˜ì˜ ë³´ë„ˆìŠ¤
                tlcBalance: 0,
                
                // AI ë¶„ì„ ê²°ê³¼
                contributionField: contribution,
                aiToolsUsed: aiTools,
                aiAnalysis: aiAnalysis,
                
                totalFilesUploaded: 0,
                totalEarnings: 0
            };

            users.push(user);
            await saveUsers();
            
            showToast('âœ… ê°€ì… ì„±ê³µ! í™˜ì˜ ë³´ë„ˆìŠ¤ 10,000 TL ì§€ê¸‰!', 'success');
            showLogin();
        }

        function analyzeUserContribution(contribution, aiTools) {
            // AI ë¶„ì„ ì‹œë®¬ë ˆì´ì…˜
            const analysis = {
                expertise: contribution ? 'ì¤‘ê¸‰' : 'ì´ˆê¸‰',
                aiDependency: aiTools ? 'ë†’ìŒ' : 'ë‚®ìŒ',
                creativityScore: Math.floor(Math.random() * 30) + 70, // 70-100
                technicalScore: Math.floor(Math.random() * 30) + 70,
                recommendedContent: contribution.includes('ìŒì•…') ? 'ìŒì•…' : 
                                   contribution.includes('ì˜ìƒ') ? 'ì˜ìƒ' : 'ì´ë¯¸ì§€'
            };
            return analysis;
        }

        function login() {
            const username = document.getElementById('loginUsername').value.trim();
            const password = document.getElementById('loginPassword').value;

            const user = users.find(u => u.username === username && u.password === password);
            
            if (!user) {
                showToast('ì‚¬ìš©ì ì´ë¦„ ë˜ëŠ” ë¹„ë°€ë²ˆí˜¸ê°€ ì˜ëª»ë˜ì—ˆìŠµë‹ˆë‹¤', 'error');
                return;
            }

            currentUser = user;
            localStorage.setItem('currentUser', username);
            showApp();
            showToast('ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
        }

        function logout() {
            localStorage.removeItem('currentUser');
            location.reload();
        }

        function showApp() {
            document.getElementById('authContainer').style.display = 'none';
            document.getElementById('appContainer').style.display = 'block';
            updateDashboard();
        }

        // ===== íƒ­ =====
        async function switchTab(tab) {
            document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById('tab' + tab.charAt(0).toUpperCase() + tab.slice(1)).classList.add('active');
            
            // ë°ì´í„° ì¬ë¡œë“œ
            await loadData();
            
            if (tab === 'dashboard') updateDashboard();
            if (tab === 'browse') {
                console.log('íƒìƒ‰ íƒ­ ì „í™˜, íŒŒì¼ ìˆ˜:', files.length);
                updateBrowse();
            }
        }

        // ===== ëŒ€ì‹œë³´ë“œ =====
        function updateDashboard() {
            // currentUserë¥¼ users ë°°ì—´ì—ì„œ ë‹¤ì‹œ ì°¾ì•„ì„œ ë™ê¸°í™”
            if (currentUser && currentUser.id) {
                const syncedUser = users.find(u => u.id === currentUser.id);
                if (syncedUser) {
                    currentUser = syncedUser;
                }
            }
            
            if (!currentUser) {
                console.error('currentUserê°€ ì—†ìŠµë‹ˆë‹¤!');
                return;
            }
            
            document.getElementById('tlBalance').textContent = (currentUser.tlBalance || 0).toLocaleString();
            document.getElementById('tlcBalance').textContent = (currentUser.tlcBalance || 0).toFixed(4);
            
            // í”„ë¡œí•„
            const profile = `
                <div class="ai-analysis">
                    <h3 style="margin-bottom: 15px;">ğŸ¤– AI ê¸°ì—¬ë„ ë¶„ì„</h3>
                    ${currentUser.aiAnalysis ? `
                        <div style="margin-bottom: 10px;">
                            <span class="ai-badge">ì „ë¬¸ì„±: ${currentUser.aiAnalysis.expertise}</span>
                            <span class="ai-badge">AI ì˜ì¡´ë„: ${currentUser.aiAnalysis.aiDependency}</span>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <span class="ai-badge">ì°½ì˜ì„±: ${currentUser.aiAnalysis.creativityScore}ì </span>
                            <span class="ai-badge">ê¸°ìˆ ë ¥: ${currentUser.aiAnalysis.technicalScore}ì </span>
                        </div>
                        <div style="margin-top: 15px; padding: 10px; background: white; border-radius: 8px;">
                            <strong>ì¶”ì²œ ì½˜í…ì¸ :</strong> ${currentUser.aiAnalysis.recommendedContent}
                        </div>
                    ` : '<p>AI ë¶„ì„ ì •ë³´ê°€ ì—†ìŠµë‹ˆë‹¤.</p>'}
                </div>
                <div style="margin-top: 20px;">
                    <p><strong>ê¸°ì—¬ ë¶„ì•¼:</strong> ${currentUser.contributionField || 'ë¯¸ì„¤ì •'}</p>
                    <p><strong>ì‚¬ìš© AI ë„êµ¬:</strong> ${currentUser.aiToolsUsed || 'ì—†ìŒ'}</p>
                    <p><strong>ì´ ìˆ˜ìµ:</strong> ${(currentUser.totalEarnings || 0).toLocaleString()} TL</p>
                </div>
            `;
            document.getElementById('userProfile').innerHTML = profile;
            
            // ë‚´ íŒŒì¼
            const myFiles = files.filter(f => f.creatorId === currentUser.id);
            const myFilesList = document.getElementById('myFilesList');
            
            if (myFiles.length === 0) {
                myFilesList.innerHTML = '<p style="text-align: center; color: #666; padding: 40px;">ì•„ì§ ì—…ë¡œë“œí•œ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                myFilesList.innerHTML = myFiles.map(file => {
                    // ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                    const canPlay = file.remainingTL >= file.duration;
                    const playableCount = Math.floor(file.remainingTL / file.duration);
                    
                    return `
                    <div class="file-item" style="border-left: 4px solid ${canPlay ? '#10b981' : '#ef4444'};">
                        <div class="file-title">${getFileIcon(file.contentType)} ${file.fileName}</div>
                        <div class="file-meta">
                            ${file.fileType} â€¢ ${file.duration}ì´ˆ â€¢ 
                            ì¶©ì „ TL: <strong style="color: ${canPlay ? '#10b981' : '#ef4444'};">${Math.floor(file.remainingTL)}</strong> / ${file.totalTL}
                            ${canPlay ? '<span style="color: #10b981;">âœ… ì¬ìƒ ê°€ëŠ¥</span>' : '<span style="color: #ef4444;">âš ï¸ ì¶©ì „ í•„ìš”</span>'}
                        </div>
                        <div class="file-actions">
                            <button class="btn-sm btn-recharge" onclick="rechargeFile('${file.id}')" style="background: #f59e0b; color: white; font-weight: bold;">
                                âš¡ ì¬ì¶©ì „ (ë‚¨ì€: ${Math.floor(file.remainingTL)} TL)
                            </button>
                            ${canPlay ? `
                                <button class="btn-sm btn-play" onclick="playFile('${file.id}')" style="background: #10b981; color: white; font-weight: bold;">
                                    â–¶ ì¬ìƒ (${playableCount}íšŒ)
                                </button>
                            ` : `
                                <button class="btn-sm" style="background: #999; color: white;" disabled>
                                    ì¶©ì „ í•„ìš” (${file.duration} TL)
                                </button>
                            `}
                        </div>
                    </div>
                `;
                }).join('');
            }
            
            // ìµœê·¼ í–‰ë™ ë‚´ì—­
            const recentActions = document.getElementById('recentActions');
            if (!currentUser.actions || currentUser.actions.length === 0) {
                recentActions.innerHTML = '<p style="text-align: center; color: #666; padding: 20px;">ì•„ì§ í–‰ë™ ë‚´ì—­ì´ ì—†ìŠµë‹ˆë‹¤</p>';
            } else {
                // ìµœê·¼ 10ê°œë§Œ í‘œì‹œ (ì—­ìˆœ)
                const actions = currentUser.actions.slice(-10).reverse();
                recentActions.innerHTML = actions.map(action => {
                    const time = new Date(action.timestamp).toLocaleString('ko-KR');
                    let actionText = '';
                    
                    if (action.type === 'upload') {
                        actionText = `ğŸ“¤ íŒŒì¼ ì—…ë¡œë“œ: ${action.details.fileName} (${action.details.initialCharge} TL ì¶©ì „)`;
                    } else if (action.type === 'charge') {
                        actionText = `âš¡ íŒŒì¼ ì¶©ì „: ${action.details.fileName} (${action.details.tlAmount} TL)`;
                    } else if (action.type === 'play') {
                        actionText = `â–¶ íŒŒì¼ ì¬ìƒ: ${action.details.fileName} (${action.details.duration}ì´ˆ)`;
                    } else if (action.type === 'mine') {
                        actionText = `â›ï¸ TLC ì±„êµ´: ${action.details.tlAmount} TL â†’ ${action.details.tlcMined.toFixed(4)} TLC`;
                    }
                    
                    return `
                        <div style="padding: 10px; margin-bottom: 8px; background: #f8f9ff; border-radius: 6px; border-left: 3px solid #667eea;">
                            <div style="font-weight: 600; margin-bottom: 4px;">${actionText}</div>
                            <div style="font-size: 0.8rem; color: #666;">${time}</div>
                        </div>
                    `;
                }).join('');
            }
        }

        // ===== íŒŒì¼ ì—…ë¡œë“œ =====
        function handleFileSelect(event) {
            const file = event.target.files[0];
            if (!file) return;
            
            selectedFileData = file;
            selectedFileData.duration = 0; // ì´ˆê¸°í™”
            
            document.getElementById('fileName').value = file.name.split('.')[0];
            
            // ì½˜í…ì¸  íƒ€ì… ìë™ ê°ì§€
            if (file.type.startsWith('audio/')) {
                document.getElementById('contentType').value = 'audio';
                document.getElementById('fileDuration').value = 'ê°ì§€ ì¤‘...';
                extractAudioDuration(file);
            } else if (file.type.startsWith('video/')) {
                document.getElementById('contentType').value = 'video';
                document.getElementById('fileDuration').value = 'ê°ì§€ ì¤‘...';
                extractVideoDuration(file);
            } else if (file.type.startsWith('image/')) {
                document.getElementById('contentType').value = 'image';
                document.getElementById('fileDuration').value = 'ë¬´í•œëŒ€ (ë³´ëŠ” ì‹œê°„ë§Œí¼ ì°¨ê°)';
                selectedFileData.duration = 999999; // ì´ë¯¸ì§€ëŠ” ë¬´í•œ
            }
            
            document.getElementById('uploadForm').classList.remove('hidden');
            showToast('âœ… íŒŒì¼ ì„ íƒ ì™„ë£Œ: ' + file.name, 'success');
        }

        function extractAudioDuration(file) {
            const audio = new Audio();
            audio.src = URL.createObjectURL(file);
            audio.addEventListener('loadedmetadata', function() {
                const duration = Math.ceil(audio.duration);
                document.getElementById('fileDuration').value = duration + 'ì´ˆ';
                selectedFileData.duration = duration;
                console.log('ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œê°„:', duration, 'ì´ˆ');
                URL.revokeObjectURL(audio.src);
            });
            audio.addEventListener('error', function() {
                console.error('ì˜¤ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                document.getElementById('fileDuration').value = '180ì´ˆ (ê¸°ë³¸ê°’)';
                selectedFileData.duration = 180;
            });
        }

        function extractVideoDuration(file) {
            const video = document.createElement('video');
            video.src = URL.createObjectURL(file);
            video.addEventListener('loadedmetadata', function() {
                const duration = Math.ceil(video.duration);
                document.getElementById('fileDuration').value = duration + 'ì´ˆ';
                selectedFileData.duration = duration;
                console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì‹œê°„:', duration, 'ì´ˆ');
                URL.revokeObjectURL(video.src);
            });
            video.addEventListener('error', function() {
                console.error('ë¹„ë””ì˜¤ ë©”íƒ€ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨');
                document.getElementById('fileDuration').value = '300ì´ˆ (ê¸°ë³¸ê°’)';
                selectedFileData.duration = 300;
            });
        }

        function uploadFile() {
            console.log('=== ì—…ë¡œë“œ ì‹œì‘ ===');
            
            const fileName = document.getElementById('fileName').value.trim();
            const contentType = document.getElementById('contentType').value;
            const initialCharge = parseInt(document.getElementById('initialCharge').value);
            const humanContrib = parseInt(document.getElementById('humanContrib').value);
            
            console.log('ì…ë ¥ê°’:', {fileName, contentType, initialCharge, humanContrib});
            
            const aiTools = [];
            document.querySelectorAll('.aiTool:checked').forEach(cb => {
                aiTools.push(cb.value);
            });
            
            if (!fileName) {
                alert('íŒŒì¼ ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”!');
                return;
            }
            
            if (!selectedFileData) {
                alert('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”!');
                return;
            }
            
            // íŒŒì¼ í¬ê¸° í‘œì‹œ (ì œí•œ ì—†ìŒ!)
            const fileSizeMB = (selectedFileData.size / (1024 * 1024)).toFixed(2);
            console.log('íŒŒì¼ í¬ê¸°:', fileSizeMB, 'MB (ì œí•œ ì—†ìŒ!)');
            
            // ì´ˆê¸° ì¶©ì „ TL í™•ì¸
            if (initialCharge > 0) {
                // currentUser ë™ê¸°í™”
                const userToCharge = users.find(u => u.id === currentUser.id);
                if (!userToCharge) {
                    alert('ì‚¬ìš©ì ì •ë³´ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤!');
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'ğŸš€ TL íŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ì—…ë¡œë“œ';
                    return;
                }
                
                if (initialCharge > userToCharge.tlBalance) {
                    alert(`TL ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤!\ní•„ìš”: ${initialCharge} TL\në³´ìœ : ${userToCharge.tlBalance} TL`);
                    uploadBtn.disabled = false;
                    uploadBtn.textContent = 'ğŸš€ TL íŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ì—…ë¡œë“œ';
                    return;
                }
                
                // ì´ˆê¸° ì¶©ì „ TLì„ ì°½ì‘ì ì”ì•¡ì—ì„œ ì°¨ê°!
                userToCharge.tlBalance -= initialCharge;
                currentUser = userToCharge;
                
                console.log(`ì´ˆê¸° ì¶©ì „ ${initialCharge} TLì„ ì°½ì‘ì ì”ì•¡ì—ì„œ ì°¨ê°`);
                console.log(`ì°½ì‘ì ì”ì•¡: ${userToCharge.tlBalance} TL`);
            }
            
            // duration í™•ì¸
            let duration = selectedFileData.duration || 0;
            if (contentType === 'image') {
                duration = 999999;
            } else if (duration === 0) {
                duration = contentType === 'audio' ? 180 : 300;
            }
            
            console.log('ìµœì¢… duration:', duration);
            
            // ë²„íŠ¼ ë¹„í™œì„±í™”
            const uploadBtn = event.target;
            uploadBtn.disabled = true;
            uploadBtn.textContent = 'â³ ì—…ë¡œë“œ ì¤‘...';
            
            // Blob ì§ì ‘ ì €ì¥ (Base64 ë³€í™˜ ì—†ìŒ!)
            const file = {
                id: 'file_' + Date.now(),
                creatorId: currentUser.id,
                fileName: fileName,
                fileType: contentType === 'audio' ? 'TL3' : 'TL4',
                contentType: contentType,
                duration: duration,
                
                totalTL: initialCharge,
                remainingTL: initialCharge,
                
                // Blob ì§ì ‘ ì €ì¥!
                fileBlob: selectedFileData,
                fileSize: selectedFileData.size,
                fileData: null, // í˜¸í™˜ì„± ìœ ì§€
                fileURL: null,
                
                aiGenerated: aiTools.length > 0,
                aiToolsUsed: aiTools,
                humanContribution: humanContrib,
                
                viewCount: 0,
                totalEarned: 0,
                createdAt: Date.now()
            };
            
            console.log('íŒŒì¼ ê°ì²´ ìƒì„±:', file.id);
            
            // íŒŒì¼ ë°°ì—´ì— ì¶”ê°€
            files.push(file);
            
            // currentUser ë™ê¸°í™”
            const userToUpdate = users.find(u => u.id === currentUser.id);
            if (userToUpdate) {
                userToUpdate.totalFilesUploaded = (userToUpdate.totalFilesUploaded || 0) + 1;
                currentUser = userToUpdate;
            }
            
            // IndexedDBì— ì €ì¥
            saveFiles().then(() => {
                return saveUsers();
            }).then(() => {
                
                console.log('âœ… ì—…ë¡œë“œ ì™„ë£Œ!');
                
                // í–‰ë™ ê¸°ë¡ (ê¸°ì—¬ë„ ë¶„ì„ìš©)
                recordAction('upload', {
                    fileName: fileName,
                    fileType: file.fileType,
                    duration: duration,
                    initialCharge: initialCharge,
                    fileSize: fileSizeMB
                });
                
                showToast(`âœ… "${fileName}" íŒŒì¼ ì—…ë¡œë“œ ì™„ë£Œ!`, 'success');
                alert(`âœ… ì—…ë¡œë“œ ì„±ê³µ!\n\níŒŒì¼: ${fileName}\níƒ€ì…: ${file.fileType}\ní¬ê¸°: ${fileSizeMB} MB\nì¬ìƒì‹œê°„: ${duration}ì´ˆ\nì´ˆê¸° ì¶©ì „: ${initialCharge} TL (ì”ì•¡ì—ì„œ ì°¨ê°ë¨)\n\níƒìƒ‰ íƒ­ì—ì„œ í™•ì¸í•˜ì„¸ìš”!`);
                
                document.getElementById('fileInput').value = '';
                document.getElementById('uploadForm').classList.add('hidden');
                selectedFileData = null;
                
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸš€ TL íŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ì—…ë¡œë“œ';
                
                updateDashboard();
                
            }).catch(error => {
                console.error('ì €ì¥ ì‹¤íŒ¨:', error);
                files.pop();
                currentUser.totalFilesUploaded--;
                alert('ì €ì¥ ì‹¤íŒ¨!\n\n' + error.message);
                uploadBtn.disabled = false;
                uploadBtn.textContent = 'ğŸš€ TL íŒŒì¼ë¡œ ë³€í™˜í•˜ì—¬ ì—…ë¡œë“œ';
            });
        }

        // ===== íŒŒì¼ ì¶©ì „ (ëˆ„êµ¬ë‚˜ ê°€ëŠ¥) =====
        async function chargeFileForPlay(fileId) {
            console.log('ì¶©ì „ ì‹œì‘, íŒŒì¼ ID:', fileId);
            
            // currentUser ë™ê¸°í™”
            if (currentUser && currentUser.id) {
                const syncedUser = users.find(u => u.id === currentUser.id);
                if (syncedUser) currentUser = syncedUser;
            }
            
            const file = files.find(f => f.id === fileId);
            if (!file) {
                console.error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', fileId);
                return;
            }
            
            console.log('ì¶©ì „ ëŒ€ìƒ íŒŒì¼:', file.fileName, 'í˜„ì¬ TL:', file.remainingTL);
            
            // í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ìì‹ ì˜ íŒŒì¼ë„ ì¶©ì „ ê°€ëŠ¥
            
            let tlAmount;
            
            if (file.contentType === 'image') {
                const amount = prompt(
                    `ì´ë¯¸ì§€ëŠ” ë³´ëŠ” ì‹œê°„ë§Œí¼ TLì´ ì°¨ê°ë©ë‹ˆë‹¤.\n` +
                    `ì¶©ì „í•  TLì„ ì…ë ¥í•˜ì„¸ìš”:`,
                    '300'
                );
                
                if (!amount || isNaN(amount) || amount <= 0) return;
                tlAmount = parseInt(amount);
                
            } else {
                const playCount = prompt(
                    `ì´ íŒŒì¼ì„ ëª‡ íšŒ ì¬ìƒí•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n` +
                    `1íšŒ ì¬ìƒ = ${file.duration} TL\n` +
                    `ì˜ˆ) 1 ì…ë ¥ = ${file.duration} TL, 2 ì…ë ¥ = ${file.duration * 2} TL`,
                    '1'
                );
                
                if (!playCount || isNaN(playCount) || playCount <= 0) return;
                
                const times = parseInt(playCount);
                tlAmount = file.duration * times;
            }
            
            console.log('ì¶©ì „í•  TL:', tlAmount);
            
            if (tlAmount > currentUser.tlBalance) {
                showToast(`TL ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤. í•„ìš”: ${tlAmount} TL, ë³´ìœ : ${currentUser.tlBalance} TL`, 'error');
                return;
            }
            
            // TL ì¶©ì „
            const beforeTL = file.remainingTL;
            currentUser.tlBalance -= tlAmount;
            file.remainingTL += tlAmount;
            file.totalTL += tlAmount;
            
            console.log('ì¶©ì „ ì „ TL:', beforeTL);
            console.log('ì¶©ì „ í›„ TL:', file.remainingTL);
            
            // IndexedDBì— ì €ì¥
            await saveFiles();
            await saveUsers();
            
            // í–‰ë™ ê¸°ë¡ (ê¸°ì—¬ë„ ë¶„ì„ìš©)
            await recordAction('charge', {
                fileId: file.id,
                fileName: file.fileName,
                tlAmount: tlAmount,
                isSelfFile: false
            });
            
            const message = file.contentType === 'image' 
                ? `âœ… ${tlAmount} TL ì¶©ì „ ì™„ë£Œ! í˜„ì¬: ${Math.floor(file.remainingTL)} TL`
                : `âœ… ${tlAmount} TL ì¶©ì „ ì™„ë£Œ! (${Math.floor(tlAmount / file.duration)}íšŒ ì¬ìƒ ê°€ëŠ¥)`;
            
            showToast(message, 'success');
            
            // í™”ë©´ ê°±ì‹ 
            console.log('í™”ë©´ ê°±ì‹  ì‹œì‘...');
            updateBrowse();
            updateDashboard();
            console.log('í™”ë©´ ê°±ì‹  ì™„ë£Œ!');
        }
        
        // ===== íŒŒì¼ ì¬ì¶©ì „ (ì†Œìœ ìë§Œ) =====
        async function rechargeFile(fileId) {
            const file = files.find(f => f.id === fileId);
            if (!file || file.creatorId !== currentUser.id) return;
            
            const amount = prompt('ì¶©ì „í•  TLì„ ì…ë ¥í•˜ì„¸ìš”:', '1000');
            if (!amount || isNaN(amount) || amount <= 0) return;
            
            const tlAmount = parseInt(amount);
            
            if (tlAmount > currentUser.tlBalance) {
                showToast('TL ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            // TL ì°¨ê° ë° íŒŒì¼ ì¶©ì „
            currentUser.tlBalance -= tlAmount;
            file.remainingTL += tlAmount;
            file.totalTL += tlAmount;
            
            await saveFiles();
            await saveUsers();
            
            // í–‰ë™ ê¸°ë¡ (ê¸°ì—¬ë„ ë¶„ì„ìš©)
            await recordAction('charge', {
                fileId: file.id,
                fileName: file.fileName,
                tlAmount: tlAmount,
                isSelfFile: true // ìê¸° íŒŒì¼ ì¬ì¶©ì „
            });
            
            showToast(`âœ… ${tlAmount} TL ì¶©ì „ ì™„ë£Œ!`, 'success');
            updateDashboard();
        }

        // ===== íƒìƒ‰ =====
        function updateBrowse() {
            console.log('=== íƒìƒ‰ íƒ­ ì—…ë°ì´íŠ¸ ===');
            
            const allFilesList = document.getElementById('allFilesList');
            
            // ë°ì´í„° ì¬ë¡œë“œ
            loadData();
            
            console.log('ì´ íŒŒì¼ ìˆ˜:', files.length);
            console.log('í˜„ì¬ ì‚¬ìš©ì:', currentUser.username);
            
            if (files.length === 0) {
                console.log('í‘œì‹œí•  íŒŒì¼ì´ ì—†ìŒ');
                allFilesList.innerHTML = `
                    <div style="text-align: center; padding: 60px 20px; background: #f8f9ff; border-radius: 12px;">
                        <div style="font-size: 4rem; margin-bottom: 20px;">ğŸ“‚</div>
                        <h3 style="color: #667eea; margin-bottom: 10px;">ì•„ì§ ì—…ë¡œë“œëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</h3>
                        <p style="color: #666;">ì—…ë¡œë“œ íƒ­ì—ì„œ ì²« ë²ˆì§¸ íŒŒì¼ì„ ì—…ë¡œë“œí•´ë³´ì„¸ìš”!</p>
                    </div>
                `;
                return;
            }
            
            console.log('íŒŒì¼ ëª©ë¡ ìƒì„± ì‹œì‘...');
            
            allFilesList.innerHTML = files.map((file, index) => {
                console.log(`íŒŒì¼ ${index + 1}:`, file.fileName, 'ë‚¨ì€ TL:', file.remainingTL);
                
                const creator = users.find(u => u.id === file.creatorId);
                const isMyFile = file.creatorId === currentUser.id;
                
                // ì´ë¯¸ì§€ëŠ” ë¬´í•œëŒ€ë¡œ í‘œì‹œ
                const durationText = file.contentType === 'image' ? 'ë¬´í•œëŒ€' : file.duration + 'ì´ˆ';
                const chargeText = file.contentType === 'image' ? 'ì‹œê°„ë‹¹ TL ì°¨ê°' : `1íšŒ ì¬ìƒ = ${file.duration} TL`;
                
                // ì¬ìƒ ê°€ëŠ¥ ì—¬ë¶€ í™•ì¸
                let canPlay = false;
                let playableCount = 0;
                let needTL = 0;
                
                if (file.contentType === 'image') {
                    needTL = 60;
                    canPlay = file.remainingTL >= needTL;
                } else {
                    needTL = file.duration;
                    canPlay = file.remainingTL >= needTL;
                    if (canPlay) {
                        playableCount = Math.floor(file.remainingTL / file.duration);
                    }
                }
                
                console.log(`  - ì¬ìƒ ê°€ëŠ¥: ${canPlay}, í•„ìš”: ${needTL} TL, ë³´ìœ : ${file.remainingTL} TL`);
                
                // ì¬ìƒ ë²„íŠ¼ HTML - ëˆ„êµ¬ë‚˜ ì¬ìƒ ê°€ëŠ¥! (í…ŒìŠ¤íŠ¸ ëª¨ë“œ)
                let playButton = '';
                if (canPlay) {
                    const playText = file.contentType === 'image' 
                        ? 'â–¶ ë³´ê¸°' 
                        : `â–¶ ì¬ìƒ (${playableCount}íšŒ)`;
                    playButton = `<button class="btn-sm btn-play" onclick="playFile('${file.id}')" style="background: #10b981; color: white; font-weight: bold;">
                        ${playText}
                    </button>`;
                } else {
                    const needText = file.contentType === 'image' 
                        ? 'ì¶©ì „ í•„ìš” (60 TL)' 
                        : `ì¶©ì „ í•„ìš” (${needTL} TL)`;
                    playButton = `<button class="btn-sm" style="background: #999; color: white;" disabled>
                        ${needText}
                    </button>`;
                }
                
                return `
                    <div class="file-item" style="border-left: 4px solid ${canPlay ? '#10b981' : '#ef4444'};">
                        <div class="file-title">${getFileIcon(file.contentType)} ${file.fileName}</div>
                        <div class="file-meta">
                            ì‘ì„±ì: ${creator ? creator.username : 'Unknown'} ${isMyFile ? '(ë‚˜)' : ''}<br>
                            ${file.fileType} â€¢ ${durationText} (${chargeText})<br>
                            ì¶©ì „ëœ TL: <strong style="color: ${canPlay ? '#10b981' : '#ef4444'}; font-size: 1.1rem;">${Math.floor(file.remainingTL)}</strong> / ${file.totalTL}
                            ${canPlay ? '<span style="color: #10b981; margin-left: 10px;">âœ… ì¬ìƒ ê°€ëŠ¥</span>' : '<span style="color: #ef4444; margin-left: 10px;">âš ï¸ ì¶©ì „ í•„ìš”</span>'}
                        </div>
                        <div class="file-actions">
                            <button class="btn-sm btn-recharge" onclick="chargeFileForPlay('${file.id}')" style="background: #f59e0b; color: white; font-weight: bold;">
                                âš¡ TL ì¶©ì „ ${file.contentType === 'image' ? '' : '(1íšŒ = ' + file.duration + ' TL)'}
                            </button>
                            ${playButton}
                        </div>
                    </div>
                `;
            }).join('');
            
            console.log('íƒìƒ‰ íƒ­ ì—…ë°ì´íŠ¸ ì™„ë£Œ!');
        }

        function getFileIcon(type) {
            if (type === 'audio') return 'ğŸµ';
            if (type === 'video') return 'ğŸ¬';
            if (type === 'image') return 'ğŸ–¼ï¸';
            return 'ğŸ“„';
        }

        // ===== íŒŒì¼ ì¬ìƒ (ë°˜ë“œì‹œ ì¬ìƒë¨!) =====
        function playFile(fileId) {
            console.log('=== ì¬ìƒ ì‹œì‘ ===');
            console.log('íŒŒì¼ ID:', fileId);
            
            const file = files.find(f => f.id === fileId);
            if (!file) {
                console.error('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                showToast('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤', 'error');
                return;
            }
            
            console.log('íŒŒì¼:', file.fileName);
            console.log('íƒ€ì…:', file.contentType);
            console.log('ë‚¨ì€ TL:', file.remainingTL);
            console.log('í•„ìš” TL:', file.duration);
            console.log('fileData ì¡´ì¬:', !!file.fileData);
            console.log('fileURL ì¡´ì¬:', !!file.fileURL);
            console.log('fileBlob ì¡´ì¬:', !!file.fileBlob);
            
            // í…ŒìŠ¤íŠ¸ ëª¨ë“œ: ìì‹ ì˜ íŒŒì¼ë„ ì¬ìƒ ê°€ëŠ¥
            
            // ì¬ìƒ ì¡°ê±´ í™•ì¸
            if (file.contentType === 'image') {
                if (file.remainingTL < 60) {
                    showToast(`ì´ë¯¸ì§€ë¥¼ ë³´ë ¤ë©´ ìµœì†Œ 60 TLì´ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬: ${Math.floor(file.remainingTL)} TL`, 'error');
                    return;
                }
            } else {
                if (file.remainingTL < file.duration) {
                    showToast(`ì¬ìƒí•˜ë ¤ë©´ ${file.duration} TLì´ í•„ìš”í•©ë‹ˆë‹¤. í˜„ì¬: ${Math.floor(file.remainingTL)} TL`, 'error');
                    return;
                }
            }
            
            console.log('ì¬ìƒ ì¡°ê±´ í†µê³¼!');
            
            currentFile = file;
            
            document.getElementById('playerTitle').textContent = file.fileName;
            document.getElementById('playerTL').textContent = Math.floor(file.remainingTL);
            
            // í”Œë ˆì´ì–´ ì´ˆê¸°í™”
            const audioPlayer = document.getElementById('audioPlayer');
            const videoPlayer = document.getElementById('videoPlayer');
            const imagePlayer = document.getElementById('imagePlayer');
            
            audioPlayer.classList.add('hidden');
            videoPlayer.classList.add('hidden');
            imagePlayer.classList.add('hidden');
            
            if (audioPlayer.pause) audioPlayer.pause();
            if (videoPlayer.pause) videoPlayer.pause();
            audioPlayer.src = '';
            videoPlayer.src = '';
            imagePlayer.src = '';
            
            // íŒŒì¼ ì†ŒìŠ¤ ê²°ì • - Blob ìš°ì„ , ì—†ìœ¼ë©´ fileData (Base64)
            let fileSource;
            if (file.fileBlob) {
                // Blobì´ ìˆìœ¼ë©´ URL ìƒì„± (IndexedDB)
                fileSource = URL.createObjectURL(file.fileBlob);
                console.log('Blob URL ìƒì„±');
            } else if (file.fileData) {
                // Base64 ì‚¬ìš© (ê¸°ì¡´ ë°ì´í„° í˜¸í™˜)
                fileSource = file.fileData;
                console.log('Base64 ì‚¬ìš©');
            } else {
                console.error('ì¬ìƒí•  íŒŒì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤!');
                showToast('íŒŒì¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤.', 'error');
                return;
            }
            
            console.log('íŒŒì¼ ì†ŒìŠ¤ ì¤€ë¹„ ì™„ë£Œ');
            
            // ë¯¸ë””ì–´ íƒ€ì…ì— ë”°ë¼ í”Œë ˆì´ì–´ ì„ íƒ ë° ì¬ìƒ
            if (file.contentType === 'audio') {
                console.log('ì˜¤ë””ì˜¤ ì¬ìƒ ì¤€ë¹„...');
                currentMediaElement = audioPlayer;
                currentMediaElement.src = fileSource;
                currentMediaElement.classList.remove('hidden');
                
                console.log('ì˜¤ë””ì˜¤ src ì„¤ì •:', fileSource.substring(0, 50) + '...');
                
                // ë°˜ë“œì‹œ ì¬ìƒ
                currentMediaElement.load();
                const playPromise = currentMediaElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('âœ… ì˜¤ë””ì˜¤ ì¬ìƒ ì‹œì‘ ì„±ê³µ!');
                        showToast('ğŸµ ìŒì•… ì¬ìƒ ì‹œì‘!', 'success');
                    }).catch(err => {
                        console.error('âŒ ì¬ìƒ ì‹¤íŒ¨:', err);
                        console.error('ì—ëŸ¬ ìƒì„¸:', err.message);
                        showToast('ì¬ìƒ ì‹¤íŒ¨: ' + err.message, 'error');
                    });
                }
                
            } else if (file.contentType === 'video') {
                console.log('ë¹„ë””ì˜¤ ì¬ìƒ ì¤€ë¹„...');
                currentMediaElement = videoPlayer;
                currentMediaElement.src = fileSource;
                currentMediaElement.classList.remove('hidden');
                
                console.log('ë¹„ë””ì˜¤ src ì„¤ì •:', fileSource.substring(0, 50) + '...');
                
                // ë°˜ë“œì‹œ ì¬ìƒ
                currentMediaElement.load();
                const playPromise = currentMediaElement.play();
                
                if (playPromise !== undefined) {
                    playPromise.then(() => {
                        console.log('âœ… ë¹„ë””ì˜¤ ì¬ìƒ ì‹œì‘ ì„±ê³µ!');
                        showToast('ğŸ¬ ì˜ìƒ ì¬ìƒ ì‹œì‘!', 'success');
                    }).catch(err => {
                        console.error('âŒ ì¬ìƒ ì‹¤íŒ¨:', err);
                        console.error('ì—ëŸ¬ ìƒì„¸:', err.message);
                        showToast('ì¬ìƒ ì‹¤íŒ¨: ' + err.message, 'error');
                    });
                }
                
            } else if (file.contentType === 'image') {
                console.log('ì´ë¯¸ì§€ í‘œì‹œ ì¤€ë¹„...');
                currentMediaElement = imagePlayer;
                currentMediaElement.src = fileSource;
                currentMediaElement.classList.remove('hidden');
                
                console.log('âœ… ì´ë¯¸ì§€ í‘œì‹œ ì„±ê³µ!');
                showToast('ğŸ–¼ï¸ ì´ë¯¸ì§€ í‘œì‹œ ì‹œì‘!', 'success');
            }
            
            document.getElementById('playerModal').classList.add('active');
            
            // í–‰ë™ ê¸°ë¡ (ê¸°ì—¬ë„ ë¶„ì„ìš©)
            recordAction('play', {
                fileId: file.id,
                fileName: file.fileName,
                duration: file.duration,
                isSelfFile: file.creatorId === currentUser.id
            });
            
            // TL ì°¨ê° ì‹œì‘
            console.log('TL ì°¨ê° íƒ€ì´ë¨¸ ì‹œì‘...');
            startTLDeduction();
        }

        function startTLDeduction() {
            console.log('TL ì°¨ê° ì‹œì‘');
            
            // ê¸°ì¡´ íƒ€ì´ë¨¸ ì •ë¦¬
            if (tlDeductionInterval) {
                clearInterval(tlDeductionInterval);
            }
            
            // 1ì´ˆë§ˆë‹¤ 1 TL ì°¨ê°
            tlDeductionInterval = setInterval(async () => {
                if (!currentFile || currentFile.remainingTL <= 0) {
                    console.log('TL ì†Œì§„, ì¬ìƒ ì¤‘ì§€');
                    stopPlayback();
                    return;
                }
                
                // TL ì°¨ê°
                currentFile.remainingTL -= 1;
                
                // ì°½ì‘ìì—ê²Œ TL ì§€ê¸‰
                const creator = users.find(u => u.id === currentFile.creatorId);
                if (creator) {
                    creator.tlBalance += 1;
                    creator.totalEarnings += 1;
                    currentFile.totalEarned += 1;
                }
                
                // UI ì—…ë°ì´íŠ¸
                document.getElementById('playerTL').textContent = Math.floor(currentFile.remainingTL);
                
                // IndexedDBì— ì €ì¥
                await saveFiles();
                await saveUsers();
                
                console.log('TL ì°¨ê°:', currentFile.fileName, 'ë‚¨ì€:', Math.floor(currentFile.remainingTL));
                
            }, 1000);
            
            console.log('TL ì°¨ê° íƒ€ì´ë¨¸ ì„¤ì • ì™„ë£Œ');
        }

        function stopPlayback() {
            if (tlDeductionInterval) {
                clearInterval(tlDeductionInterval);
                tlDeductionInterval = null;
            }
            
            if (currentMediaElement) {
                if (currentMediaElement.pause) {
                    currentMediaElement.pause();
                }
                currentMediaElement.src = '';
            }
            
            if (currentFile && currentFile.remainingTL <= 0) {
                showToast('âš ï¸ TLì´ ëª¨ë‘ ì†Œì§„ë˜ì—ˆìŠµë‹ˆë‹¤!', 'error');
            }
            
            currentFile = null;
            currentMediaElement = null;
        }

        function closePlayer() {
            stopPlayback();
            document.getElementById('playerModal').classList.remove('active');
            updateBrowse();
            updateDashboard();
        }

        // ===== ì±„êµ´ =====
        async function executeMining() {
            const amount = parseFloat(document.getElementById('miningAmount').value);
            
            if (!amount || amount <= 0) {
                showToast('ë³€í™˜í•  TL ì–‘ì„ ì…ë ¥í•˜ì„¸ìš”', 'error');
                return;
            }
            
            // currentUser ë™ê¸°í™”
            const user = users.find(u => u.id === currentUser.id);
            if (!user) return;
            currentUser = user;
            
            if (amount > currentUser.tlBalance) {
                showToast('TL ì”ì•¡ì´ ë¶€ì¡±í•©ë‹ˆë‹¤', 'error');
                return;
            }
            
            // ê¸°ì—¬ë„ ê¸°ë°˜ ì±„êµ´ ë¹„ìœ¨ ê³„ì‚°
            let miningRate = 0.1; // ê¸°ë³¸ 10%
            
            if (currentUser.actions && currentUser.actions.length > 0) {
                // í–‰ë™ ë‚´ì—­ ë¶„ì„
                const uploads = currentUser.actions.filter(a => a.type === 'upload').length;
                const plays = currentUser.actions.filter(a => a.type === 'play').length;
                const charges = currentUser.actions.filter(a => a.type === 'charge').length;
                
                // ë³´ë„ˆìŠ¤ ì ìš©
                if (uploads > 0) miningRate += 0.02; // ì—…ë¡œë“œ +2%
                if (plays > 5) miningRate += 0.03;   // ì¬ìƒ 5íšŒ ì´ìƒ +3%
                if (charges > 3) miningRate += 0.02; // ì¶©ì „ 3íšŒ ì´ìƒ +2%
                
                // ìµœëŒ€ 20%ê¹Œì§€
                miningRate = Math.min(miningRate, 0.2);
                
                console.log(`ì±„êµ´ ë¹„ìœ¨: ${(miningRate * 100).toFixed(1)}% (ê¸°ì—¬ë„ ë°˜ì˜)`);
            }
            
            const tlcMined = amount * miningRate;
            
            currentUser.tlBalance -= amount;
            currentUser.tlcBalance += tlcMined;
            
            await saveUsers();
            
            // í–‰ë™ ê¸°ë¡ (ê¸°ì—¬ë„ ë¶„ì„ìš©)
            await recordAction('mine', {
                tlAmount: amount,
                tlcMined: tlcMined,
                miningRate: miningRate
            });
            
            showToast(`âœ… ì±„êµ´ ì„±ê³µ! ${amount.toLocaleString()} TL â†’ ${tlcMined.toFixed(4)} TLC (ë¹„ìœ¨: ${(miningRate * 100).toFixed(1)}%)`, 'success');
            
            document.getElementById('miningAmount').value = '';
            updateDashboard();
        }

        // ===== ì €ì¥ =====
        async function saveUsers() {
            try {
                await dbPutAll('users', users);
                console.log('ì‚¬ìš©ì ì €ì¥ ì™„ë£Œ:', users.length, 'ëª…');
            } catch (error) {
                console.error('ì‚¬ìš©ì ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        async function saveFiles() {
            try {
                await dbPutAll('files', files);
                console.log('íŒŒì¼ ì €ì¥ ì™„ë£Œ:', files.length, 'ê°œ');
            } catch (error) {
                console.error('íŒŒì¼ ì €ì¥ ì‹¤íŒ¨:', error);
            }
        }

        // ===== ì•Œë¦¼ =====
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.className = 'toast ' + type + ' active';
            
            setTimeout(() => {
                toast.classList.remove('active');
            }, 3000);
        }
    </script>
</body>
</html>
