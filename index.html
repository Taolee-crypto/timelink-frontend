<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>TimeLink â€” Time-Based Media Economy</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: #0a0a0a; 
            color: #fff; 
            line-height: 1.6;
        }
        .container { max-width: 1400px; margin: 0 auto; padding: 20px; }
        
        .header {
            background: linear-gradient(145deg, #1a0b2e, #1a1a1a);
            padding: 24px 32px;
            border-radius: 20px;
            margin-bottom: 24px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border: 1px solid rgba(138,43,226,0.3);
        }
        .header h1 {
            font-size: 2rem;
            background: linear-gradient(135deg, #b983ff, #8a2be2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        .balances { display: flex; gap: 16px; }
        .balance {
            background: rgba(255,255,255,0.05);
            padding: 12px 20px;
            border-radius: 12px;
            border: 1px solid rgba(255,255,255,0.1);
        }
        .balance .lbl { font-size: 10px; color: #999; text-transform: uppercase; }
        .balance .amt { font-size: 22px; font-weight: 800; }
        
        .tabs {
            background: rgba(17,17,17,0.8);
            border-radius: 999px;
            padding: 8px;
            display: flex;
            gap: 6px;
            margin-bottom: 28px;
            overflow-x: auto;
        }
        .tab {
            padding: 12px 24px;
            border-radius: 999px;
            border: none;
            background: transparent;
            color: #999;
            font-weight: 600;
            font-size: 14px;
            cursor: pointer;
            white-space: nowrap;
            transition: all 0.2s;
        }
        .tab:hover { background: rgba(255,255,255,0.05); color: white; }
        .tab.active { background: #8a2be2; color: white; }
        
        .tab-content { display: none; }
        .tab-content.active { display: block; }
        
        .card {
            background: linear-gradient(145deg, #1a1a1a, #151515);
            border-radius: 20px;
            padding: 32px;
            margin-bottom: 28px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .card h2 { 
            font-size: 1.8rem; 
            margin-bottom: 24px;
            background: linear-gradient(135deg, #fff, #e0e0e0);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(360px, 1fr)); gap: 24px; }
        
        .file-card {
            background: #1e1e1e;
            border-radius: 16px;
            overflow: hidden;
            border: 1px solid rgba(255,255,255,0.08);
            transition: all 0.3s;
        }
        .file-card:hover { transform: translateY(-6px); border-color: #8a2be2; }
        
        .thumb {
            height: 160px;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 3.5rem;
            background: linear-gradient(145deg, #2a1a3a, #1e1e1e);
            position: relative;
        }
        .thumb.video { background: linear-gradient(145deg, #ff7b00, #ff5500); }
        
        .badge {
            position: absolute;
            padding: 6px 14px;
            border-radius: 999px;
            font-size: 11px;
            font-weight: 700;
            color: white;
        }
        .badge-type { left: 12px; top: 12px; background: rgba(0,0,0,0.7); }
        .badge-cert { right: 12px; top: 12px; background: rgba(255,215,0,0.9); color: black; }
        .badge-genre { left: 12px; bottom: 12px; }
        
        .info { padding: 20px; }
        .name { font-size: 1.2rem; font-weight: 700; margin-bottom: 6px; }
        .creator { color: #999; font-size: 0.9rem; margin-bottom: 16px; }
        
        .panel {
            background: rgba(255,255,255,0.03);
            padding: 14px;
            border-radius: 12px;
            margin-bottom: 16px;
            font-size: 13px;
            border-left: 4px solid #8a2be2;
        }
        
        .actions { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        .btn {
            padding: 12px;
            border: none;
            border-radius: 12px;
            font-weight: 700;
            font-size: 13px;
            cursor: pointer;
            transition: all 0.2s;
        }
        .btn:hover { transform: translateY(-2px); }
        .btn-play { background: #1db954; color: white; }
        .btn-charge { background: #f59e0b; color: black; }
        .btn-share { background: #8a2be2; color: white; grid-column: span 2; }
        .btn-disabled { background: #333; color: #666; cursor: not-allowed; }
        
        .form-group { margin-bottom: 20px; }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            color: #999;
            font-size: 12px;
            font-weight: 600;
            text-transform: uppercase;
        }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%;
            padding: 14px 16px;
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 12px;
            color: white;
            font-size: 14px;
            font-family: inherit;
        }
        
        .type-selector { display: flex; gap: 20px; margin-bottom: 28px; }
        .type-card {
            flex: 1;
            background: rgba(255,255,255,0.05);
            padding: 28px;
            border-radius: 20px;
            text-align: center;
            cursor: pointer;
            border: 2px solid transparent;
            transition: all 0.2s;
        }
        .type-card:hover { transform: translateY(-4px); }
        .type-card.selected { border-color: #1db954; background: rgba(29,185,84,0.1); }
        .type-card.video.selected { border-color: #ff5500; background: rgba(255,85,0,0.1); }
        
        .upload {
            border: 2px dashed #8a2be2;
            background: rgba(138,43,226,0.05);
            border-radius: 20px;
            padding: 50px;
            text-align: center;
            cursor: pointer;
            margin-bottom: 28px;
            transition: all 0.2s;
        }
        .upload:hover { background: rgba(138,43,226,0.1); transform: scale(1.01); }
        
        .modal {
            display: none;
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.92);
            z-index: 2000;
            justify-content: center;
            align-items: center;
            padding: 20px;
        }
        .modal-content {
            background: #1e1e1e;
            border-radius: 20px;
            padding: 36px;
            max-width: 600px;
            width: 100%;
            max-height: 90vh;
            overflow-y: auto;
        }
        
        .toast {
            position: fixed;
            top: 28px;
            right: 28px;
            background: #1e1e1e;
            padding: 16px 24px;
            border-radius: 999px;
            display: none;
            z-index: 3000;
            min-width: 320px;
            border-left: 6px solid #1db954;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
        }
        
        .hero {
            background: linear-gradient(145deg, #2a1a3a, #1a1a1a);
            padding: 48px;
            border-radius: 24px;
            text-align: center;
            margin-bottom: 32px;
            border: 1px solid rgba(138,43,226,0.3);
        }
        .hero h1 {
            font-size: 3rem;
            margin-bottom: 16px;
            background: linear-gradient(135deg, #b983ff, #8a2be2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }
        
        .feature-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr));
            gap: 24px;
            margin-top: 32px;
        }
        .feature-card {
            background: rgba(255,255,255,0.03);
            padding: 24px;
            border-radius: 16px;
            border: 1px solid rgba(255,255,255,0.08);
        }
        .feature-card h3 { margin: 12px 0; font-size: 1.2rem; }
        .feature-card p { color: #999; font-size: 0.9rem; line-height: 1.6; }
        
        .search-box {
            background: rgba(255,255,255,0.05);
            border: 1px solid rgba(255,255,255,0.1);
            border-radius: 999px;
            padding: 14px 24px;
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 24px;
        }
        .search-box input {
            flex: 1;
            background: transparent;
            border: none;
            color: white;
            font-size: 15px;
            outline: none;
        }
        
        .genre-filter {
            display: flex;
            gap: 10px;
            margin-bottom: 24px;
            flex-wrap: wrap;
        }
        .genre-btn {
            padding: 8px 18px;
            border-radius: 999px;
            border: 1px solid rgba(255,255,255,0.1);
            background: transparent;
            color: #999;
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
        }
        .genre-btn:hover { border-color: #8a2be2; }
        .genre-btn.active { background: #8a2be2; color: white; border-color: #8a2be2; }
        
        /* Auth Screen */
        #authScreen {
            position: fixed;
            inset: 0;
            background: linear-gradient(145deg, #1a0b2e, #0a0a0a);
            display: flex;
            justify-content: center;
            align-items: center;
            z-index: 9999;
        }
        .auth-container {
            background: linear-gradient(145deg, #1e1e1e, #151515);
            border-radius: 24px;
            padding: 48px;
            max-width: 480px;
            width: 90%;
            border: 1px solid rgba(138,43,226,0.3);
        }
        .auth-logo {
            text-align: center;
            margin-bottom: 40px;
        }
        .auth-logo h1 {
            font-size: 2.5rem;
            background: linear-gradient(135deg, #b983ff, #8a2be2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-bottom: 8px;
        }
        .auth-form { margin-top: 32px; }
        .auth-btn {
            width: 100%;
            padding: 18px;
            background: linear-gradient(135deg, #8a2be2, #b983ff);
            color: white;
            border: none;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.3s;
            margin-top: 12px;
        }
        .auth-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 24px rgba(138,43,226,0.4);
        }
        .auth-switch {
            text-align: center;
            margin-top: 24px;
            color: #999;
            font-size: 14px;
        }
        .auth-switch a {
            color: #8a2be2;
            text-decoration: none;
            font-weight: 600;
            cursor: pointer;
        }
        .auth-switch a:hover { text-decoration: underline; }
        .auth-message {
            display: none;
            padding: 14px;
            border-radius: 10px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 14px;
            font-weight: 600;
        }
        #mainApp { display: none; }
        .user-info {
            display: flex;
            align-items: center;
            gap: 20px;
        }
        .user-name {
            background: rgba(255,255,255,0.05);
            padding: 10px 18px;
            border-radius: 999px;
            font-weight: 600;
        }
        .logout-btn {
            background: rgba(255,68,68,0.2);
            color: #ff4444;
            border: 1px solid rgba(255,68,68,0.3);
            padding: 10px 20px;
            border-radius: 999px;
            font-weight: 600;
            cursor: pointer;
            font-size: 13px;
            transition: all 0.2s;
        }
        .logout-btn:hover { background: rgba(255,68,68,0.3); }
    </style>
</head>
<body>

<!-- Auth Screen -->
<div id="authScreen">
    <div class="auth-container">
        <div class="auth-logo">
            <h1>â° TimeLink</h1>
            <p style="color:#999;">Time-Based Media Economy</p>
        </div>
        
        <div class="auth-message" id="authMessage"></div>
        
        <!-- Login Form -->
        <div id="loginForm" class="auth-form">
            <div class="form-group">
                <label>ì´ë©”ì¼</label>
                <input type="email" id="loginEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="loginPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="auth-btn" onclick="Auth.login()">ë¡œê·¸ì¸</button>
            <div class="auth-switch">
                ê³„ì •ì´ ì—†ìœ¼ì‹ ê°€ìš”? <a onclick="Auth.switchAuthMode('register')">íšŒì›ê°€ì…</a>
            </div>
        </div>
        
        <!-- Register Form -->
        <div id="registerForm" class="auth-form" style="display:none;">
            <div class="form-group">
                <label>ì´ë¦„</label>
                <input type="text" id="regName" placeholder="í™ê¸¸ë™">
            </div>
            <div class="form-group">
                <label>ì´ë©”ì¼</label>
                <input type="email" id="regEmail" placeholder="your@email.com">
            </div>
            <div class="form-group">
                <label>ë¹„ë°€ë²ˆí˜¸</label>
                <input type="password" id="regPassword" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢">
            </div>
            <button class="auth-btn" onclick="Auth.register()">íšŒì›ê°€ì…</button>
            <div class="auth-switch">
                ì´ë¯¸ ê³„ì •ì´ ìˆìœ¼ì‹ ê°€ìš”? <a onclick="Auth.switchAuthMode('login')">ë¡œê·¸ì¸</a>
            </div>
        </div>
    </div>
</div>

<!-- Main App -->
<div id="mainApp">

<div id="toast" class="toast"></div>
<input type="file" id="fileInput" style="display:none;" accept="audio/*,video/*">

<!-- Audio Player Modal -->
<div class="modal" id="audioModal">
    <div class="modal-content">
        <h2 id="playTitle">ì¬ìƒ ì¤‘</h2>
        <p style="color:#999; margin-bottom:20px;" id="playCreator">Creator</p>
        <div class="panel">
            <strong>â³ TL Balance</strong><br>
            <span style="font-size:2rem; font-weight:800;" id="playTL">0</span> TL
        </div>
        <audio id="audioPlayer" controls style="width:100%; margin:20px 0;"></audio>
        <button class="btn" onclick="App.stopPlay()" style="width:100%; background:#f44; color:white; padding:16px;">â¹ï¸ ì •ì§€</button>
    </div>
</div>

<!-- Charge Modal -->
<div class="modal" id="chargeModal">
    <div class="modal-content">
        <h2>ğŸ’° TL ì¶©ì „</h2>
        <div class="form-group" style="margin-top:24px;">
            <label>ì¶©ì „í•  TL</label>
            <input type="number" id="chargeAmount" value="1000" min="100" step="100">
        </div>
        <div style="display:flex; gap:12px;">
            <button class="btn btn-play" onclick="App.executeCharge()" style="flex:1; padding:16px;">ì¶©ì „</button>
            <button class="btn" onclick="App.closeModal()" style="flex:1; background:#333; color:white; padding:16px;">ì·¨ì†Œ</button>
        </div>
    </div>
</div>

<div class="container">
    <div class="header">
        <h1>â° TimeLink</h1>
        <div class="user-info">
            <div class="balances">
                <div class="balance">
                    <div class="lbl">ğŸ’° TL</div>
                    <div class="amt" id="walletTL">10,000</div>
                </div>
                <div class="balance">
                    <div class="lbl">ğŸª™ TLC</div>
                    <div class="amt" id="walletTLC">0.00</div>
                </div>
            </div>
            <div class="user-name">ğŸ‘¤ <span id="userName">User</span></div>
            <button class="logout-btn" onclick="App.resetDatabase()" style="background:rgba(255,165,0,0.2); color:#ffa500; border-color:rgba(255,165,0,0.3);">ğŸ”„ ë¦¬ì…‹</button>
            <button class="logout-btn" onclick="Auth.logout()">ë¡œê·¸ì•„ì›ƒ</button>
        </div>
    </div>

    <div class="tabs">
        <button class="tab active" onclick="App.switchTab('dashboard', event)">ğŸ“Š Dashboard</button>
        <button class="tab" onclick="App.switchTab('create', event)">ğŸ“¤ Create</button>
        <button class="tab" onclick="App.switchTab('myfiles', event)">ğŸµ My Files</button>
        <button class="tab" onclick="App.switchTab('share', event)">ğŸ”„ Share Place</button>
        <button class="tab" onclick="App.switchTab('radio', event)">ğŸ“» Radio</button>
        <button class="tab" onclick="App.switchTab('commercial', event)">ğŸ“º Commercial</button>
        <button class="tab" onclick="App.switchTab('car', event)">ğŸš—ğŸš¶ Car & Walk</button>
        <button class="tab" onclick="App.switchTab('mining', event)">â›ï¸ Mining</button>
        <button class="tab" onclick="App.switchTab('lecture', event)">ğŸ“š Lecture</button>
        <button class="tab" onclick="App.switchTab('gold', event)">ğŸ† Gold</button>
        <button class="tab" onclick="App.switchTab('ton', event)">â¬¡ TON</button>
    </div>

    <!-- Dashboard -->
    <div id="tabDashboard" class="tab-content active">
        <div class="hero">
            <h1>â° TimeLink</h1>
            <p style="font-size:1.2rem; color:#999;">Time-Based Media Economy</p>
        </div>

        <div class="card">
            <h2>ğŸ¯ TimeLinkë€?</h2>
            <p style="color:#999; line-height:1.8; margin-bottom:24px;">
                TimeLinkëŠ” ì‹œê°„ ê¸°ë°˜ ë¯¸ë””ì–´ ê²½ì œ í”Œë«í¼ì…ë‹ˆë‹¤. ëª¨ë“  ì½˜í…ì¸ ëŠ” ì‹œê°„ê³¼ í•¨ê»˜ íë¥´ë©°, 
                ì°½ì‘ìì™€ ì²­ì·¨ì ëª¨ë‘ê°€ ê³µì •í•˜ê²Œ ê°€ì¹˜ë¥¼ ë‚˜ëˆ•ë‹ˆë‹¤.
            </p>
            
            <div class="feature-grid">
                <div class="feature-card">
                    <div style="font-size:2.5rem;">ğŸ“¤</div>
                    <h3>Create</h3>
                    <p>MP3/MP4ë¥¼ TL3/TL4ë¡œ ë³€í™˜. Suno/Udio AI ìë™ ì¸ì¦.</p>
                </div>
                <div class="feature-card">
                    <div style="font-size:2.5rem;">ğŸµ</div>
                    <h3>My Files</h3>
                    <p>TL ì¶©ì „ í›„ ì¬ìƒ. ë³¸ì¸ íŒŒì¼ë„ ì²­ì·¨ ê°€ëŠ¥.</p>
                </div>
                <div class="feature-card">
                    <div style="font-size:2.5rem;">ğŸ”„</div>
                    <h3>Share Place</h3>
                    <p>AI DJ íë ˆì´ì…˜. ì²­ì·¨ì TL ì†Œë¹„ â†’ ì°½ì‘ì TL íšë“.</p>
                </div>
                <div class="feature-card">
                    <div style="font-size:2.5rem;">ğŸš—ğŸš¶</div>
                    <h3>Car & Walk</h3>
                    <p>ì´ë™ ì¤‘ ìŒì•… ì¬ìƒ = ìµœëŒ€ 2ë°° ë³´ìƒ (Movement AI).</p>
                </div>
                <div class="feature-card">
                    <div style="font-size:2.5rem;">â›ï¸</div>
                    <h3>Mining</h3>
                    <p>TLì˜ ìµœëŒ€ 50%ë¥¼ TLCë¡œ ì±„êµ´. ê¸°ì—¬ì§€ìˆ˜ ë³€ë™.</p>
                </div>
                <div class="feature-card">
                    <div style="font-size:2.5rem;">ğŸ†</div>
                    <h3>Gold Reserve</h3>
                    <p>í”Œë«í¼ ìˆ˜ìµ 10% â†’ ê¸ˆ êµ¬ë§¤ â†’ TLC ê°€ì¹˜ ìœ ì§€.</p>
                </div>
            </div>
        </div>

        <div class="card">
            <h2>â¬¡ TON Blockchain</h2>
            <p style="color:#999; line-height:1.8;">
                TimeLinkëŠ” TON ë¸”ë¡ì²´ì¸ê³¼ ì—°ë™ë©ë‹ˆë‹¤. TLC ì½”ì¸ì€ TON ë„¤íŠ¸ì›Œí¬ì—ì„œ ê±°ë˜ë˜ë©°,
                ì‹¤ì œ ì•”í˜¸í™”íë¡œì„œì˜ ê°€ì¹˜ë¥¼ ê°–ìŠµë‹ˆë‹¤. ì§€ê°‘ ì—°ë™ í›„ ììœ ë¡­ê²Œ ì…ì¶œê¸ˆì´ ê°€ëŠ¥í•©ë‹ˆë‹¤.
            </p>
        </div>
    </div>

    <!-- Create -->
    <div id="tabCreate" class="tab-content">
        <div class="card">
            <h2>ğŸ“¤ Create TL3/TL4</h2>
            
            <div class="type-selector">
                <div class="type-card audio selected" id="audioCard" onclick="App.selectType('audio')">
                    <div style="font-size:3rem;">ğŸµ</div>
                    <h3>TL3 Audio</h3>
                    <div style="color:#1db954; font-weight:700; margin-top:10px;">1ì´ˆ = 1 TL</div>
                    <p style="color:#999; font-size:13px; margin-top:8px;">MP3, WAV, FLAC</p>
                </div>
                <div class="type-card video" id="videoCard" onclick="App.selectType('video')">
                    <div style="font-size:3rem;">ğŸ¬</div>
                    <h3>TL4 Video</h3>
                    <div style="color:#ff5500; font-weight:700; margin-top:10px;">1ì´ˆ = 2 TL</div>
                    <p style="color:#999; font-size:13px; margin-top:8px;">MP4, MOV, AVI</p>
                </div>
            </div>

            <div class="upload" onclick="document.getElementById('fileInput').click()">
                <div style="font-size:3.5rem; margin-bottom:16px;" id="uploadIcon">ğŸµ</div>
                <h3 id="uploadTitle">íŒŒì¼ ì„ íƒí•˜ê¸°</h3>
                <p style="color:#999; margin-top:8px;" id="uploadDesc">MP3, WAV, FLAC</p>
            </div>

            <div id="uploadForm" style="display:none;">
                <div class="file-info-panel" style="background:rgba(138,43,226,0.1); border:1px solid #8a2be2; border-radius:12px; padding:16px; margin-bottom:20px;">
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:#999;">
                        <span>íŒŒì¼ëª…</span>
                        <span style="color:#fff; font-weight:600;" id="infoFileName">-</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:#999;">
                        <span>íŒŒì¼ í¬ê¸°</span>
                        <span style="color:#fff; font-weight:600;" id="infoFileSize">-</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:#999;">
                        <span>ì¬ìƒ ì‹œê°„</span>
                        <span style="color:#fff; font-weight:600;" id="infoDuration">ê³„ì‚° ì¤‘...</span>
                    </div>
                    <div style="display:flex; justify-content:space-between; margin-bottom:8px; color:#999;">
                        <span>ë³€í™˜ ìœ í˜•</span>
                        <span style="color:#fff; font-weight:600;" id="infoType">TL3 (ì˜¤ë””ì˜¤)</span>
                    </div>
                    <div style="margin-top:12px; text-align:center;">
                        <span style="background:#8a2be2; color:white; padding:4px 12px; border-radius:999px; font-size:12px; font-weight:600;" id="durationBadge">-</span>
                    </div>
                </div>

                <div class="form-group">
                    <label>ğŸ“ ì œëª©</label>
                    <input type="text" id="fileTitle" placeholder="íŒŒì¼ ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>

                <div class="form-group">
                    <label>ğŸ¤ ì°½ì‘ì ì´ë¦„</label>
                    <input type="text" id="fileCreator" value="Global Investor" placeholder="ì°½ì‘ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”">
                </div>
                
                <div class="form-group">
                    <label>ğŸ¤– AI ì°½ì‘ íˆ´ (ì¸ì¦)</label>
                    <select id="creatorTool">
                        <option value="suno">ğŸµ Suno AI (ìë™ ì¸ì¦)</option>
                        <option value="udio">ğŸµ Udio AI (ìë™ ì¸ì¦)</option>
                        <option value="custom">ğŸ¹ ì§ì ‘ ì‘ê³¡ (ìˆ˜ë™ ê²€í† )</option>
                    </select>
                </div>

                <div class="form-group">
                    <label>ğŸ¼ ì¥ë¥´</label>
                    <select id="fileGenre">
                        <option value="pop">ğŸ¤ Pop</option>
                        <option value="rock">ğŸ¸ Rock</option>
                        <option value="hiphop">ğŸ§ Hip Hop</option>
                        <option value="jazz">ğŸº Jazz</option>
                        <option value="classic">ğŸ» Classic</option>
                        <option value="edm">ğŸ’¿ EDM</option>
                        <option value="kpop">ğŸ‡°ğŸ‡· K-Pop</option>
                        <option value="indie">ğŸ¹ Indie</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ğŸ˜Œ ëŠë‚Œ (AI DJ íë ˆì´ì…˜)</label>
                    <select id="fileMood">
                        <option value="energetic">ğŸ”¥ Energetic - ì—ë„ˆì§€ ë„˜ì¹˜ëŠ”</option>
                        <option value="chill">ğŸ˜Œ Chill - í¸ì•ˆí•œ</option>
                        <option value="focus">ğŸ¯ Focus - ì§‘ì¤‘ë ¥</option>
                        <option value="workout">ğŸ’ª Workout - ìš´ë™</option>
                        <option value="romantic">ğŸ’• Romantic - ë¡œë§¨í‹±</option>
                        <option value="sad">ğŸ˜¢ Sad - ìŠ¬í”ˆ</option>
                        <option value="happy">ğŸ˜Š Happy - í–‰ë³µí•œ</option>
                        <option value="sleep">ğŸ˜´ Sleep - ìˆ˜ë©´</option>
                    </select>
                </div>
                
                <div class="form-group">
                    <label>ğŸ“ ì„¤ëª…</label>
                    <textarea id="fileDesc" rows="3" placeholder="íŒŒì¼ì— ëŒ€í•œ ì„¤ëª…ì„ ì…ë ¥í•˜ì„¸ìš”"></textarea>
                </div>
                
                <div class="form-group">
                    <label>ğŸ’° ìˆ˜ìµ ê³„ì•½</label>
                    <select id="revenue">
                        <option value="55">5:5 (ì°½ì‘ì 50% / í”Œë«í¼ 50%)</option>
                        <option value="73">7:3 (ì°½ì‘ì 70% / í”Œë«í¼ 30%)</option>
                    </select>
                </div>
                
                <button class="btn btn-play" onclick="App.convert()" style="width:100%; padding:18px; font-size:1.1rem;">
                    âœ¨ TL íŒŒì¼ë¡œ ë³€í™˜í•˜ê¸°
                </button>
            </div>
        </div>
    </div>

    <!-- My Files -->
    <div id="tabMyfiles" class="tab-content">
        <div class="card">
            <h2>ğŸµ My Files</h2>
            <div id="myFilesList" class="grid"></div>
        </div>
    </div>

    <!-- Share Place -->
    <div id="tabShare" class="tab-content">
        <div class="card">
            <h2>ğŸ”„ Share Place</h2>
            
            <div class="search-box">
                <span style="font-size:1.2rem;">ğŸ”</span>
                <input type="text" placeholder="ê²€ìƒ‰..." onkeyup="App.searchShare()">
            </div>
            
            <div class="genre-filter">
                <button class="genre-btn active" onclick="App.filterGenre('all')">ì „ì²´</button>
                <button class="genre-btn" onclick="App.filterGenre('pop')">ğŸ¤ Pop</button>
                <button class="genre-btn" onclick="App.filterGenre('rock')">ğŸ¸ Rock</button>
                <button class="genre-btn" onclick="App.filterGenre('hiphop')">ğŸ§ Hip Hop</button>
                <button class="genre-btn" onclick="App.filterGenre('jazz')">ğŸº Jazz</button>
                <button class="genre-btn" onclick="App.filterGenre('classic')">ğŸ» Classic</button>
                <button class="genre-btn" onclick="App.filterGenre('edm')">ğŸ’¿ EDM</button>
                <button class="genre-btn" onclick="App.filterGenre('kpop')">ğŸ‡°ğŸ‡· K-Pop</button>
                <button class="genre-btn" onclick="App.filterGenre('indie')">ğŸ¹ Indie</button>
            </div>
            
            <div id="sharePlaceContent"></div>
        </div>
    </div>

    <!-- Radio -->
    <div id="tabRadio" class="tab-content">
        <div class="card">
            <h2>ğŸ“» Radio</h2>
            <p style="color:#999;">24/7 ìë™ ì¬ìƒ ë¼ë””ì˜¤ (í–¥í›„ êµ¬í˜„)</p>
        </div>
    </div>

    <!-- Commercial -->
    <div id="tabCommercial" class="tab-content">
        <div class="card">
            <h2>ğŸ“º Commercial</h2>
            <p style="color:#999;">ê´‘ê³  ì‚½ì… ì‹œìŠ¤í…œ (í–¥í›„ êµ¬í˜„)</p>
        </div>
    </div>

    <!-- Car & Walk -->
    <div id="tabCar" class="tab-content">
        <div class="card">
            <h2>ğŸš—ğŸš¶ Car & Walk</h2>
            <p style="color:#999;">ì´ë™ ì¤‘ ì²­ì·¨ ë³´ìƒ (í–¥í›„ êµ¬í˜„)</p>
        </div>
    </div>

    <!-- Mining -->
    <div id="tabMining" class="tab-content">
        <div class="card">
            <h2>â›ï¸ Mining</h2>
            
            <div class="panel">
                <strong>ê¸°ì—¬ ì§€ìˆ˜ (CI)</strong><br>
                <span style="font-size:2rem; font-weight:800;" id="ciValue">1.00x</span>
            </div>
            
            <div class="form-group">
                <label>ì±„êµ´í•  TL (ìµœëŒ€: <span id="miningMax">5000</span> TL)</label>
                <input type="number" id="miningAmount" value="100" min="1">
            </div>
            
            <button class="btn btn-play" onclick="App.mine()" style="width:100%; padding:18px;">
                â›ï¸ TLC ì±„êµ´ ì‹œì‘
            </button>
            
            <div style="margin-top:20px; color:#999; font-size:14px; line-height:1.6;">
                <p>â€¢ TLì˜ ìµœëŒ€ 50%ë¥¼ TLCë¡œ ì±„êµ´ ê°€ëŠ¥</p>
                <p>â€¢ 100 TL = 1 TLC Ã— CI (ê¸°ì—¬ì§€ìˆ˜)</p>
                <p>â€¢ í”Œë«í¼ ìˆ˜ìˆ˜ë£Œ 10% (ê¸ˆ êµ¬ë§¤ì— ì‚¬ìš©)</p>
            </div>
        </div>
    </div>

    <!-- Lecture -->
    <div id="tabLecture" class="tab-content">
        <div class="card">
            <h2>ğŸ“š Lecture</h2>
            <p style="color:#999;">êµìœ¡ ì½˜í…ì¸  ì‹œìŠ¤í…œ (í–¥í›„ êµ¬í˜„)</p>
        </div>
    </div>

    <!-- Gold -->
    <div id="tabGold" class="tab-content">
        <div class="card">
            <h2>ğŸ† Gold Reserve</h2>
            
            <div class="panel">
                <strong>ë³´ìœ  ê¸ˆ</strong><br>
                <span style="font-size:2rem; font-weight:800;" id="goldAmount">0.0000 g</span>
            </div>
            
            <div style="margin-top:20px; color:#999; font-size:14px; line-height:1.6;">
                <p>â€¢ í”Œë«í¼ ìˆ˜ìµì˜ 10%ë¡œ ê¸ˆ êµ¬ë§¤</p>
                <p>â€¢ TLC ê°€ì¹˜ ì•ˆì •í™” ë©”ì»¤ë‹ˆì¦˜</p>
                <p>â€¢ ì‹¤ë¬¼ ìì‚° ë‹´ë³´</p>
            </div>
        </div>
    </div>

    <!-- TON -->
    <div id="tabTon" class="tab-content">
        <div class="card">
            <h2>â¬¡ TON Blockchain</h2>
            <p style="color:#999; margin-bottom:20px;">TLC ì½”ì¸ì„ TON ë¸”ë¡ì²´ì¸ìœ¼ë¡œ ì „ì†¡í•˜ê±°ë‚˜ ì…ê¸ˆí•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.</p>
            
            <div class="form-group">
                <label>ì§€ê°‘ ì£¼ì†Œ</label>
                <input type="text" placeholder="TON ì§€ê°‘ ì£¼ì†Œë¥¼ ì…ë ¥í•˜ì„¸ìš”">
            </div>
            
            <div class="form-group">
                <label>ì „ì†¡ TLC</label>
                <input type="number" placeholder="0.00" step="0.01">
            </div>
            
            <button class="btn btn-play" style="width:100%; padding:18px;">
                â¬¡ TONìœ¼ë¡œ ì „ì†¡
            </button>
            
            <div style="margin-top:20px; color:#999; font-size:14px; line-height:1.6;">
                <p>â€¢ TLCëŠ” TON ë¸”ë¡ì²´ì¸ ê¸°ë°˜ í† í°</p>
                <p>â€¢ ì‹¤ì‹œê°„ ë¸”ë¡ì²´ì¸ ì „ì†¡ ê°€ëŠ¥</p>
                <p>â€¢ ê±°ë˜ì†Œ ìƒì¥ ì¤€ë¹„ ì¤‘</p>
            </div>
        </div>
    </div>

</div>

</div>

<script>
// ==================== INDEXEDDB HELPER ====================
const DB = {
    dbName: 'TimeLinkDB',
    storeName: 'files',
    db: null,
    blobUrls: {}, // Blob URL ìºì‹œ

    // IndexedDB ì™„ì „ ì´ˆê¸°í™”
    async reset() {
        console.log('ğŸ”„ IndexedDB ì™„ì „ ì´ˆê¸°í™” ì¤‘...');
        
        // ê¸°ì¡´ DB ë‹«ê¸°
        if (this.db) {
            this.db.close();
            this.db = null;
        }
        
        // Blob URL ëª¨ë‘ í•´ì œ
        this.revokeAllBlobUrls();
        
        // DB ì‚­ì œ
        return new Promise((resolve, reject) => {
            const request = indexedDB.deleteDatabase(this.dbName);
            request.onsuccess = () => {
                console.log('âœ… IndexedDB ì‚­ì œ ì™„ë£Œ');
                resolve();
            };
            request.onerror = () => {
                console.error('âŒ IndexedDB ì‚­ì œ ì‹¤íŒ¨:', request.error);
                reject(request.error);
            };
            request.onblocked = () => {
                console.warn('âš ï¸ IndexedDB ì‚­ì œê°€ ì°¨ë‹¨ë¨ - ë‹¤ë¥¸ íƒ­ì„ ë‹«ì•„ì£¼ì„¸ìš”');
            };
        });
    },

    async open() {
        return new Promise((resolve, reject) => {
            const request = indexedDB.open(this.dbName, 4); // ë²„ì „ 4ë¡œ ìƒí–¥
            
            request.onerror = () => {
                console.error('âŒ IndexedDB ì—´ê¸° ì‹¤íŒ¨:', request.error);
                reject(request.error);
            };
            
            request.onsuccess = () => {
                this.db = request.result;
                console.log('âœ… IndexedDB ì—´ê¸° ì„±ê³µ (ë²„ì „ ' + this.db.version + ')');
                resolve();
            };
            
            request.onupgradeneeded = (event) => {
                console.log('ğŸ”„ IndexedDB ì—…ê·¸ë ˆì´ë“œ ì¤‘... (ë²„ì „ ' + event.oldVersion + ' â†’ ' + event.newVersion + ')');
                const db = event.target.result;
                
                // ê¸°ì¡´ ìŠ¤í† ì–´ ì‚­ì œ (ê¹¨ë—í•˜ê²Œ ì‹œì‘)
                if (db.objectStoreNames.contains(this.storeName)) {
                    db.deleteObjectStore(this.storeName);
                    console.log('ğŸ—‘ï¸ ê¸°ì¡´ ìŠ¤í† ì–´ ì‚­ì œ');
                }
                
                // ìƒˆ ìŠ¤í† ì–´ ìƒì„±
                db.createObjectStore(this.storeName, { keyPath: 'id' });
                console.log('âœ… ìƒˆ ìŠ¤í† ì–´ ìƒì„± ì™„ë£Œ');
            };
            
            request.onblocked = () => {
                console.warn('âš ï¸ IndexedDBê°€ ì°¨ë‹¨ë˜ì—ˆìŠµë‹ˆë‹¤. ë‹¤ë¥¸ íƒ­ì„ ë‹«ì•„ì£¼ì„¸ìš”.');
            };
        });
    },

    // ArrayBufferë¡œ ì €ì¥
    async saveFile(fileData) {
        if (!this.db) await this.open();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.put(fileData);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },

    // ArrayBuffer ê°€ì ¸ì˜¤ê¸°
    async getFile(id) {
        if (!this.db) await this.open();
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readonly');
            const store = transaction.objectStore(this.storeName);
            const request = store.get(id);
            request.onsuccess = () => resolve(request.result);
            request.onerror = () => reject(request.error);
        });
    },

    async deleteFile(id) {
        if (!this.db) await this.open();
        
        // Blob URL í•´ì œ
        if (this.blobUrls[id]) {
            URL.revokeObjectURL(this.blobUrls[id]);
            delete this.blobUrls[id];
        }
        
        return new Promise((resolve, reject) => {
            const transaction = this.db.transaction([this.storeName], 'readwrite');
            const store = transaction.objectStore(this.storeName);
            const request = store.delete(id);
            request.onsuccess = () => resolve();
            request.onerror = () => reject(request.error);
        });
    },

    // ArrayBufferë¥¼ Blob URLë¡œ ë³€í™˜
    async getBlobUrl(id, mimeType) {
        // ìºì‹œëœ URLì´ ìˆìœ¼ë©´ ì¬ì‚¬ìš©
        if (this.blobUrls[id]) {
            console.log('âœ… ìºì‹œëœ Blob URL ì‚¬ìš©:', id);
            return this.blobUrls[id];
        }
        
        const fileData = await this.getFile(id);
        if (!fileData) {
            throw new Error('íŒŒì¼ ë°ì´í„°ë¥¼ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
        }
        
        if (!fileData.arrayBuffer) {
            throw new Error('íŒŒì¼ í˜•ì‹ì´ ì˜¬ë°”ë¥´ì§€ ì•ŠìŠµë‹ˆë‹¤. ë°ì´í„°ë² ì´ìŠ¤ë¥¼ ë¦¬ì…‹í•˜ê³  íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
        }
        
        console.log('âœ… ArrayBuffer í˜•ì‹ í™•ì¸:', {
            id: id,
            bufferSize: fileData.arrayBuffer.byteLength,
            mimeType: mimeType
        });
        
        const blob = new Blob([fileData.arrayBuffer], { type: mimeType });
        const blobUrl = URL.createObjectURL(blob);
        
        // ìºì‹œì— ì €ì¥
        this.blobUrls[id] = blobUrl;
        
        console.log('âœ… Blob URL ìƒì„± ì™„ë£Œ:', {
            id: id,
            blobUrl: blobUrl,
            blobSize: blob.size
        });
        
        return blobUrl;
    },

    // ëª¨ë“  Blob URL í•´ì œ
    revokeAllBlobUrls() {
        Object.values(this.blobUrls).forEach(url => URL.revokeObjectURL(url));
        this.blobUrls = {};
    }
};

// ==================== USER AUTHENTICATION SYSTEM ====================
const Auth = {
    currentUser: null,

    async init() {
        try {
            await DB.open();
        } catch (error) {
            console.error('âŒ IndexedDB ì—´ê¸° ì˜¤ë¥˜:', error);
            
            // ë²„ì „ ì˜¤ë¥˜ì¸ ê²½ìš° ì™„ì „ ì´ˆê¸°í™”
            if (error.name === 'VersionError') {
                console.log('ğŸ”„ ë²„ì „ ì¶©ëŒ ê°ì§€ - IndexedDB ì´ˆê¸°í™” ì¤‘...');
                await DB.reset();
                await DB.open();
                console.log('âœ… IndexedDB ì´ˆê¸°í™” ì™„ë£Œ');
            } else {
                throw error;
            }
        }
        
        console.log('ğŸ”„ TimeLink ì´ˆê¸°í™” ì¤‘...');
        
        const savedUser = localStorage.getItem('timelink_current_user');
        if (savedUser) {
            this.currentUser = JSON.parse(savedUser);
            await App.loadUserData();
            this.showMainApp();
        } else {
            this.showLoginScreen();
        }
    },

    showLoginScreen() {
        document.getElementById('authScreen').style.display = 'flex';
        document.getElementById('mainApp').style.display = 'none';
    },

    showMainApp() {
        document.getElementById('authScreen').style.display = 'none';
        document.getElementById('mainApp').style.display = 'block';
        document.getElementById('userName').textContent = this.currentUser.name;
        App.updateAll();
    },

    async register() {
        const name = document.getElementById('regName').value.trim();
        const email = document.getElementById('regEmail').value.trim().toLowerCase();
        const password = document.getElementById('regPassword').value;

        if (!name || !email || !password) {
            this.showAuthMessage('ëª¨ë“  í•„ë“œë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
            return;
        }

        if (password.length < 6) {
            this.showAuthMessage('ë¹„ë°€ë²ˆí˜¸ëŠ” ìµœì†Œ 6ì ì´ìƒì´ì–´ì•¼ í•©ë‹ˆë‹¤', 'error');
            return;
        }

        const users = this.getAllUsers();
        if (users[email]) {
            this.showAuthMessage('ì´ë¯¸ ì¡´ì¬í•˜ëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤', 'error');
            return;
        }

        const newUser = {
            name,
            email,
            password,
            createdAt: Date.now(),
            wallet: { tl: 10000, tlc: 0 },
            files: [],
            gold: 0
        };

        users[email] = newUser;
        localStorage.setItem('timelink_users', JSON.stringify(users));

        this.currentUser = newUser;
        localStorage.setItem('timelink_current_user', JSON.stringify(newUser));
        this.showMainApp();
        App.toast('âœ… íšŒì›ê°€ì… ì™„ë£Œ! ìë™ ë¡œê·¸ì¸ë˜ì—ˆìŠµë‹ˆë‹¤.');
    },

    async login() {
        const email = document.getElementById('loginEmail').value.trim().toLowerCase();
        const password = document.getElementById('loginPassword').value;

        if (!email || !password) {
            this.showAuthMessage('ì´ë©”ì¼ê³¼ ë¹„ë°€ë²ˆí˜¸ë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error');
            return;
        }

        const users = this.getAllUsers();
        const user = users[email];

        if (!user) {
            this.showAuthMessage('ì¡´ì¬í•˜ì§€ ì•ŠëŠ” ì´ë©”ì¼ì…ë‹ˆë‹¤', 'error');
            return;
        }

        if (user.password !== password) {
            this.showAuthMessage('ë¹„ë°€ë²ˆí˜¸ê°€ ì¼ì¹˜í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤', 'error');
            return;
        }

        this.currentUser = user;
        localStorage.setItem('timelink_current_user', JSON.stringify(user));

        await App.loadUserData();
        this.showAuthMessage('âœ… ë¡œê·¸ì¸ ì„±ê³µ!', 'success');
        
        setTimeout(() => {
            this.showMainApp();
        }, 500);
    },

    async logout() {
        if (confirm('ë¡œê·¸ì•„ì›ƒ í•˜ì‹œê² ìŠµë‹ˆê¹Œ?\n\nëª¨ë“  ì—…ë¡œë“œëœ íŒŒì¼ ë°ì´í„°ë„ ì‚­ì œë©ë‹ˆë‹¤.')) {
            await this.saveUserData();
            
            // IndexedDB ì™„ì „ ì´ˆê¸°í™”
            try {
                await DB.reset();
                console.log('âœ… IndexedDB ì´ˆê¸°í™” ì™„ë£Œ');
            } catch (error) {
                console.error('âš ï¸ IndexedDB ì´ˆê¸°í™” ì˜¤ë¥˜:', error);
            }
            
            // ë‹¤ì‹œ ì—´ê¸°
            await DB.open();
            
            localStorage.removeItem('timelink_current_user');
            this.currentUser = null;
            
            App.wallet = { tl: 0, tlc: 0 };
            App.files = [];
            App.gold = 0;
            
            this.showLoginScreen();
            App.toast('ë¡œê·¸ì•„ì›ƒ ë˜ì—ˆìŠµë‹ˆë‹¤');
        }
    },

    getAllUsers() {
        const usersData = localStorage.getItem('timelink_users');
        return usersData ? JSON.parse(usersData) : {};
    },

    async saveUserData() {
        if (!this.currentUser) return;

        const users = this.getAllUsers();
        const userCopy = { ...this.currentUser };
        userCopy.files = App.files.map(f => {
            const { url, ...meta } = f;
            return meta;
        });
        userCopy.wallet = App.wallet;
        userCopy.gold = App.gold;
        users[this.currentUser.email] = userCopy;
        localStorage.setItem('timelink_users', JSON.stringify(users));
        localStorage.setItem('timelink_current_user', JSON.stringify(userCopy));
    },

    switchAuthMode(mode) {
        document.getElementById('loginForm').style.display = mode === 'login' ? 'block' : 'none';
        document.getElementById('registerForm').style.display = mode === 'register' ? 'block' : 'none';
    },

    showAuthMessage(msg, type) {
        const messageEl = document.getElementById('authMessage');
        messageEl.textContent = msg;
        messageEl.style.display = 'block';
        messageEl.style.background = type === 'success' ? 'rgba(29,185,84,0.2)' : 'rgba(255,68,68,0.2)';
        messageEl.style.color = type === 'success' ? '#1db954' : '#ff4444';
        messageEl.style.border = `1px solid ${type === 'success' ? '#1db954' : '#ff4444'}`;
        
        setTimeout(() => {
            messageEl.style.display = 'none';
        }, 3000);
    }
};

// ==================== MAIN APP ====================
const App = {
    wallet: { tl: 10000, tlc: 0 },
    files: [],
    gold: 0,
    type: 'audio',
    selectedFile: null,
    selectedFileDuration: 0,
    chargeTarget: null,
    playInterval: null,
    currentFile: null,
    currentGenre: 'all',
    ci: 1.0,

    init() {
        const fileInput = document.getElementById('fileInput');
        fileInput.addEventListener('change', (e) => {
            const file = e.target.files[0];
            if (!file) return;
            
            if (!file.type.startsWith('audio/') && !file.type.startsWith('video/')) {
                App.toast('ì˜¤ë””ì˜¤ ë˜ëŠ” ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ì—…ë¡œë“œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
                e.target.value = '';
                return;
            }
            
            App.selectedFile = file;
            
            document.getElementById('infoFileName').textContent = file.name;
            document.getElementById('infoFileSize').textContent = (file.size / 1024 / 1024).toFixed(2) + ' MB';
            document.getElementById('infoType').textContent = App.type === 'audio' ? 'TL3 (ì˜¤ë””ì˜¤)' : 'TL4 (ë¹„ë””ì˜¤)';
            document.getElementById('infoDuration').textContent = 'ê³„ì‚° ì¤‘...';
            document.getElementById('durationBadge').textContent = 'â±ï¸ ê³„ì‚° ì¤‘';
            
            if (file.type.startsWith('audio/')) {
                const audio = new Audio();
                audio.src = URL.createObjectURL(file);
                audio.onloadedmetadata = function() {
                    const duration = Math.floor(audio.duration);
                    App.selectedFileDuration = duration;
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    document.getElementById('infoDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')} (${duration}ì´ˆ)`;
                    document.getElementById('durationBadge').textContent = `â±ï¸ ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    URL.revokeObjectURL(audio.src);
                };
                audio.onerror = function() {
                    document.getElementById('infoDuration').textContent = 'ê¸¸ì´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                    document.getElementById('durationBadge').textContent = 'â±ï¸ --:--';
                    App.selectedFileDuration = 180;
                };
            } else if (file.type.startsWith('video/')) {
                const video = document.createElement('video');
                video.preload = 'metadata';
                video.src = URL.createObjectURL(file);
                video.onloadedmetadata = function() {
                    const duration = Math.floor(video.duration);
                    App.selectedFileDuration = duration;
                    const minutes = Math.floor(duration / 60);
                    const seconds = duration % 60;
                    document.getElementById('infoDuration').textContent = `${minutes}:${seconds.toString().padStart(2, '0')} (${duration}ì´ˆ)`;
                    document.getElementById('durationBadge').textContent = `â±ï¸ ${minutes}:${seconds.toString().padStart(2, '0')}`;
                    URL.revokeObjectURL(video.src);
                };
                video.onerror = function() {
                    document.getElementById('infoDuration').textContent = 'ê¸¸ì´ë¥¼ í™•ì¸í•  ìˆ˜ ì—†ìŠµë‹ˆë‹¤';
                    document.getElementById('durationBadge').textContent = 'â±ï¸ --:--';
                    App.selectedFileDuration = 180;
                };
            }
            
            document.getElementById('uploadForm').style.display = 'block';
            document.getElementById('fileTitle').value = file.name.replace(/\.[^/.]+$/, '');
            
            App.toast(`íŒŒì¼ ì„ íƒ ì™„ë£Œ: ${file.name}`);
        });

        setInterval(() => {
            App.ci = 1.0 + Math.random();
            const ciEl = document.getElementById('ciValue');
            if (ciEl) ciEl.textContent = App.ci.toFixed(2) + 'x';
        }, 3000);

        App.updateAll();
    },

    async loadUserData() {
        if (!Auth.currentUser) return;
        
        this.wallet = Auth.currentUser.wallet || { tl: 10000, tlc: 0 };
        this.gold = Auth.currentUser.gold || 0;
        
        // ë©”íƒ€ë°ì´í„°ë§Œ ë¡œë“œ (ì¬ìƒ ì‹œ Blob URL ë™ì  ìƒì„±)
        const metaFiles = Auth.currentUser.files || [];
        this.files = [...metaFiles];
        
        console.log('âœ… ì‚¬ìš©ì ë°ì´í„° ë¡œë“œ ì™„ë£Œ:', {
            files: this.files.length,
            tl: this.wallet.tl,
            tlc: this.wallet.tlc
        });
        
        this.updateAll();
    },

    selectType(type) {
        this.type = type;
        document.getElementById('audioCard').classList.toggle('selected', type === 'audio');
        document.getElementById('videoCard').classList.toggle('selected', type === 'video');
        
        const icons = { audio: 'ğŸµ', video: 'ğŸ¬' };
        const titles = { audio: 'íŒŒì¼ ì„ íƒí•˜ê¸°', video: 'ë¹„ë””ì˜¤ ì„ íƒí•˜ê¸°' };
        const descs = { audio: 'MP3, WAV, FLAC', video: 'MP4, MOV, AVI' };
        
        document.getElementById('uploadIcon').textContent = icons[type];
        document.getElementById('uploadTitle').textContent = titles[type];
        document.getElementById('uploadDesc').textContent = descs[type];
        document.getElementById('fileInput').accept = type === 'audio' ? 'audio/*' : 'video/*';
    },

    async convert() {
        if (!this.selectedFile) return this.toast('íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”');
        
        const title = document.getElementById('fileTitle').value.trim();
        const creator = document.getElementById('fileCreator').value.trim();
        const tool = document.getElementById('creatorTool').value;
        const genre = document.getElementById('fileGenre').value;
        const mood = document.getElementById('fileMood').value;
        const desc = document.getElementById('fileDesc').value;
        const revenue = document.getElementById('revenue').value;
        
        if (!title) return this.toast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”');
        if (!creator) return this.toast('ì°½ì‘ì ì´ë¦„ì„ ì…ë ¥í•˜ì„¸ìš”');
        
        const isVideo = this.selectedFile.type.startsWith('video');
        const isAudio = this.selectedFile.type.startsWith('audio');
        
        if (!isVideo && !isAudio) {
            return this.toast('ì˜¤ë””ì˜¤ ë˜ëŠ” ë¹„ë””ì˜¤ íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤');
        }
        
        const fileSizeMB = (this.selectedFile.size / 1024 / 1024).toFixed(1);
        
        const certified = tool === 'suno' || tool === 'udio';
        
        this.toast('â³ íŒŒì¼ ë³€í™˜ ì¤‘... ì ì‹œë§Œ ê¸°ë‹¤ë ¤ì£¼ì„¸ìš” (íŒŒì¼ í¬ê¸°: ' + fileSizeMB + 'MB)');
        
        const reader = new FileReader();
        
        reader.onload = async (e) => {
            try {
                const arrayBuffer = e.target.result;
                
                if (!arrayBuffer) {
                    throw new Error('íŒŒì¼ì„ ì½ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
                }
                
                console.log('âœ… íŒŒì¼ ì½ê¸° ì„±ê³µ:', {
                    title,
                    type: this.selectedFile.type,
                    size: fileSizeMB + 'MB',
                    bufferSize: arrayBuffer.byteLength
                });
                
                const newFile = {
                    id: Date.now(),
                    title,
                    creator,
                    tool,
                    genre,
                    mood,
                    desc,
                    type: isVideo ? 'TL4' : 'TL3',
                    fileType: isVideo ? 'video' : 'audio',
                    mimeType: this.selectedFile.type,
                    certified,
                    revenue,
                    balance: 0,
                    duration: this.selectedFileDuration || 0,
                    fileSizeMB: fileSizeMB,
                    shared: false,
                    createdAt: new Date().toISOString()
                };
                
                // IndexedDBì— ArrayBufferë¡œ ì €ì¥
                await DB.saveFile({ 
                    id: newFile.id, 
                    arrayBuffer: arrayBuffer,
                    mimeType: this.selectedFile.type
                });
                console.log('âœ… IndexedDB ì €ì¥ ì™„ë£Œ');
                
                // ë©”ëª¨ë¦¬ì— ë©”íƒ€ë°ì´í„°ë§Œ ì¶”ê°€ (ArrayBufferëŠ” ì œì™¸)
                this.files.push(newFile);
                
                // localStorageì— ë©”íƒ€ë°ì´í„° ì €ì¥
                await Auth.saveUserData();
                console.log('âœ… ë©”íƒ€ë°ì´í„° ì €ì¥ ì™„ë£Œ');
                
                this.toast(`âœ… ${newFile.type} ë³€í™˜ ì™„ë£Œ! (${fileSizeMB}MB)` + (certified ? ' (ìë™ ì¸ì¦)' : ''));
                
                // í¼ ì´ˆê¸°í™”
                document.getElementById('uploadForm').style.display = 'none';
                document.getElementById('fileInput').value = '';
                this.selectedFile = null;
                this.selectedFileDuration = 0;
                
                // My Files íƒ­ìœ¼ë¡œ ì´ë™
                this.switchTab('myfiles');
                this.updateAll();
                
            } catch (error) {
                console.error('âŒ ë³€í™˜ ì¤‘ ì˜¤ë¥˜:', error);
                this.toast('íŒŒì¼ ë³€í™˜ ì¤‘ ì˜¤ë¥˜: ' + error.message);
            }
        };
        
        reader.onerror = (e) => {
            console.error('âŒ íŒŒì¼ ì½ê¸° ì˜¤ë¥˜:', e);
            this.toast('íŒŒì¼ ì½ê¸° ì˜¤ë¥˜ê°€ ë°œìƒí–ˆìŠµë‹ˆë‹¤');
        };
        
        // ArrayBufferë¡œ ì½ê¸° (Data URL ëŒ€ì‹ )
        reader.readAsArrayBuffer(this.selectedFile);
    },

    renderMyFiles() {
        const el = document.getElementById('myFilesList');
        if (this.files.length === 0) {
            el.innerHTML = '<div style="text-align:center;padding:60px;color:#666">ğŸ“ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }
        
        const genreEmoji = {pop:'ğŸ¤',rock:'ğŸ¸',hiphop:'ğŸ§',jazz:'ğŸº',classic:'ğŸ»',edm:'ğŸ’¿',kpop:'ğŸ‡°ğŸ‡·',indie:'ğŸ¹'};
        const genreColor = {pop:'#ff6b6b',rock:'#4ecdc4',hiphop:'#ffd93d',jazz:'#a8e6cf',classic:'#b39eb5',edm:'#ff8a5c',kpop:'#ff1493',indie:'#9370db'};
        
        el.innerHTML = this.files.map(f => `
            <div class="file-card">
                <div class="thumb ${f.fileType}">
                    <div style="font-size:4rem">${f.type==='TL4'?'ğŸ¬':'ğŸµ'}</div>
                    <span class="badge badge-type">${f.type}</span>
                    ${f.certified?'<span class="badge badge-cert">âœ“ ì¸ì¦</span>':''}
                    <span class="badge badge-genre" style="background:${genreColor[f.genre]||'#666'}">${genreEmoji[f.genre]||'ğŸµ'}</span>
                </div>
                <div class="info">
                    <div class="name">${f.title}</div>
                    <div class="creator">${f.creator} Â· ${f.tool}</div>
                    <div class="panel">
                        <strong>â³ TL Balance</strong><br>
                        <span style="font-size:1.6rem;font-weight:800;">${f.balance.toLocaleString()}</span> TL
                    </div>
                    <div class="actions">
                        ${f.balance > 0 ?
                            `<button class="btn btn-play" onclick="App.play(${f.id})">â–¶ï¸ ì¬ìƒ</button>` :
                            `<button class="btn btn-disabled" disabled>âš ï¸ TL ì¶©ì „ í•„ìš”</button>`
                        }
                        <button class="btn btn-charge" onclick="App.openCharge(${f.id})">ğŸ’° ì¶©ì „</button>
                        ${!f.shared?
                            `<button class="btn btn-share" onclick="App.share(${f.id})">ğŸ”„ ê³µìœ </button>`:
                            `<button class="btn" style="background:#555;color:#999;" disabled>âœ“ ê³µìœ ë¨</button>`
                        }
                    </div>
                </div>
            </div>
        `).join('');
    },

    renderSharePlace() {
        const el = document.getElementById('sharePlaceContent');
        const sharedFiles = this.files.filter(f => f.shared);
        
        if (sharedFiles.length === 0) {
            el.innerHTML = '<div style="text-align:center;padding:60px;color:#666">ğŸ”„ ê³µìœ ëœ íŒŒì¼ì´ ì—†ìŠµë‹ˆë‹¤</div>';
            return;
        }
        
        let filtered = sharedFiles;
        if (this.currentGenre !== 'all') {
            filtered = filtered.filter(f => f.genre === this.currentGenre);
        }
        
        const moods = {
            energetic: 'ğŸ”¥ Energetic',
            chill: 'ğŸ˜Œ Chill',
            focus: 'ğŸ¯ Focus',
            workout: 'ğŸ’ª Workout',
            romantic: 'ğŸ’• Romantic',
            sad: 'ğŸ˜¢ Sad',
            happy: 'ğŸ˜Š Happy',
            sleep: 'ğŸ˜´ Sleep'
        };
        
        const genreEmoji = {pop:'ğŸ¤',rock:'ğŸ¸',hiphop:'ğŸ§',jazz:'ğŸº',classic:'ğŸ»',edm:'ğŸ’¿',kpop:'ğŸ‡°ğŸ‡·',indie:'ğŸ¹'};
        const genreColor = {pop:'#ff6b6b',rock:'#4ecdc4',hiphop:'#ffd93d',jazz:'#a8e6cf',classic:'#b39eb5',edm:'#ff8a5c',kpop:'#ff1493',indie:'#9370db'};
        
        let html = '';
        Object.keys(moods).forEach(mood => {
            const moodFiles = filtered.filter(f => f.mood === mood);
            if (moodFiles.length === 0) return;
            
            html += `
                <div style="margin-bottom:40px;">
                    <h3 style="margin-bottom:20px; font-size:1.4rem;">${moods[mood]}</h3>
                    <div class="grid">
                        ${moodFiles.map(f => `
                            <div class="file-card" onclick="App.listenShared(${f.id})">
                                <div class="thumb ${f.fileType}">
                                    <div style="font-size:4rem">${f.type==='TL4'?'ğŸ¬':'ğŸµ'}</div>
                                    <span class="badge badge-type">${f.type}</span>
                                    <span class="badge badge-genre" style="background:${genreColor[f.genre]||'#666'}">${genreEmoji[f.genre]||'ğŸµ'}</span>
                                </div>
                                <div class="info">
                                    <div class="name">${f.title}</div>
                                    <div class="creator">${f.creator}</div>
                                    <div class="panel">
                                        <strong>ìˆ˜ìµ ê³„ì•½</strong><br>
                                        ${f.revenue==='55'?'ì°½ì‘ì 50% / í”Œë«í¼ 50%':'ì°½ì‘ì 70% / í”Œë«í¼ 30%'}
                                    </div>
                                    <button class="btn btn-play" onclick="event.stopPropagation(); App.listenShared(${f.id})" style="width:100%;">
                                        ğŸ§ ì²­ì·¨ (1 TL/sec)
                                    </button>
                                </div>
                            </div>
                        `).join('')}
                    </div>
                </div>
            `;
        });
        
        el.innerHTML = html;
    },

    openCharge(id) {
        const file = this.files.find(f => f.id === id);
        if (!file) return this.toast('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        if (this.wallet.tl <= 0) return this.toast('ë³´ìœ  TLì´ ì—†ìŠµë‹ˆë‹¤');
        
        this.chargeTarget = id;
        const chargeInput = document.getElementById('chargeAmount');
        chargeInput.value = Math.min(1000, this.wallet.tl);
        chargeInput.max = this.wallet.tl;
        document.getElementById('chargeModal').style.display = 'flex';
    },

    async executeCharge() {
        if (!this.chargeTarget) {
            this.toast('ì¶©ì „ ëŒ€ìƒì´ ì—†ìŠµë‹ˆë‹¤');
            this.closeModal();
            return;
        }

        const file = this.files.find(f => f.id === this.chargeTarget);
        if (!file) {
            this.toast('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
            this.closeModal();
            return;
        }

        const amtInput = document.getElementById('chargeAmount');
        let amt = parseInt(amtInput.value);
        if (isNaN(amt) || amt <= 0) {
            this.toast('ì˜¬ë°”ë¥¸ ê¸ˆì•¡ì„ ì…ë ¥í•˜ì„¸ìš”');
            return;
        }

        if (amt > this.wallet.tl) {
            this.toast(`TLì´ ë¶€ì¡±í•©ë‹ˆë‹¤ (ë³´ìœ : ${this.wallet.tl.toLocaleString()} TL)`);
            return;
        }

        this.wallet.tl -= amt;
        file.balance += amt;

        await Auth.saveUserData();
        this.updateAll();
        this.closeModal();
        this.toast(`âœ… ${amt.toLocaleString()} TL ì¶©ì „ ì™„ë£Œ!`);
    },

    async play(id) {
        const file = this.files.find(f => f.id === id);
        if (!file) {
            console.error('âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
            return this.toast('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        if (file.balance <= 0) {
            console.warn('âš ï¸ TL ì”ì•¡ ë¶€ì¡±:', file.balance);
            return this.toast('TLì„ ì¶©ì „í•˜ì„¸ìš”');
        }
        
        try {
            console.log('ğŸµ ì¬ìƒ ì¤€ë¹„ ì‹œì‘:', {
                id: file.id,
                title: file.title,
                type: file.fileType,
                mimeType: file.mimeType
            });
            
            // IndexedDBì—ì„œ ë°ì´í„° í™•ì¸
            const fileData = await DB.getFile(file.id);
            console.log('ğŸ“¦ IndexedDB ë°ì´í„° í™•ì¸:', {
                found: !!fileData,
                hasArrayBuffer: !!(fileData && fileData.arrayBuffer),
                bufferSize: fileData && fileData.arrayBuffer ? fileData.arrayBuffer.byteLength : 0
            });
            
            if (!fileData || !fileData.arrayBuffer) {
                throw new Error('IndexedDBì— íŒŒì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
            }
            
            // Blob URL ìƒì„±
            const blobUrl = await DB.getBlobUrl(file.id, file.mimeType);
            console.log('âœ… Blob URL ìƒì„± ì™„ë£Œ:', blobUrl);
            
            this.currentFile = file;
            
            if (file.fileType === 'video') {
                const video = document.createElement('video');
                video.controls = true;
                video.autoplay = true;
                video.style.cssText = 'position:fixed; top:0; left:0; width:100%; height:100vh; z-index:10000; background:black;';
                video.src = blobUrl;
                
                video.onerror = (e) => {
                    console.error('âŒ ë¹„ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜:', e, video.error);
                    this.toast('ë¹„ë””ì˜¤ ì¬ìƒ ì˜¤ë¥˜');
                    if (document.body.contains(video)) document.body.removeChild(video);
                    if (closeBtn && document.body.contains(closeBtn)) document.body.removeChild(closeBtn);
                };
                
                const closeBtn = document.createElement('button');
                closeBtn.textContent = 'âœ• ë‹«ê¸°';
                closeBtn.style.cssText = 'position:fixed; top:20px; right:20px; z-index:10001; background:#f44; color:white; border:none; border-radius:8px; padding:12px 24px; font-size:16px; font-weight:700; cursor:pointer;';
                closeBtn.onclick = () => {
                    this.stopPlay();
                    if (document.body.contains(video)) document.body.removeChild(video);
                    if (document.body.contains(closeBtn)) document.body.removeChild(closeBtn);
                };
                
                document.body.appendChild(video);
                document.body.appendChild(closeBtn);
                
                this.toast('ğŸ¬ ë¹„ë””ì˜¤ ì¬ìƒ ì¤‘');
                
                if (this.playInterval) clearInterval(this.playInterval);
                this.playInterval = setInterval(async () => {
                    if (file.balance > 0) {
                        file.balance -= 2;
                        await Auth.saveUserData();
                        if (file.balance <= 0) {
                            this.stopPlay();
                            if (document.body.contains(video)) document.body.removeChild(video);
                            if (document.body.contains(closeBtn)) document.body.removeChild(closeBtn);
                            this.toast('â¹ï¸ TL ì†Œì§„');
                        }
                    }
                }, 1000);
                
            } else {
                const audio = document.getElementById('audioPlayer');
                
                // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
                const newAudio = audio.cloneNode(true);
                audio.parentNode.replaceChild(newAudio, audio);
                
                // ìƒˆë¡œìš´ ì°¸ì¡° ê°€ì ¸ì˜¤ê¸°
                const freshAudio = document.getElementById('audioPlayer');
                
                console.log('ğŸµ ì˜¤ë””ì˜¤ ì—˜ë¦¬ë¨¼íŠ¸ ì¤€ë¹„ ì™„ë£Œ');
                
                // Blob URL ì„¤ì •
                freshAudio.src = blobUrl;
                
                document.getElementById('audioModal').style.display = 'flex';
                document.getElementById('playTitle').textContent = file.title;
                document.getElementById('playCreator').textContent = file.creator;
                document.getElementById('playTL').textContent = file.balance;
                
                // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
                let hasStartedPlaying = false;
                
                freshAudio.addEventListener('canplaythrough', function playHandler() {
                    if (hasStartedPlaying) return;
                    hasStartedPlaying = true;
                    
                    console.log('âœ… ì˜¤ë””ì˜¤ ë¡œë“œ ì™„ë£Œ - ì¬ìƒ ì‹œì‘');
                    freshAudio.play()
                        .then(() => {
                            console.log('âœ… ì¬ìƒ ì„±ê³µ');
                            App.toast(`ğŸµ ${file.title} ì¬ìƒ ì¤‘`);
                        })
                        .catch(err => {
                            console.error('âŒ ì¬ìƒ ì‹œì‘ ì˜¤ë¥˜:', err);
                            App.toast('ì¬ìƒ ì˜¤ë¥˜: ' + err.message);
                            App.stopPlay();
                        });
                }, { once: true });
                
                freshAudio.addEventListener('error', function errorHandler(e) {
                    console.error('âŒ ì˜¤ë””ì˜¤ ì˜¤ë¥˜:', {
                        error: freshAudio.error,
                        code: freshAudio.error ? freshAudio.error.code : null,
                        message: freshAudio.error ? freshAudio.error.message : null,
                        src: freshAudio.src
                    });
                    
                    let errorMsg = 'ì•Œ ìˆ˜ ì—†ëŠ” ì˜¤ë¥˜';
                    if (freshAudio.error) {
                        switch(freshAudio.error.code) {
                            case 1: errorMsg = 'MEDIA_ERR_ABORTED'; break;
                            case 2: errorMsg = 'MEDIA_ERR_NETWORK'; break;
                            case 3: errorMsg = 'MEDIA_ERR_DECODE'; break;
                            case 4: errorMsg = 'MEDIA_ERR_SRC_NOT_SUPPORTED'; break;
                        }
                    }
                    App.toast('ì˜¤ë””ì˜¤ ì˜¤ë¥˜: ' + errorMsg);
                    App.stopPlay();
                }, { once: true });
                
                console.log('ğŸµ ì˜¤ë””ì˜¤ ë¡œë“œ ì‹œì‘');
                freshAudio.load();
                
                if (this.playInterval) clearInterval(this.playInterval);
                this.playInterval = setInterval(async () => {
                    if (file.balance > 0 && !freshAudio.paused) {
                        file.balance -= 1;
                        document.getElementById('playTL').textContent = file.balance;
                        await Auth.saveUserData();
                        
                        if (file.balance <= 0) {
                            this.stopPlay();
                            this.toast('â¹ï¸ TL ì†Œì§„');
                        }
                    }
                }, 1000);
            }
        } catch (error) {
            console.error('âŒ ì¬ìƒ ì¤€ë¹„ ì˜¤ë¥˜:', error);
            this.toast('ì¬ìƒ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜: ' + error.message);
        }
    },

    async listenShared(id) {
        const file = this.files.find(f => f.id === id);
        if (!file) {
            console.error('âŒ íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŒ:', id);
            return this.toast('íŒŒì¼ì„ ì°¾ì„ ìˆ˜ ì—†ìŠµë‹ˆë‹¤');
        }
        if (this.wallet.tl <= 0) {
            console.warn('âš ï¸ TL ì”ì•¡ ë¶€ì¡±');
            return this.toast('TLì´ ë¶€ì¡±í•©ë‹ˆë‹¤');
        }
        
        try {
            console.log('ğŸ§ Share Place ì¬ìƒ ì¤€ë¹„:', {
                id: file.id,
                title: file.title,
                type: file.fileType,
                mimeType: file.mimeType
            });
            
            // IndexedDBì—ì„œ ë°ì´í„° í™•ì¸
            const fileData = await DB.getFile(file.id);
            if (!fileData || !fileData.arrayBuffer) {
                throw new Error('íŒŒì¼ ë°ì´í„°ê°€ ì—†ìŠµë‹ˆë‹¤. íŒŒì¼ì„ ë‹¤ì‹œ ì—…ë¡œë“œí•´ì£¼ì„¸ìš”.');
            }
            
            // Blob URL ìƒì„±
            const blobUrl = await DB.getBlobUrl(file.id, file.mimeType);
            console.log('âœ… Blob URL ìƒì„± ì™„ë£Œ:', blobUrl);
            
            this.currentFile = file;
            
            const audio = document.getElementById('audioPlayer');
            
            // ê¸°ì¡´ ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ ì œê±°
            const newAudio = audio.cloneNode(true);
            audio.parentNode.replaceChild(newAudio, audio);
            
            // ìƒˆë¡œìš´ ì°¸ì¡° ê°€ì ¸ì˜¤ê¸°
            const freshAudio = document.getElementById('audioPlayer');
            
            // Blob URL ì„¤ì •
            freshAudio.src = blobUrl;
            
            document.getElementById('audioModal').style.display = 'flex';
            document.getElementById('playTitle').textContent = file.title;
            document.getElementById('playCreator').textContent = file.creator + ' (Share Place)';
            document.getElementById('playTL').textContent = this.wallet.tl;
            
            // í•œ ë²ˆë§Œ ì‹¤í–‰ë˜ëŠ” ì´ë²¤íŠ¸ ë¦¬ìŠ¤ë„ˆ
            let hasStartedPlaying = false;
            
            freshAudio.addEventListener('canplaythrough', function playHandler() {
                if (hasStartedPlaying) return;
                hasStartedPlaying = true;
                
                console.log('âœ… Share Place ì˜¤ë””ì˜¤ ë¡œë“œ ì™„ë£Œ');
                freshAudio.play()
                    .then(() => {
                        console.log('âœ… Share Place ì¬ìƒ ì‹œì‘');
                    })
                    .catch(err => {
                        console.error('âŒ Share Place ì¬ìƒ ì˜¤ë¥˜:', err);
                        App.toast('ì¬ìƒ ì˜¤ë¥˜: ' + err.message);
                        App.stopPlay();
                    });
            }, { once: true });
            
            freshAudio.addEventListener('error', function errorHandler(e) {
                console.error('âŒ Share Place ì˜¤ë””ì˜¤ ì˜¤ë¥˜:', freshAudio.error);
                App.toast('ì˜¤ë””ì˜¤ ë¡œë“œ ì˜¤ë¥˜');
                App.stopPlay();
            }, { once: true });
            
            freshAudio.load();
            
            if (this.playInterval) clearInterval(this.playInterval);
            this.playInterval = setInterval(async () => {
                if (this.wallet.tl > 0 && !freshAudio.paused) {
                    const cost = file.type === 'TL4' ? 2 : 1;
                    this.wallet.tl -= cost;
                    
                    const creatorShare = file.revenue === '55' ? 0.5 : 0.7;
                    const creatorEarn = cost * creatorShare;
                    file.balance += creatorEarn;
                    
                    const platformShare = cost * (1 - creatorShare);
                    const goldPurchase = platformShare * 0.1;
                    this.gold += goldPurchase / 1000;
                    
                    document.getElementById('playTL').textContent = this.wallet.tl;
                    await Auth.saveUserData();
                    this.updateAll();
                    
                    if (this.wallet.tl <= 0) {
                        this.stopPlay();
                        this.toast('â¹ï¸ TL ì†Œì§„');
                    }
                }
            }, 1000);
        } catch (error) {
            console.error('âŒ Share Place ì¬ìƒ ì¤€ë¹„ ì˜¤ë¥˜:', error);
            this.toast('ì¬ìƒ ì¤€ë¹„ ì¤‘ ì˜¤ë¥˜: ' + error.message);
        }
    },

    stopPlay() {
        if (this.playInterval) clearInterval(this.playInterval);
        
        const audio = document.getElementById('audioPlayer');
        audio.pause();
        audio.src = '';
        
        document.getElementById('audioModal').style.display = 'none';
        this.currentFile = null;
        Auth.saveUserData();
        this.updateAll();
    },

    async share(id) {
        const file = this.files.find(f => f.id === id);
        if (!file) return;
        if (!file.certified) return this.toast('ì¸ì¦ì´ í•„ìš”í•©ë‹ˆë‹¤');
        
        file.shared = true;
        await Auth.saveUserData();
        this.toast(`ğŸ”„ ${file.title} Share Placeë¡œ ì´ë™!`);
        this.updateAll();
    },

    filterGenre(genre) {
        this.currentGenre = genre;
        document.querySelectorAll('.genre-btn').forEach(b => b.classList.remove('active'));
        event.target.classList.add('active');
        this.renderSharePlace();
    },

    searchShare() {
        // ê²€ìƒ‰ ê¸°ëŠ¥ (í–¥í›„ êµ¬í˜„)
    },

    async mine() {
        const amt = parseInt(document.getElementById('miningAmount').value) || 100;
        const max = Math.floor(this.wallet.tl * 0.5);
        
        if (amt > max) return this.toast(`í•œë„ ì´ˆê³¼! ìµœëŒ€ ${max} TL`);
        if (this.wallet.tl < amt) return this.toast('TL ë¶€ì¡±');
        
        const tlc = (amt * 0.01) * this.ci;
        this.wallet.tl -= amt;
        this.wallet.tlc += tlc;
        
        const platformFee = amt * 0.1;
        this.gold += (platformFee * 0.1) / 1000;
        
        await Auth.saveUserData();
        this.updateAll();
        this.toast(`â›ï¸ ${tlc.toFixed(2)} TLC ì±„êµ´!`);
    },

    async resetDatabase() {
        if (confirm('âš ï¸ ê²½ê³ !\n\nëª¨ë“  íŒŒì¼ ë°ì´í„°ê°€ ì‚­ì œë©ë‹ˆë‹¤.\nê³„ì†í•˜ì‹œê² ìŠµë‹ˆê¹Œ?')) {
            try {
                this.toast('ğŸ”„ ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì¤‘...');
                
                // IndexedDB ì™„ì „ ì´ˆê¸°í™”
                await DB.reset();
                await DB.open();
                
                // ë©”íƒ€ë°ì´í„°ë„ ì´ˆê¸°í™”
                this.files = [];
                await Auth.saveUserData();
                
                this.updateAll();
                this.toast('âœ… ë°ì´í„°ë² ì´ìŠ¤ ì´ˆê¸°í™” ì™„ë£Œ!');
                
                console.log('âœ… ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì…‹ ì™„ë£Œ');
            } catch (error) {
                console.error('âŒ ë°ì´í„°ë² ì´ìŠ¤ ë¦¬ì…‹ ì˜¤ë¥˜:', error);
                this.toast('ì˜¤ë¥˜: ' + error.message);
            }
        }
    },

    switchTab(name, evt) {
        document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
        document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
        
        // ì´ë²¤íŠ¸ê°€ ìˆìœ¼ë©´ í•´ë‹¹ ë²„íŠ¼ì„, ì—†ìœ¼ë©´ nameìœ¼ë¡œ ì°¾ì•„ì„œ í™œì„±í™”
        if (evt && evt.target) {
            evt.target.classList.add('active');
        } else {
            // í”„ë¡œê·¸ë˜ë°ì ìœ¼ë¡œ í˜¸ì¶œëœ ê²½ìš° í•´ë‹¹ íƒ­ ë²„íŠ¼ì„ ì°¾ì•„ì„œ í™œì„±í™”
            const tabButtons = document.querySelectorAll('.tab');
            tabButtons.forEach(btn => {
                const btnText = btn.textContent.toLowerCase();
                if (btnText.includes(name.toLowerCase()) || 
                    (name === 'myfiles' && btnText.includes('my files')) ||
                    (name === 'share' && btnText.includes('share'))) {
                    btn.classList.add('active');
                }
            });
        }
        
        document.getElementById('tab' + name.charAt(0).toUpperCase() + name.slice(1)).classList.add('active');
        
        if (name === 'myfiles') this.renderMyFiles();
        if (name === 'share') this.renderSharePlace();
        if (name === 'mining') {
            const maxEl = document.getElementById('miningMax');
            if (maxEl) maxEl.textContent = Math.floor(this.wallet.tl * 0.5).toLocaleString();
        }
    },

    closeModal() {
        document.getElementById('chargeModal').style.display = 'none';
        document.getElementById('audioModal').style.display = 'none';
        this.chargeTarget = null;
    },

    updateAll() {
        document.getElementById('walletTL').textContent = this.wallet.tl.toLocaleString();
        document.getElementById('walletTLC').textContent = this.wallet.tlc.toFixed(2);
        const goldEl = document.getElementById('goldAmount');
        if (goldEl) goldEl.textContent = this.gold.toFixed(4) + ' g';
        
        this.renderMyFiles();
        this.renderSharePlace();
    },

    toast(msg) {
        const t = document.getElementById('toast');
        t.textContent = msg;
        t.style.display = 'block';
        setTimeout(() => t.style.display = 'none', 3000);
    }
};

// ì´ˆê¸°í™”
(async () => {
    await Auth.init();
    App.init();
})();

window.addEventListener('click', (e) => {
    if (e.target.classList.contains('modal')) App.closeModal();
});

window.addEventListener('beforeunload', () => Auth.saveUserData());
</script>

</body>
</html>
