<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ì—…ë¡œë“œ - TimeLink</title>
<meta name="description" content="ë‹¹ì‹ ì˜ ìŒì•…ì„ ì—…ë¡œë“œí•˜ê³  ìˆ˜ìµì„ ë°›ìœ¼ì„¸ìš”. 1ì´ˆ ì¬ìƒ = 1 TL.">
<meta property="og:title" content="ì—…ë¡œë“œ - TimeLink">
<meta property="og:description" content="ë‹¹ì‹ ì˜ ìŒì•…ì„ ì—…ë¡œë“œí•˜ê³  ìˆ˜ìµì„ ë°›ìœ¼ì„¸ìš”. 1ì´ˆ ì¬ìƒ = 1 TL.">
<meta property="og:type" content="website">
<link rel="canonical" href="https://www.timelink.digital/create.html">
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Noto+Sans+KR:wght@400;500;700;900&display=swap" rel="stylesheet">
<style>
:root {
  --purple: #8b5cf6; --purple-dark: #7c3aed; --purple-light: #ede9fe; --purple-pale: #f5f3ff;
  --green: #10b981; --green-light: #d1fae5;
  --yellow: #f59e0b; --yellow-light: #fef3c7;
  --red: #ef4444; --red-light: #fee2e2;
  --blue: #3b82f6; --blue-light: #dbeafe;
  --gray-50: #f9fafb; --gray-100: #f3f4f6; --gray-200: #e5e7eb;
  --gray-500: #6b7280; --gray-700: #374151; --gray-900: #111827;
  --text: #0f172a; --border: #e5e7eb; --font: 'Inter','Noto Sans KR',sans-serif;
}
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:var(--font); background:#f8fafc; color:#0f172a; line-height:1.5; }

/* â”€â”€ ë„¤ë¹„ â”€â”€ */
.navbar { background:white; border-bottom:1px solid #e2e8f0; padding:0 24px; height:64px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.logo { display:flex; align-items:center; gap:10px; font-size:20px; font-weight:800; color:#0f172a; text-decoration:none; }
.logo-icon { width:32px; height:32px; background:#8b5cf6; border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-size:16px; }
.logo span { color:#8b5cf6; }
.nav-right { display:flex; align-items:center; gap:12px; }
.hidden { display:none !important; }
.btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 20px; border-radius:999px; font-weight:600; font-size:14px; cursor:pointer; transition:all .2s; border:none; text-decoration:none; }
.btn-primary { background:#8b5cf6; color:white; } .btn-primary:hover { background:#7c3aed; }
.btn-outline { background:white; color:#1f2937; border:1px solid #e5e7eb; } .btn-outline:hover { background:#f9fafb; }
.btn-sm { padding:6px 14px; font-size:13px; }
.btn:disabled { opacity:.5; cursor:not-allowed; }
.balance { background:#f3f4f6; border-radius:999px; padding:6px 16px; display:flex; align-items:center; gap:16px; }
.balance-item { display:flex; align-items:center; gap:6px; font-size:14px; }
.balance-label { color:#6b7280; font-weight:500; } .balance-value { font-weight:700; color:#8b5cf6; }
.avatar { width:36px; height:36px; background:#8b5cf6; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; cursor:pointer; position:relative; }
.dropdown { position:absolute; top:100%; right:0; margin-top:8px; background:white; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 15px -3px rgba(0,0,0,.1); width:200px; display:none; z-index:1000; }
.dropdown.show { display:block; }
.dropdown-item { padding:12px 16px; cursor:pointer; font-size:14px; color:#1f2937; text-decoration:none; display:block; }
.dropdown-item:hover { background:#f3f4f6; }
.dropdown-item.danger { color:#ef4444; }
.dropdown-divider { height:1px; background:#f3f4f6; margin:4px 0; }
.avatar-wrap { position:relative; }

/* â”€â”€ íƒ­ â”€â”€ */
.tabs { background:white; border-bottom:1px solid #e5e7eb; padding:0 24px; display:flex; justify-content:center; gap:4px; position:sticky; top:64px; z-index:90; overflow-x:auto; flex-wrap:wrap; }
.tab { padding:12px 16px; font-size:14px; font-weight:600; color:#6b7280; cursor:pointer; border-bottom:2px solid transparent; transition:all .2s; white-space:nowrap; text-decoration:none; display:inline-block; }
.tab:hover { color:#8b5cf6; } .tab.active { color:#8b5cf6; border-bottom-color:#8b5cf6; }

/* â”€â”€ ì»¨í…Œì´ë„ˆ â”€â”€ */
.container { max-width:760px; margin:0 auto; padding:40px 24px 120px; }

/* â”€â”€ í˜ì´ì§€ í—¤ë” â”€â”€ */
.page-header { text-align:center; margin-bottom:40px; }
.page-header h1 { font-size:32px; font-weight:900; margin-bottom:8px; }
.page-header p { color:#6b7280; font-size:16px; }

/* â”€â”€ ìŠ¤í… ì¸ë””ì¼€ì´í„° â”€â”€ */
.stepper { display:flex; align-items:center; justify-content:center; gap:0; margin-bottom:40px; }
.step-item { display:flex; align-items:center; }
.step-circle { width:36px; height:36px; border-radius:50%; display:flex; align-items:center; justify-content:center; font-weight:800; font-size:14px; border:2px solid #e5e7eb; background:white; color:#9ca3af; transition:all .3s; flex-shrink:0; }
.step-circle.active { background:#8b5cf6; border-color:#8b5cf6; color:white; }
.step-circle.done { background:#10b981; border-color:#10b981; color:white; }
.step-label { font-size:12px; font-weight:600; color:#9ca3af; margin-top:4px; white-space:nowrap; }
.step-label.active { color:#8b5cf6; }
.step-label.done { color:#10b981; }
.step-col { display:flex; flex-direction:column; align-items:center; gap:0; }
.step-line { width:60px; height:2px; background:#e5e7eb; margin:0 4px; margin-bottom:18px; transition:background .3s; }
.step-line.done { background:#10b981; }

/* â”€â”€ ì¹´ë“œ â”€â”€ */
.card { background:white; border-radius:20px; padding:32px; box-shadow:0 2px 8px rgba(0,0,0,.06); margin-bottom:24px; }
.card-title { font-size:20px; font-weight:800; margin-bottom:6px; display:flex; align-items:center; gap:10px; }
.card-sub { font-size:14px; color:#6b7280; margin-bottom:28px; }
.section-divider { height:1px; background:#f3f4f6; margin:24px 0; }

/* â”€â”€ í¼ â”€â”€ */
.form-group { margin-bottom:20px; }
.form-label { display:block; font-size:13px; font-weight:700; color:#374151; margin-bottom:8px; }
.form-label .req { color:#ef4444; margin-left:2px; }
.form-input { width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:12px; font-size:15px; font-family:var(--font); outline:none; transition:border-color .2s; background:white; }
.form-input:focus { border-color:#8b5cf6; }
.form-row { display:grid; grid-template-columns:1fr 1fr; gap:16px; }
.form-select { width:100%; padding:12px 16px; border:2px solid #e5e7eb; border-radius:12px; font-size:15px; font-family:var(--font); outline:none; background:white; cursor:pointer; }
.form-select:focus { border-color:#8b5cf6; }
.form-hint { font-size:12px; color:#9ca3af; margin-top:6px; }

/* â”€â”€ íŒŒì¼ ì—…ë¡œë“œ ì¡´ â”€â”€ */
.upload-zone { border:2px dashed #d1d5db; border-radius:16px; padding:40px 24px; text-align:center; cursor:pointer; transition:all .2s; background:#fafafa; position:relative; }
.upload-zone:hover { border-color:#8b5cf6; background:#f5f3ff; }
.upload-zone.has-file { border-color:#10b981; background:#f0fdf4; border-style:solid; }
.upload-zone input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; z-index:10; }
.uz-icon { font-size:40px; margin-bottom:12px; }
.uz-text { font-size:16px; font-weight:700; margin-bottom:4px; }
.uz-hint { font-size:13px; color:#9ca3af; }
.file-info-box { display:flex; align-items:center; gap:14px; background:#f0fdf4; border-radius:12px; padding:14px 16px; margin-top:16px; }
.file-info-icon { font-size:28px; flex-shrink:0; }
.file-info-name { font-weight:700; font-size:14px; }
.file-info-meta { font-size:12px; color:#6b7280; margin-top:2px; }

/* â”€â”€ ì»¤ë²„ ì—…ë¡œë“œ â”€â”€ */
.cover-upload { width:120px; height:120px; border-radius:16px; border:2px dashed #d1d5db; background:#f9fafb; display:flex; align-items:center; justify-content:center; cursor:pointer; overflow:hidden; flex-shrink:0; transition:all .2s; position:relative; }
.cover-upload:hover { border-color:#8b5cf6; background:#f5f3ff; }
.cover-upload img { width:100%; height:100%; object-fit:cover; border-radius:14px; display:none; }
.cover-upload.has-img img { display:block; }
.cover-upload.has-img .cover-placeholder { display:none; }
.cover-placeholder { text-align:center; pointer-events:none; }
.cover-upload input[type=file] { position:absolute; inset:0; opacity:0; cursor:pointer; z-index:10; }

/* â”€â”€ ì¬ìƒì‹œê°„ í‘œì‹œ â”€â”€ */
.duration-badge { display:inline-flex; align-items:center; gap:6px; background:#ede9fe; color:#7c3aed; border-radius:999px; padding:4px 14px; font-size:13px; font-weight:700; }

/* â”€â”€ Spotify ê²€ìƒ‰ ê²°ê³¼ â”€â”€ */
.spotify-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(140px,1fr)); gap:14px; margin-top:16px; }
.spotify-card { border:2px solid #e5e7eb; border-radius:14px; overflow:hidden; cursor:pointer; transition:all .2s; background:white; }
.spotify-card:hover { border-color:#1db954; transform:translateY(-2px); box-shadow:0 8px 20px rgba(0,0,0,.1); }
.spotify-card.selected { border-color:#1db954; background:#f0fdf4; }
.spotify-card img { width:100%; aspect-ratio:1; object-fit:cover; display:block; }
.spotify-card-info { padding:10px; }
.spotify-card-title { font-size:12px; font-weight:700; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }
.spotify-card-artist { font-size:11px; color:#6b7280; margin-top:2px; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; }

/* â”€â”€ ì„ íƒëœ Spotify ë©”íƒ€ â”€â”€ */
.spotify-meta-box { display:flex; gap:20px; align-items:center; background:#f0fdf4; border:1px solid #86efac; border-radius:16px; padding:20px; }
.spotify-meta-cover { width:80px; height:80px; border-radius:12px; object-fit:cover; flex-shrink:0; }
.meta-tag { display:inline-block; background:#dcfce7; color:#15803d; border-radius:999px; padding:3px 12px; font-size:12px; font-weight:700; margin-top:8px; }

/* â”€â”€ ì €ì‘ê¶Œ ì¸ì¦ í¼ â”€â”€ */
.auth-notice { background:#fef3c7; border:1px solid #fde047; border-radius:12px; padding:16px; margin-bottom:24px; font-size:13px; }
.auth-notice strong { color:#92400e; }
.auth-server-badge { display:inline-flex; align-items:center; gap:6px; background:#dbeafe; color:#1d4ed8; border-radius:999px; padding:4px 12px; font-size:12px; font-weight:700; }

/* â”€â”€ ì™„ë£Œ â”€â”€ */
.done-box { text-align:center; padding:40px 24px; }
.done-icon { font-size:64px; margin-bottom:20px; }
.done-title { font-size:28px; font-weight:900; margin-bottom:8px; }
.done-sub { color:#6b7280; font-size:15px; margin-bottom:32px; }
.tl-reward { display:inline-flex; align-items:center; gap:8px; background:#ede9fe; color:#7c3aed; border-radius:16px; padding:16px 28px; font-size:20px; font-weight:900; margin-bottom:32px; }

/* â”€â”€ ì •ë³´ ë°•ìŠ¤ë“¤ â”€â”€ */
.info-box { border-radius:12px; padding:14px 16px; font-size:13px; margin-bottom:16px; }
.info-box.purple { background:#ede9fe; color:#5b21b6; }
.info-box.green { background:#d1fae5; color:#065f46; }
.info-box.yellow { background:#fef3c7; color:#92400e; }

/* â”€â”€ ì—†ìŒ ë²„íŠ¼ â”€â”€ */
.no-spotify-btn { display:flex; align-items:center; justify-content:center; gap:8px; width:100%; padding:16px; border:2px dashed #d1d5db; border-radius:12px; background:white; color:#6b7280; font-size:14px; font-weight:600; cursor:pointer; transition:all .2s; margin-top:12px; }
.no-spotify-btn:hover { border-color:#8b5cf6; color:#8b5cf6; }

/* â”€â”€ í† ìŠ¤íŠ¸ â”€â”€ */
#toast-box { position:fixed; bottom:80px; right:24px; z-index:9999; display:flex; flex-direction:column; gap:8px; }
.toast { padding:12px 18px; border-radius:12px; font-size:14px; font-weight:600; color:white; box-shadow:0 4px 12px rgba(0,0,0,.15); animation:fadeIn .3s ease; max-width:320px; }
.toast.success { background:#10b981; } .toast.error { background:#ef4444; } .toast.info { background:#3b82f6; }
@keyframes fadeIn { from { opacity:0; transform:translateX(20px); } to { opacity:1; transform:translateX(0); } }

/* â”€â”€ í‘¸í„° â”€â”€ */
.page-footer { background:#1a1a2e; color:white; padding:48px 24px 32px; margin-top:80px; }
.footer-grid { max-width:1100px; margin:0 auto; display:grid; grid-template-columns:2fr 1fr 1fr 1fr; gap:40px; margin-bottom:40px; }
.footer-logo { font-size:22px; font-weight:900; margin-bottom:8px; color:white; }
.footer-tagline { font-size:13px; color:#9ca3af; }
.footer-col-title { font-size:12px; font-weight:700; color:#9ca3af; text-transform:uppercase; letter-spacing:.8px; margin-bottom:14px; }
.footer-col a { display:block; font-size:14px; color:#6b7280; text-decoration:none; margin-bottom:8px; }
.footer-col a:hover { color:#8b5cf6; }
.footer-bottom { max-width:1100px; margin:0 auto; padding-top:24px; border-top:1px solid #2d2d44; font-size:12px; color:#9ca3af; text-align:center; }
@media(max-width:768px){
  .footer-grid { grid-template-columns:1fr 1fr; gap:28px; }
  .form-row { grid-template-columns:1fr; }
  .stepper { gap:0; }
  .step-line { width:32px; }
}
</style>
</head>
<body>

<nav class="navbar">
  <a href="index.html" class="logo"><div class="logo-icon">âš¡</div><div>Time<span>Link</span></div></a>
  <div id="global-controls" style="display:flex;align-items:center;gap:6px;margin-left:auto;margin-right:12px;"><div id="currency-selector"></div></div>
  <div class="nav-right" id="nav-guest">
    <a href="login.html" class="btn btn-outline btn-sm" data-i18n="nav_login">ë¡œê·¸ì¸</a>
    <a href="signup.html" class="btn btn-primary btn-sm" data-i18n="nav_start">ì‹œì‘í•˜ê¸°</a>
  </div>
  <div class="nav-right hidden" id="nav-auth">
    <div class="balance">
      <div class="balance-item"><span class="balance-label">TL</span><span class="balance-value" id="balance-tl">0</span></div>
      <div class="balance-item"><span class="balance-label">TLC</span><span class="balance-value" id="balance-tlc">0.0000</span></div>
    </div>
    <div class="avatar-wrap">
      <div class="avatar" onclick="toggleDropdown()"><span id="avatar-letter">U</span></div>
      <div class="dropdown" id="dropdown">
        <a href="wallet.html" class="dropdown-item" data-i18n="tab_wallet">ğŸ‘› ì§€ê°‘</a>
        <a href="library.html" class="dropdown-item" data-i18n="tab_library">ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬</a>
        <a href="create.html" class="dropdown-item" data-i18n="tab_upload">ğŸ“¤ ì—…ë¡œë“œ</a>
        <a href="charge.html" class="dropdown-item">ğŸ’³ TL ì¶©ì „</a>
        <div class="dropdown-divider"></div>
        <div class="dropdown-item danger" onclick="logout()">ğŸšª ë¡œê·¸ì•„ì›ƒ</div>
      </div>
    </div>
  </div>
</nav>

<div class="tabs">
  <a href="index.html" class="tab" data-i18n="tab_home">ğŸ  í™ˆ</a>
  <a href="shareplace.html" class="tab" data-i18n="tab_shareplace">ğŸ›ï¸ SharePlace</a>
  <a href="library.html" class="tab" data-i18n="tab_library">ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬</a>
  <a href="create.html" class="tab active" data-i18n="tab_upload">ğŸ“¤ ì—…ë¡œë“œ</a>
  <a href="radio.html" class="tab" data-i18n="tab_radio">â˜• ì¹´í˜ë°©ì†¡</a>
  <a href="car.html" class="tab" data-i18n="tab_car">ğŸ§ Moving Radio</a>
  <a href="ads.html" class="tab" data-i18n="tab_ads">ğŸ“£ ê´‘ê³ </a>
  <a href="wallet.html" class="tab" data-i18n="tab_wallet">ğŸ‘› ì§€ê°‘</a>
  <a href="chart.html" class="tab" data-i18n="tab_chart">ğŸ“Š ì°¨íŠ¸</a>
  <a href="dashboard.html" class="tab" data-i18n="tab_dashboard">ğŸ“Š ëŒ€ì‹œë³´ë“œ</a>
</div>

<div class="container">
  <div class="page-header">
    <h1>ğŸ“¤ ìŒì› ë“±ë¡</h1>
    <p>ê¸°ë³¸ ì •ë³´ ì…ë ¥ â†’ Spotify ê²€ìƒ‰ â†’ ì €ì‘ê¶Œ ì¸ì¦ ìˆœì„œë¡œ ì§„í–‰ë©ë‹ˆë‹¤</p>
  </div>

  <!-- â”€â”€ ìŠ¤í… ì¸ë””ì¼€ì´í„° â”€â”€ -->
  <div class="stepper">
    <div class="step-col">
      <div class="step-circle active" id="sc1">1</div>
      <div class="step-label active" id="sl1">ê¸°ë³¸ ì •ë³´</div>
    </div>
    <div class="step-line" id="line1"></div>
    <div class="step-col">
      <div class="step-circle" id="sc2">2</div>
      <div class="step-label" id="sl2">Spotify ê²€ìƒ‰</div>
    </div>
    <div class="step-line" id="line2"></div>
    <div class="step-col">
      <div class="step-circle" id="sc3">3</div>
      <div class="step-label" id="sl3">ì €ì‘ê¶Œ ì¸ì¦</div>
    </div>
    <div class="step-line" id="line3"></div>
    <div class="step-col">
      <div class="step-circle" id="sc4">4</div>
      <div class="step-label" id="sl4">ì™„ë£Œ</div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 1: ê¸°ë³¸ ì •ë³´ + ìŒì› íŒŒì¼           -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="step1">
    <div class="card">
      <div class="card-title">ğŸµ ê¸°ë³¸ ì •ë³´</div>
      <div class="card-sub">ìŒì›ì˜ ê¸°ë³¸ ì •ë³´ì™€ íŒŒì¼ì„ ë“±ë¡í•˜ì„¸ìš”. ì¬ìƒì‹œê°„ì€ íŒŒì¼ì—ì„œ ìë™ìœ¼ë¡œ ì½ì–´ì˜µë‹ˆë‹¤.</div>

      <!-- ì»¤ë²„ + ì œëª©/ì•„í‹°ìŠ¤íŠ¸ -->
      <div style="display:flex;gap:20px;margin-bottom:24px;">
        <div>
          <div class="form-label">ì•¨ë²” ì»¤ë²„</div>
          <div class="cover-upload" id="cover-wrap">
            <input type="file" id="cover-file" accept="image/*" onchange="handleCover(this)">
            <img id="cover-img" alt="cover">
            <div class="cover-placeholder">
              <div style="font-size:28px;">ğŸ–¼ï¸</div>
              <div style="font-size:11px;color:#9ca3af;margin-top:4px;">í´ë¦­ ì—…ë¡œë“œ</div>
            </div>
          </div>
        </div>
        <div style="flex:1;">
          <div class="form-group">
            <label class="form-label">ì œëª© <span class="req">*</span></label>
            <input type="text" class="form-input" id="f-title" placeholder="íŠ¸ë™ ì œëª©">
          </div>
          <div class="form-group" style="margin-bottom:0;">
            <label class="form-label">ì•„í‹°ìŠ¤íŠ¸ëª… <span class="req">*</span></label>
            <input type="text" class="form-input" id="f-artist" placeholder="ì•„í‹°ìŠ¤íŠ¸ / ë°´ë“œëª…">
          </div>
        </div>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ì €ì‘ê¶Œìëª… <span class="req">*</span></label>
          <input type="text" class="form-input" id="f-copyright" placeholder="ì €ì‘ê¶Œ ì†Œìœ ì (ë³¸ì¸ ë˜ëŠ” ì†Œì†ì‚¬)">
        </div>
        <div class="form-group">
          <label class="form-label">ì¥ë¥´</label>
          <select class="form-select" id="f-genre">
            <option>K-POP</option><option>Electronic</option><option>Hip-Hop</option>
            <option>R&B/Soul</option><option>Jazz</option><option>Lo-Fi</option>
            <option>Rock</option><option>Indie</option><option>Classical</option>
            <option>Acoustic</option><option>OST</option><option>ê¸°íƒ€</option>
          </select>
        </div>
      </div>

      <div class="section-divider"></div>

      <!-- ìŒì› íŒŒì¼ -->
      <div class="form-group">
        <label class="form-label">ìŒì› íŒŒì¼ <span class="req">*</span></label>
        <div class="upload-zone" id="audio-zone">
          <input type="file" id="audio-file" accept="audio/*,video/*" onchange="handleAudioFile(this)">
          <div class="uz-icon">ğŸµ</div>
          <div class="uz-text">ìŒì› íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”</div>
          <div class="uz-hint">MP3, WAV, FLAC, AAC, MP4 (ìµœëŒ€ 500MB)</div>
        </div>
        <div id="audio-info" style="display:none;" class="file-info-box">
          <div class="file-info-icon" id="audio-icon">ğŸµ</div>
          <div>
            <div class="file-info-name" id="audio-name"></div>
            <div class="file-info-meta">
              <span id="audio-size"></span>
              &nbsp;Â·&nbsp;
              <span class="duration-badge">â± <span id="audio-duration">--:--</span></span>
            </div>
          </div>
        </div>
      </div>

      <div class="info-box purple">
        ğŸ ë“±ë¡ ì™„ë£Œ ì‹œ <strong>ì˜¤ë””ì˜¤ +300 TL / ì˜ìƒ +500 TL</strong> ì¦‰ì‹œ ì§€ê¸‰ë©ë‹ˆë‹¤
      </div>

      <button class="btn btn-primary" style="width:100%;padding:14px;" onclick="goStep2()">
        ë‹¤ìŒ: Spotifyì—ì„œ ìŒì› ê²€ìƒ‰ â†’
      </button>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 2: Spotify ê²€ìƒ‰                    -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="step2" style="display:none;">
    <div class="card">
      <div class="card-title">ğŸµ Spotify ìŒì› ê²€ìƒ‰</div>
      <div class="card-sub">
        ì…ë ¥í•œ ì •ë³´ë¡œ Spotifyë¥¼ ê²€ìƒ‰í•©ë‹ˆë‹¤. ê³µì‹ ë“±ë¡ëœ ìŒì›ì´ë©´ ë©”íƒ€ë°ì´í„°ê°€ ìë™ìœ¼ë¡œ ì ìš©ë©ë‹ˆë‹¤.
      </div>

      <!-- ê²€ìƒ‰ ì¸í’‹ (ìë™ ì±„ì›Œì§) -->
      <div style="display:flex;gap:10px;margin-bottom:20px;">
        <input type="text" class="form-input" id="sp-query" placeholder="ê²€ìƒ‰ì–´ ì…ë ¥..." style="flex:1;">
        <button class="btn btn-outline" onclick="searchSpotify()" id="sp-btn" style="flex-shrink:0;border-radius:12px;background:#1db954;color:white;border:none;padding:0 24px;">
          ğŸ” ê²€ìƒ‰
        </button>
      </div>

      <!-- ë¡œë”© -->
      <div id="sp-loading" style="display:none;text-align:center;padding:40px;color:#6b7280;">
        <div style="font-size:32px;margin-bottom:12px;">â³</div>
        <div style="font-weight:600;">Spotifyì—ì„œ ê²€ìƒ‰ ì¤‘...</div>
      </div>

      <!-- ê²€ìƒ‰ ê²°ê³¼ -->
      <div id="sp-results" style="display:none;">
        <div style="font-size:12px;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;">ê²€ìƒ‰ ê²°ê³¼</div>
        <div class="spotify-grid" id="sp-grid"></div>
      </div>

      <!-- ì—†ìŒ ë²„íŠ¼ -->
      <button class="no-spotify-btn" id="sp-none-btn" onclick="goStep3B()" style="display:none;">
        ğŸ“­ Spotifyì— ë“±ë¡ë˜ì§€ ì•Šì€ ìŒì›ì…ë‹ˆë‹¤ â†’ ìˆ˜ë™ ì €ì‘ê¶Œ ì¸ì¦ ì§„í–‰
      </button>

      <!-- ì„ íƒëœ Spotify ìŒì› -->
      <div id="sp-selected" style="display:none;">
        <div style="font-size:12px;font-weight:700;color:#9ca3af;text-transform:uppercase;letter-spacing:.5px;margin-bottom:12px;">ì„ íƒëœ ìŒì›</div>
        <div class="spotify-meta-box">
          <img id="sp-cover" class="spotify-meta-cover" src="" alt="">
          <div>
            <div style="font-size:18px;font-weight:800;" id="sp-title"></div>
            <div style="color:#6b7280;margin-top:2px;" id="sp-artist-name"></div>
            <div id="sp-meta-detail" style="font-size:13px;color:#6b7280;margin-top:6px;"></div>
            <div class="meta-tag">âœ“ Spotify ê³µì‹ ìŒì›</div>
          </div>
        </div>
        <div class="info-box green" style="margin-top:16px;">
          âœ… Spotify ë©”íƒ€ë°ì´í„°(ì»¤ë²„, ë°œë§¤ì¼, ë ˆì´ë¸” ë“±)ê°€ ìë™ ì ìš©ë©ë‹ˆë‹¤. ë³„ë„ ì¸ì¦ ì—†ì´ ë°”ë¡œ ë“±ë¡ë©ë‹ˆë‹¤.
        </div>
        <div style="display:flex;gap:10px;margin-top:8px;">
          <button class="btn btn-outline" onclick="resetSpotify()" style="flex:1;">ë‹¤ì‹œ ì„ íƒ</button>
          <button class="btn btn-primary" onclick="confirmSpotify()" style="flex:2;background:#1db954;">
            âœ… ì´ ìŒì›ìœ¼ë¡œ ë“±ë¡ â†’ SharePlace ë“±ë¡
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 3B: ìˆ˜ë™ ì €ì‘ê¶Œ ì¸ì¦              -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="step3b" style="display:none;">
    <div class="card">
      <div class="card-title">ğŸ“ ì €ì‘ê¶Œ ì¸ì¦ ì •ë³´ ì…ë ¥</div>
      <div class="card-sub">
        Spotifyì— ë“±ë¡ë˜ì§€ ì•Šì€ ìŒì›ì…ë‹ˆë‹¤. ì €ì‘ê¶Œ ì •ë³´ë¥¼ ì…ë ¥í•˜ë©´ ì¸ì¦ ì„œë²„ì— ì €ì¥ë˜ê³  TL íŒŒì¼ê³¼ ì—°ê²°ë©ë‹ˆë‹¤.
      </div>

      <div class="auth-notice">
        <strong>ğŸ“Œ ì•ˆë‚´:</strong> ì…ë ¥í•˜ì‹  ì •ë³´ëŠ” TimeLink ì¸ì¦ ì„œë²„(Cloudflare D1)ì— ì €ì¥ë©ë‹ˆë‹¤.
        í—ˆìœ„ ì •ë³´ ì…ë ¥ ì‹œ ê³„ì •ì´ ì œí•œë  ìˆ˜ ìˆìŠµë‹ˆë‹¤.
        <span class="auth-server-badge" style="margin-left:8px;">ğŸ” ì¸ì¦ ì„œë²„ ì €ì¥</span>
      </div>

      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ì‘ê³¡ì <span class="req">*</span></label>
          <input type="text" class="form-input" id="a-composer" placeholder="ì‘ê³¡ì ì´ë¦„">
        </div>
        <div class="form-group">
          <label class="form-label">ì‘ì‚¬ì</label>
          <input type="text" class="form-input" id="a-lyricist" placeholder="ì‘ì‚¬ì ì´ë¦„ (ì—†ìœ¼ë©´ ê³µë€)">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ë°œë§¤ì¼</label>
          <input type="date" class="form-input" id="a-release">
        </div>
        <div class="form-group">
          <label class="form-label">ë ˆì´ë¸” / ì†Œì†ì‚¬</label>
          <input type="text" class="form-input" id="a-label" placeholder="ë…ë¦½ ë ˆì´ë¸”, ì†Œì†ì‚¬ëª… ë“±">
        </div>
      </div>
      <div class="form-row">
        <div class="form-group">
          <label class="form-label">ISRC <span style="color:#9ca3af;font-weight:400;">(ì„ íƒ)</span></label>
          <input type="text" class="form-input" id="a-isrc" placeholder="KR-XXX-24-00000">
          <div class="form-hint">êµ­ì œ í‘œì¤€ ë…¹ìŒ ì½”ë“œ (ì—†ìœ¼ë©´ ê³µë€)</div>
        </div>
        <div class="form-group">
          <label class="form-label">ì €ì‘ê¶Œ ë“±ë¡ ë²ˆí˜¸ <span style="color:#9ca3af;font-weight:400;">(ì„ íƒ)</span></label>
          <input type="text" class="form-input" id="a-regnum" placeholder="í•œêµ­ì €ì‘ê¶Œìœ„ì›íšŒ ë“±ë¡ë²ˆí˜¸">
        </div>
      </div>

      <div class="form-group">
        <label class="form-label">ì €ì‘ê¶Œ ì¦ë¹™ ì„¤ëª…</label>
        <textarea class="form-input" id="a-desc" rows="3" style="resize:vertical;" placeholder="ì´ ìŒì›ì„ ì§ì ‘ ì°½ì‘í–ˆìŒì„ ì„¤ëª…í•´ì£¼ì„¸ìš”. (ë…¹ìŒ ê²½ìœ„, ì œì‘ ë„êµ¬, í˜‘ë ¥ ì•„í‹°ìŠ¤íŠ¸ ë“±)"></textarea>
      </div>

      <div style="background:#f8fafc;border:1px solid #e5e7eb;border-radius:12px;padding:16px;margin-bottom:20px;">
        <label style="display:flex;align-items:flex-start;gap:10px;cursor:pointer;">
          <input type="checkbox" id="a-confirm" style="margin-top:2px;width:18px;height:18px;accent-color:#8b5cf6;flex-shrink:0;">
          <span style="font-size:14px;color:#374151;">
            ë³¸ì¸ì´ ìœ„ ìŒì›ì˜ ì €ì‘ê¶Œìì„ì„ í™•ì¸í•˜ë©°, í—ˆìœ„ ë“±ë¡ì— ëŒ€í•œ ë²•ì  ì±…ì„ì„ ì§‘ë‹ˆë‹¤.
          </span>
        </label>
      </div>

      <div id="auth-status" style="display:none;"></div>

      <div style="display:flex;gap:10px;">
        <button class="btn btn-outline" onclick="backToStep2()" style="flex:1;">â† Spotify ì¬ê²€ìƒ‰</button>
        <button class="btn btn-primary" onclick="submitAuth()" id="auth-btn" style="flex:2;">
          ğŸ” ì¸ì¦ ì„œë²„ì— ì €ì¥ â†’ ë“±ë¡ ì™„ë£Œ
        </button>
      </div>
    </div>
  </div>

  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <!-- STEP 4: ì™„ë£Œ                            -->
  <!-- â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â• -->
  <div id="step4" style="display:none;">
    <div class="card">
      <div class="done-box">
        <div class="done-icon">ğŸ‰</div>
        <div class="done-title" id="done-title">ë“±ë¡ ì™„ë£Œ!</div>
        <div class="done-sub" id="done-sub">ìŒì›ì´ ì„±ê³µì ìœ¼ë¡œ ë“±ë¡ë˜ì—ˆìŠµë‹ˆë‹¤</div>
        <div class="tl-reward" id="done-reward">+300 TL ì§€ê¸‰!</div>
        <div id="done-sp-badge" style="display:none;margin-bottom:24px;">
          <div style="background:#d1fae5;color:#065f46;border-radius:12px;padding:12px 20px;font-weight:700;">
            ğŸ“£ SharePlaceì— ê³µê°œë˜ì—ˆìŠµë‹ˆë‹¤
          </div>
        </div>
        <div id="done-auth-badge" style="display:none;margin-bottom:24px;">
          <div class="auth-server-badge" style="font-size:14px;padding:10px 20px;">
            ğŸ” ì¸ì¦ ì„œë²„ì— ì €ì‘ê¶Œ ì •ë³´ ì €ì¥ë¨ (TL íŒŒì¼ ë§¤ì¹­ ì™„ë£Œ)
          </div>
        </div>
        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;">
          <a href="library.html" class="btn btn-primary">ğŸ” ë¼ì´ë¸ŒëŸ¬ë¦¬ì—ì„œ í™•ì¸</a>
          <a href="shareplace.html" class="btn btn-outline">ğŸ›ï¸ SharePlace ë³´ê¸°</a>
          <a href="create.html" class="btn btn-outline" onclick="location.reload();return false;">+ ë‹¤ë¥¸ ìŒì› ë“±ë¡</a>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- í† ìŠ¤íŠ¸ -->
<div id="toast-box"></div>

<!-- í‘¸í„° -->
<footer class="page-footer">
  <div class="footer-grid">
    <div>
      <div class="footer-logo">âš¡ TimeLink</div>
      <div class="footer-tagline" data-i18n="footer_slogan">ì°½ì‘ìë¥¼ ìœ„í•œ ìƒˆë¡œìš´ ìˆ˜ìµ í”Œë«í¼</div>
    </div>
    <div class="footer-col">
      <div class="footer-col-title" data-i18n="footer_service">ì„œë¹„ìŠ¤</div>
      <a href="shareplace.html" data-i18n="footer_shareplace">ğŸ›ï¸ SharePlace</a>
      <a href="radio.html" data-i18n="footer_radio">â˜• ì¹´í˜ë°©ì†¡</a>
      <a href="creator.html" data-i18n="footer_creator">ğŸµ ì°½ì‘ì í”„ë¡œê·¸ë¨</a>
      <a href="pricing.html" data-i18n="footer_pricing">ğŸ’³ ìš”ê¸ˆì œ</a>
    </div>
    <div class="footer-col">
      <div class="footer-col-title" data-i18n="footer_company">íšŒì‚¬</div>
      <a href="about.html" data-i18n="footer_about">ğŸ¢ íšŒì‚¬ ì†Œê°œ</a>
      <a href="tokenomics.html" data-i18n="footer_tokenomics">âš¡ í† í° ê²½ì œ</a>
      <a href="roadmap.html" data-i18n="footer_roadmap">ğŸ—ºï¸ ë¡œë“œë§µ</a>
      <a href="faq.html" data-i18n="footer_faq">â“ FAQ</a>
    </div>
    <div class="footer-col">
      <div class="footer-col-title" data-i18n="footer_legal">ë²•ë¬´</div>
      <a href="terms.html" data-i18n="footer_terms">ì´ìš©ì•½ê´€</a>
      <a href="privacy.html" data-i18n="footer_privacy">ê°œì¸ì •ë³´ì²˜ë¦¬ë°©ì¹¨</a>
      <a href="copyright.html" data-i18n="footer_copyright">ì €ì‘ê¶Œ ì •ì±…</a>
    </div>
  </div>
  <div class="footer-bottom">âš–ï¸ ëª¨ë“  íŒŒì¼ì˜ ì°½ì‘ê¶Œì€ ì°½ì‘ìì—ê²Œ ìˆìŠµë‹ˆë‹¤. Â© 2025 TimeLink. All rights reserved.</div>
</footer>

<script>
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ì „ì—­ ìƒíƒœ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
var state = {
  title: '', artist: '', copyright: '', genre: 'K-POP',
  coverDataUrl: null,
  audioFile: null,
  audioDuration: 0,
  audioDataUrl: null,    // IDB ì €ì¥ ì „ ì„ì‹œ
  tlFileId: null,
  spotifyData: null,     // Spotifyì—ì„œ ê°€ì ¸ì˜¨ ë©”íƒ€
  authMethod: null,      // 'spotify' | 'manual'
};
var _spotifyAlbums = [];

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// í† ìŠ¤íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function showToast(msg, type) {
  var box = document.getElementById('toast-box');
  var t = document.createElement('div');
  t.className = 'toast ' + (type || 'info');
  t.textContent = msg;
  box.appendChild(t);
  setTimeout(function() { if(t.parentNode) t.parentNode.removeChild(t); }, 3500);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìŠ¤í… ì¸ë””ì¼€ì´í„° ì—…ë°ì´íŠ¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function setStep(n) {
  [1,2,3,4].forEach(function(i) {
    var sc = document.getElementById('sc'+i);
    var sl = document.getElementById('sl'+i);
    if (!sc) return;
    sc.classList.remove('active','done');
    sl.classList.remove('active','done');
    if (i < n) { sc.classList.add('done'); sl.classList.add('done'); sc.textContent = 'âœ“'; }
    else if (i === n) { sc.classList.add('active'); sl.classList.add('active'); }
    else { sc.textContent = i; }
    if (i < 4) {
      var line = document.getElementById('line'+i);
      if (line) { line.classList.toggle('done', i < n); }
    }
  });
  ['step1','step2','step3b','step4'].forEach(function(id){ document.getElementById(id).style.display='none'; });
  if (n === 1) document.getElementById('step1').style.display = 'block';
  else if (n === 2) document.getElementById('step2').style.display = 'block';
  else if (n === 3) document.getElementById('step3b').style.display = 'block';
  else if (n === 4) document.getElementById('step4').style.display = 'block';
  window.scrollTo({top:0, behavior:'smooth'});
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 1: ì»¤ë²„ + íŒŒì¼ í•¸ë“¤ëŸ¬
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function handleCover(input) {
  var file = input.files[0];
  if (!file) return;
  var reader = new FileReader();
  reader.onload = function(e) {
    state.coverDataUrl = e.target.result;
    var img = document.getElementById('cover-img');
    img.src = e.target.result;
    document.getElementById('cover-wrap').classList.add('has-img');
  };
  reader.readAsDataURL(file);
}

function handleAudioFile(input) {
  var file = input.files[0];
  if (!file) return;
  if (file.size > 500 * 1024 * 1024) { showToast('500MB ì´í•˜ íŒŒì¼ë§Œ ê°€ëŠ¥í•©ë‹ˆë‹¤', 'error'); return; }

  state.audioFile = file;
  var isVideo = file.type.startsWith('video/');

  // ì¬ìƒì‹œê°„ ìë™ ê°ì§€
  var url = URL.createObjectURL(file);
  var media = document.createElement(isVideo ? 'video' : 'audio');
  media.src = url;
  media.onloadedmetadata = function() {
    state.audioDuration = Math.floor(media.duration);
    URL.revokeObjectURL(url);
    var m = Math.floor(state.audioDuration / 60);
    var s = state.audioDuration % 60;
    document.getElementById('audio-duration').textContent = m + ':' + (s < 10 ? '0' : '') + s;
  };

  // UI í‘œì‹œ
  document.getElementById('audio-zone').classList.add('has-file');
  document.getElementById('audio-icon').textContent = isVideo ? 'ğŸ¬' : 'ğŸµ';
  document.getElementById('audio-name').textContent = file.name;
  document.getElementById('audio-size').textContent = (file.size / 1024 / 1024).toFixed(1) + ' MB';
  document.getElementById('audio-info').style.display = 'flex';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 1 â†’ STEP 2
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function goStep2() {
  var title = document.getElementById('f-title').value.trim();
  var artist = document.getElementById('f-artist').value.trim();
  var copyright = document.getElementById('f-copyright').value.trim();

  if (!title) { showToast('ì œëª©ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); document.getElementById('f-title').focus(); return; }
  if (!artist) { showToast('ì•„í‹°ìŠ¤íŠ¸ëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); document.getElementById('f-artist').focus(); return; }
  if (!copyright) { showToast('ì €ì‘ê¶Œìëª…ì„ ì…ë ¥í•˜ì„¸ìš”', 'error'); document.getElementById('f-copyright').focus(); return; }
  if (!state.audioFile) { showToast('ìŒì› íŒŒì¼ì„ ì„ íƒí•˜ì„¸ìš”', 'error'); return; }

  state.title = title;
  state.artist = artist;
  state.copyright = copyright;
  state.genre = document.getElementById('f-genre').value;
  state.tlFileId = (state.audioFile.type.startsWith('video/') ? 'tl4_' : 'tl3_') + Date.now();

  // Spotify ê²€ìƒ‰ì°½ ìë™ ì±„ìš°ê¸°
  document.getElementById('sp-query').value = title + ' ' + artist;
  setStep(2);

  // ìë™ ê²€ìƒ‰ ì‹œì‘
  setTimeout(searchSpotify, 400);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 2: Spotify ê²€ìƒ‰
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function searchSpotify() {
  var query = document.getElementById('sp-query').value.trim();
  if (!query) return;

  document.getElementById('sp-loading').style.display = 'block';
  document.getElementById('sp-results').style.display = 'none';
  document.getElementById('sp-selected').style.display = 'none';
  document.getElementById('sp-none-btn').style.display = 'none';

  try {
    var res = await fetch('https://spotify-worker.mununglee.workers.dev/api/spotify-search', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify({query: query})
    });
    var data = await res.json();
    document.getElementById('sp-loading').style.display = 'none';

    if (!data.albums || data.albums.length === 0) {
      document.getElementById('sp-grid').innerHTML = '<div style="color:#9ca3af;font-size:14px;grid-column:1/-1;text-align:center;padding:20px;">ê²€ìƒ‰ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤</div>';
      document.getElementById('sp-results').style.display = 'block';
      document.getElementById('sp-none-btn').style.display = 'flex';
      return;
    }

    _spotifyAlbums = data.albums;
    document.getElementById('sp-grid').innerHTML = data.albums.map(function(a, i) {
      return '<div class="spotify-card" onclick="selectSpotify(' + i + ')">' +
        '<img src="' + (a.coverImage || a.thumbnail || '') + '" onerror="this.src=\'\';">' +
        '<div class="spotify-card-info">' +
          '<div class="spotify-card-title">' + escHtml(a.name || '') + '</div>' +
          '<div class="spotify-card-artist">' + escHtml(a.artist || '') + '</div>' +
        '</div></div>';
    }).join('');

    document.getElementById('sp-results').style.display = 'block';
    document.getElementById('sp-none-btn').style.display = 'flex';
  } catch(e) {
    document.getElementById('sp-loading').style.display = 'none';
    showToast('Spotify ê²€ìƒ‰ ì˜¤ë¥˜: ' + e.message, 'error');
    document.getElementById('sp-none-btn').style.display = 'flex';
  }
}

function selectSpotify(idx) {
  var album = _spotifyAlbums[idx];
  state.spotifyData = album;
  document.getElementById('sp-cover').src = album.coverImage || album.thumbnail || '';
  document.getElementById('sp-title').textContent = album.name || '';
  document.getElementById('sp-artist-name').textContent = album.artist || '';
  document.getElementById('sp-meta-detail').textContent =
    [album.releaseDate, album.label].filter(Boolean).join(' Â· ') || '';
  document.getElementById('sp-results').style.display = 'none';
  document.getElementById('sp-none-btn').style.display = 'none';
  document.getElementById('sp-selected').style.display = 'block';

  // ì»¤ë²„ê°€ ì—†ìœ¼ë©´ Spotify ì»¤ë²„ ì‚¬ìš©
  if (!state.coverDataUrl && album.coverImage) state.coverDataUrl = album.coverImage;
}

function resetSpotify() {
  state.spotifyData = null;
  document.getElementById('sp-selected').style.display = 'none';
  document.getElementById('sp-results').style.display = 'block';
  document.getElementById('sp-none-btn').style.display = 'flex';
}

async function confirmSpotify() {
  state.authMethod = 'spotify';
  await finalizeUpload();
}

function goStep3B() {
  setStep(3);
}

function backToStep2() {
  setStep(2);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// STEP 3B: ìˆ˜ë™ ì¸ì¦ â†’ ì¸ì¦ ì„œë²„ ì €ì¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function submitAuth() {
  var composer = document.getElementById('a-composer').value.trim();
  if (!composer) { showToast('ì‘ê³¡ìë¥¼ ì…ë ¥í•˜ì„¸ìš”', 'error'); return; }
  if (!document.getElementById('a-confirm').checked) { showToast('ì €ì‘ê¶Œ í™•ì¸ì— ë™ì˜í•´ì£¼ì„¸ìš”', 'error'); return; }

  var btn = document.getElementById('auth-btn');
  btn.disabled = true;
  btn.textContent = 'â³ ì¸ì¦ ì„œë²„ì— ì €ì¥ ì¤‘...';

  var authData = {
    tlFileId:   state.tlFileId,
    title:      state.title,
    artist:     state.artist,
    copyright:  state.copyright,
    genre:      state.genre,
    composer:   composer,
    lyricist:   document.getElementById('a-lyricist').value.trim(),
    releaseDate: document.getElementById('a-release').value,
    label:      document.getElementById('a-label').value.trim(),
    isrc:       document.getElementById('a-isrc').value.trim(),
    regNum:     document.getElementById('a-regnum').value.trim(),
    description: document.getElementById('a-desc').value.trim(),
    registeredAt: new Date().toISOString(),
  };

  // ìƒíƒœ í‘œì‹œ
  var statusEl = document.getElementById('auth-status');

  try {
    var res = await fetch('https://timelink-backend.mununglee.workers.dev/api/auth-register', {
      method: 'POST',
      headers: {'Content-Type': 'application/json'},
      body: JSON.stringify(authData)
    });

    if (!res.ok) throw new Error('ì„œë²„ ì‘ë‹µ ì˜¤ë¥˜ ' + res.status);

    statusEl.style.display = 'block';
    statusEl.innerHTML = '<div class="info-box green">âœ… ì¸ì¦ ì„œë²„ ì €ì¥ ì™„ë£Œ (TL íŒŒì¼ ID: ' + state.tlFileId + ')</div>';
    state.authMethod = 'manual';
    await finalizeUpload();

  } catch(e) {
    // ì„œë²„ ì˜¤ë¥˜ ì‹œ: ë¡œì»¬ì— ì„ì‹œ ì €ì¥ í›„ ì§„í–‰
    statusEl.style.display = 'block';
    statusEl.innerHTML = '<div class="info-box yellow">âš ï¸ ì¸ì¦ ì„œë²„ ì—°ê²° ì‹¤íŒ¨. ì •ë³´ë¥¼ ë¡œì»¬ì— ì„ì‹œ ì €ì¥í•©ë‹ˆë‹¤.<br><small>' + e.message + '</small></div>';
    var pending = JSON.parse(localStorage.getItem('tl_auth_pending') || '[]');
    pending.push(authData);
    localStorage.setItem('tl_auth_pending', JSON.stringify(pending));
    state.authMethod = 'manual';
    await finalizeUpload();
  }

  btn.disabled = false;
  btn.textContent = 'ğŸ” ì¸ì¦ ì„œë²„ì— ì €ì¥ â†’ ë“±ë¡ ì™„ë£Œ';
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìµœì¢… TL íŒŒì¼ ìƒì„± + IDB ì €ì¥ + TL ë³´ìƒ
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
async function finalizeUpload() {
  var isVideo = state.audioFile.type.startsWith('video/');
  var REWARD = isVideo ? 500 : 300;

  // ì‚¬ìš©ì TL ë³´ìƒ ì§€ê¸‰
  var user = JSON.parse(localStorage.getItem('tl_user') || '{}');
  user.tl = (Number(user.tl) || 0) + REWARD;
  localStorage.setItem('tl_user', JSON.stringify(user));

  // IDBì— ìŒì› íŒŒì¼ ì €ì¥
  var fileId = state.tlFileId;
  try {
    await idbSave(fileId, state.audioFile);
  } catch(e) {
    console.warn('IDB ì €ì¥ ì‹¤íŒ¨, dataUrl í´ë°±:', e);
    // IDB ì‹¤íŒ¨ ì‹œ dataUrlë¡œ í´ë°±
  }

  // Spotify ë©”íƒ€ ë˜ëŠ” ìˆ˜ë™ ì»¤ë²„ ê²°ì •
  var coverImage = state.coverDataUrl ||
    (state.spotifyData && state.spotifyData.coverImage) ||
    (isVideo ? 'ğŸ¬' : 'ğŸµ');

  // localStorageì— ë©”íƒ€ë°ì´í„° ì €ì¥
  var newFile = {
    id:              fileId,
    title:           state.title,
    artist:          state.artist,
    copyright:       state.copyright,
    genre:           state.genre,
    type:            isVideo ? 'video' : 'audio',
    format:          isVideo ? 'TL4' : 'TL3',
    fileTL:          0,
    maxFileTL:       0,
    authStatus:      state.authMethod === 'spotify' ? 'spotify_verified' : 'manual_verified',
    createdAt:       Date.now(),
    duration:        state.audioDuration,
    coverImage:      coverImage,
    pulse:           Math.floor(Math.random() * 30000) + 5000,
    sharedToSharePlace: true,
    pricePerSec:     isVideo ? 2 : 1,
    uploadReward:    REWARD,
    idbStored:       true,
    fileSize:        state.audioFile.size,
    fileName:        state.audioFile.name,
    mimeType:        state.audioFile.type,
    spotifyMeta:     state.spotifyData || null,
    authMethod:      state.authMethod,
  };

  var myFiles = JSON.parse(localStorage.getItem('tl_myfiles') || '[]');
  myFiles.unshift(newFile);
  localStorage.setItem('tl_myfiles', JSON.stringify(myFiles));

  // ì™„ë£Œ í™”ë©´
  document.getElementById('done-title').textContent = '"' + state.title + '" ë“±ë¡ ì™„ë£Œ!';
  document.getElementById('done-sub').textContent =
    state.authMethod === 'spotify' ? 'Spotify ê³µì‹ ìŒì›ìœ¼ë¡œ ì¸ì¦ë˜ì—ˆìŠµë‹ˆë‹¤' : 'ì €ì‘ê¶Œ ì •ë³´ê°€ ì¸ì¦ ì„œë²„ì— ì €ì¥ë˜ì—ˆìŠµë‹ˆë‹¤';
  document.getElementById('done-reward').textContent = '+' + REWARD + ' TL ì§€ê¸‰!';
  document.getElementById('done-sp-badge').style.display = 'block';
  document.getElementById('done-auth-badge').style.display = state.authMethod === 'manual' ? 'block' : 'none';

  // ì”ì•¡ ì—…ë°ì´íŠ¸
  if (typeof updateNavbar === 'function') updateNavbar();

  setStep(4);
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// IndexedDB ì €ì¥
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function idbSave(id, file) {
  return new Promise(function(resolve, reject) {
    var req = indexedDB.open('tl_audio_db', 1);
    req.onupgradeneeded = function(e) {
      e.target.result.createObjectStore('files', {keyPath: 'id'});
    };
    req.onsuccess = function(e) {
      var db = e.target.result;
      var tx = db.transaction('files', 'readwrite');
      var store = tx.objectStore('files');
      var put = store.put({id: id, file: file, savedAt: Date.now()});
      put.onsuccess = function() { resolve(); };
      put.onerror = function() { reject(put.error); };
    };
    req.onerror = function() { reject(req.error); };
  });
}

// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
// ìœ í‹¸
// â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;');
}
</script>

<script src="tl-economy.js"></script>
<script src="i18n.js"></script>
<script src="currency.js"></script>

<script>
// â”€â”€ ê³µí†µ ì¸ì¦ & ë„¤ë¹„ â”€â”€
(function(){
  var user = null;
  try { user = JSON.parse(localStorage.getItem('tl_user') || 'null'); } catch(e){}

  function toggleDropdown(){ document.getElementById('dropdown')?.classList.toggle('show'); }
  window.toggleDropdown = toggleDropdown;

  function logout(){ localStorage.removeItem('tl_user'); localStorage.removeItem('auth_token'); window.location.href='index.html'; }
  window.logout = logout;

  function updateNavbar(){
    var navAuth = document.getElementById('nav-auth');
    var navGuest = document.getElementById('nav-guest');
    var balTl = document.getElementById('balance-tl');
    var balTlc = document.getElementById('balance-tlc');
    var avL = document.getElementById('avatar-letter');
    // ìµœì‹  user ì½ê¸°
    try { user = JSON.parse(localStorage.getItem('tl_user') || 'null'); } catch(e){}
    if (user) {
      navAuth?.classList.remove('hidden'); navGuest?.classList.add('hidden');
      if(balTl) balTl.textContent = (user.tl||0).toLocaleString();
      if(balTlc) balTlc.textContent = parseFloat(user.tlc||0).toFixed(4);
      if(avL) avL.textContent = (user.username||'U').charAt(0).toUpperCase();
    } else {
      navAuth?.classList.add('hidden'); navGuest?.classList.remove('hidden');
    }
  }
  window.updateNavbar = updateNavbar;

  document.addEventListener('click', function(e){
    if(!e.target.closest('.avatar-wrap')){ document.getElementById('dropdown')?.classList.remove('show'); }
  });

  document.addEventListener('DOMContentLoaded', function(){
    updateNavbar();
    if(typeof I18N !== 'undefined'){ I18N.lang=I18N.detect(); I18N.renderSelector('lang-selector'); I18N.applyAll(); }
    if(typeof CURRENCY !== 'undefined'){ CURRENCY.current=CURRENCY.detect(); CURRENCY.renderSelector('currency-selector'); CURRENCY.applyAll(); }
  });
})();
</script>
</body>
</html>
