<!DOCTYPE html>
<html lang="ko">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>내 대시보드 - TimeLink</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<style>
* { margin:0; padding:0; box-sizing:border-box; }
body { font-family:Inter,sans-serif; background:#f8fafc; color:#0f172a; }

/* 네비게이션 */
.navbar { background:white; border-bottom:1px solid #e2e8f0; padding:0 24px; height:64px; display:flex; align-items:center; justify-content:space-between; position:sticky; top:0; z-index:100; }
.logo { display:flex; align-items:center; gap:10px; font-size:20px; font-weight:800; color:#0f172a; text-decoration:none; }
.logo-icon { width:32px; height:32px; background:#f59e0b; border-radius:8px; display:flex; align-items:center; justify-content:center; color:white; font-size:16px; }
.logo span { color:#f59e0b; }
.nav-right { display:flex; align-items:center; gap:12px; }

/* 버튼 */
.btn { display:inline-flex; align-items:center; justify-content:center; gap:8px; padding:10px 20px; border-radius:999px; font-weight:600; font-size:14px; cursor:pointer; border:none; text-decoration:none; }
.btn-primary { background:#f59e0b; color:white; }
.btn-outline { background:white; color:#1f2937; border:1px solid #e5e7eb; }
.btn-sm { padding:6px 14px; font-size:13px; }

/* 밸런스 */
.balance { background:#f3f4f6; border-radius:999px; padding:6px 16px; display:flex; align-items:center; gap:16px; }
.balance-item { display:flex; align-items:center; gap:6px; font-size:14px; }
.balance-label { color:#6b7280; font-weight:500; }
.balance-value { font-weight:700; color:#f59e0b; }

/* 아바타 */
.avatar { width:36px; height:36px; background:#f59e0b; border-radius:50%; display:flex; align-items:center; justify-content:center; color:white; font-weight:700; cursor:pointer; position:relative; }
.dropdown { position:absolute; top:100%; right:0; margin-top:8px; background:white; border:1px solid #e5e7eb; border-radius:12px; box-shadow:0 10px 15px -3px rgba(0,0,0,0.1); width:200px; display:none; z-index:1000; }
.dropdown.show { display:block; }
.dropdown-item { padding:12px 16px; cursor:pointer; font-size:14px; color:#1f2937; text-decoration:none; display:block; }
.dropdown-item:hover { background:#f3f4f6; }
.dropdown-item.danger { color:#ef4444; }

/* 탭 메뉴 */
.tabs { background:white; border-bottom:1px solid #e5e7eb; padding:0 24px; display:flex; justify-content:center; gap:4px; position:sticky; top:64px; z-index:90; overflow-x:auto; }
.tab { padding:12px 20px; font-size:14px; font-weight:600; color:#6b7280; text-decoration:none; border-bottom:2px solid transparent; transition:all 0.2s; white-space:nowrap; }
.tab:hover { color:#f59e0b; }
.tab.active { color:#8b5cf6; border-bottom-color:#f59e0b; }

/* 메인 컨테이너 */
.container { max-width:1200px; margin:0 auto; padding:40px 24px; }

/* POC 카드 */
.poc-card { background:white; border-radius:20px; padding:24px; margin-bottom:24px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); display:flex; align-items:center; justify-content:space-between; }
.poc-score { font-size:48px; font-weight:800; color:#8b5cf6; }

/* 차트 */
.chart-row { display:grid; grid-template-columns:1fr 1fr; gap:24px; margin-bottom:40px; }
.chart-container { background:white; border-radius:20px; padding:24px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }

/* 랭킹 */
.ranking-section { background:white; border-radius:20px; padding:24px; box-shadow:0 4px 6px -1px rgba(0,0,0,0.1); }
.ranking-tabs { display:flex; gap:8px; margin:20px 0; }
.rank-tab { padding:8px 16px; border-radius:999px; border:1px solid #e2e8f0; background:white; cursor:pointer; }
.rank-tab.active { background:#8b5cf6; color:white; border-color:#8b5cf6; }
.ranking-table { width:100%; border-collapse:collapse; }
.ranking-table th { text-align:left; padding:12px; background:#f1f5f9; }
.ranking-table td { padding:12px; border-bottom:1px solid #f1f5f9; }

/* 푸터 */
.page-footer { background:#f9fafb; border-top:1px solid #e5e7eb; padding:40px 24px; text-align:center; margin-top:60px; }
.footer-links { display:flex; justify-content:center; gap:24px; margin-bottom:16px; flex-wrap:wrap; }
.footer-links a { color:#6b7280; text-decoration:none; font-size:13px; }
.footer-links a:hover { color:#f59e0b; }
.footer-links a:last-child { color:#ef4444; }
.footer-copyright { font-size:11px; color:#9ca3af; }

.hidden { display:none !important; }
</style>

<!-- ===== 간단한 로컬 시간 변환 ===== -->
<script>
// UTC 시간을 사용자 로컬 시간으로 변환
function displayLocalTime() {
  document.querySelectorAll([data-utc]).forEach(el => {
    const utc = el.getAttribute(data-utc);
    if (utc) {
      el.textContent = new Date(utc).toLocaleString();
    }
  });
}

// 페이지 로드 시 실행
document.addEventListener(DOMContentLoaded, displayLocalTime);
</script>
</head>
<body>

<nav class="navbar">
  <a href="index.html" class="logo"><div class="logo-icon">⚡</div><div>Time<span>Link</span></div></a>
  <div class="nav-right" id="nav-guest">
    <a href="login.html" class="btn btn-outline btn-sm"><span data-i18n="login">로그인</span></a>
    <a href="signup.html" class="btn btn-primary btn-sm"><span data-i18n="signup">시작하기</span></a>
  </div>
  <div class="nav-right hidden" id="nav-auth">
    <div class="balance">
      <div class="balance-item"><span class="balance-label">TL</span><span class="balance-value" id="balance-tl">7,300</span></div>
      <div class="balance-item"><span class="balance-label">TLC</span><span class="balance-value" id="balance-tlc">0.0000</span></div>
    </div>
    <div class="avatar" onclick="toggleDropdown()">
      <span id="avatar-letter">U</span>
      <div class="dropdown" id="dropdown">
        <a href="wallet.html" class="dropdown-item">👛 <span data-i18n="wallet">지갑</span></a>
        <a href="library.html" class="dropdown-item">🔍 <span data-i18n="library">라이브러리</span></a>
        <a href="create.html" class="dropdown-item">📤 <span data-i18n="upload">업로드</span></a>
        <a href="dashboard.html" class="dropdown-item">📊 <span data-i18n="dashboard">대시보드</span></a>
        <a href="settings.html" class="dropdown-item">⚙️ 설정</a>
        <div class="dropdown-item danger" onclick="logout()">🚪 <span data-i18n="logout">로그아웃</span></div>
      </div>
    </div>
  </div>
</nav>

<div class="tabs">
  <a href="index.html" class="tab"><span data-i18n="home">홈</span></a>
  <a href="shareplace.html" class="tab"><span data-i18n="shareplace">SharePlace</span></a>
  <a href="library.html" class="tab"><span data-i18n="library">라이브러리</span></a>
  <a href="create.html" class="tab"><span data-i18n="upload">업로드</span></a>
  <a href="player.html" class="tab"><span data-i18n="player">플레이어</span></a>
  <a href="radio.html" class="tab"><span data-i18n="radio">카페방송</span></a>
  <a href="moving-radio.html" class="tab"><span data-i18n="moving">Moving Radio</span></a>
  <a href="ads.html" class="tab"><span data-i18n="ads">광고</span></a>
  <a href="wallet.html" class="tab"><span data-i18n="wallet">지갑</span></a>
  <a href="chart.html" class="tab"><span data-i18n="chart">차트</span></a>
  <a href="dashboard.html" class="tab active"><span data-i18n="dashboard">📊 대시보드</span></a>
</div>

<div class="container">
  <h1 style="margin-bottom:32px;">📊 <span data-i18n="dashboard">내 대시보드</span></h1>
  
  <div class="poc-card">
    <div>
      <h3 style="margin-bottom:8px;">⚡ <span data-i18n="poc_score">기여도 점수 (POC)</span></h3>
      <div style="color:#64748b;"><span data-i18n="poc_desc">누적 활동 점수 (마이너스 가능)</span></div>
    </div>
    <div class="poc-score" id="poc-score">0</div>
  </div>

  <div class="chart-row">
    <div class="chart-container">
      <h4 style="margin-bottom:16px;">📈 <span data-i18n="daily_tlc">일별 TLC 채굴량</span></h4>
      <canvas id="tlcChart" height="200"></canvas>
    </div>
    <div class="chart-container">
      <h4 style="margin-bottom:16px;">📊 <span data-i18n="weekly_tl">주간 TL 사용량</span></h4>
      <canvas id="tlChart" height="200"></canvas>
    </div>
  </div>

  <div class="ranking-section">
    <h3>🏆 <span data-i18n="weekly_ranking">주간 랭킹</span></h3>
    <div class="ranking-tabs">
      <button class="rank-tab active" onclick="loadRanking(tlc, this)"><span data-i18n="tlc_ranking">TLC 채굴</span></button>
      <button class="rank-tab" onclick="loadRanking(points, this)"><span data-i18n="points_ranking">기여도</span></button>
    </div>
    <table class="ranking-table">
      <thead><tr><th><span data-i18n="rank">순위</span></th><th><span data-i18n="user">사용자</span></th><th><span data-i18n="value">값</span></th></tr></thead>
      <tbody id="ranking-body"></tbody>
    </table>
  </div>
</div>

<footer class="page-footer">
  <div class="footer-links">
    <a href="#"><span data-i18n="terms">이용약관</span></a>
    <a href="#"><span data-i18n="privacy">개인정보처리방침</span></a>
    <a href="#"><span data-i18n="copyright_policy">저작권 정책</span></a>
    <a href="#" style="color:#ef4444;"><span data-i18n="report">저작권 침해 신고</span></a>
  </div>
  <div class="footer-copyright">
    <span data-i18n-copyright>⚖️ 모든 파일의 창작권은 창작자에게 있습니다.</span>
  </div>
</footer>

<script>
// ===== 공통 로그인 상태 관리 =====
let currentUser = JSON.parse(localStorage.getItem("tl_user") || "null");

function toggleDropdown() { document.getElementById("dropdown")?.classList.toggle("show"); }
document.addEventListener(click, function(e) { if (!e.target.closest(.avatar)) document.getElementById("dropdown")?.classList.remove("show"); });

function logout() {
  localStorage.removeItem(tl_user);
  localStorage.removeItem(auth_token);
  window.location.href = index.html;
}

// 네비게이션 업데이트
function updateNavbar() {
  const navAuth = document.getElementById(av-auth);
  const navGuest = document.getElementById(av-guest);
  const balanceTl = document.getElementById(balance-tl);
  const balanceTlc = document.getElementById(balance-tlc);
  const avatarLetter = document.getElementById(avatar-letter);

  if (currentUser) {
    navAuth?.classList.remove("hidden");
    navGuest?.classList.add("hidden");
    if (balanceTl) balanceTl.innerHTML = `<span data-currency="${currentUser.tl || 7300}">${(currentUser.tl || 7300).toLocaleString()}</span>`;
    if (balanceTlc) balanceTlc.textContent = (currentUser.tlc || 0).toFixed(4);
    if (avatarLetter) avatarLetter.textContent = (currentUser.username || U).charAt(0).toUpperCase();
  } else {
    navAuth?.classList.add("hidden");
    navGuest?.classList.remove("hidden");
  }
}

// ===== 기여도 API =====
const API_BASE = https://timelink-api.mununglee.workers.dev;

async function loadPOC() {
  if (!currentUser) return;
  const res = await fetch(`${API_BASE}/api/user-stats?user_id=${currentUser.id}&period=month`);
  const data = await res.json();
  document.getElementById(poc-score).textContent = data.total_points;
}

function loadCharts() {
  new Chart(document.getElementById("tlcChart"), {
    type: line,
    data: {
      labels: [월,화,수,목,금,토,일],
      datasets: [{
        label: TLC 채굴,
        data: [12, 19, 3, 5, 2, 3, 10],
        borderColor: #8b5cf6,
        tension: 0.1
      }]
    }
  });
  new Chart(document.getElementById("tlChart"), {
    type: bar,
    data: {
      labels: [1주,2주,3주,4주],
      datasets: [{
        label: TL 사용,
        data: [120, 190, 30, 50],
        backgroundColor: #8b5cf6
      }]
    }
  });
}

async function loadRanking(type, btn) {
  document.querySelectorAll(.rank-tab).forEach(t => t.classList.remove("active"));
  btn.classList.add("active");
  
  const res = await fetch(`${API_BASE}/api/ranking?type=${type}&period=week&limit=10`);
  const ranks = await res.json();
  let html = ;
  ranks.forEach((item, idx) => {
    html += `<tr><td>${idx+1}</td><td>User ${item.user_id}</td><td>${item.value}</td></tr>`;
  });
  document.getElementById(ranking-body).innerHTML = html;
}

// 초기화
updateNavbar();
if (currentUser) {
  loadPOC();
  loadCharts();
  loadRanking(tlc, document.querySelector(.rank-tab));
}
</script>

<!-- activity.js (활동 추적) -->
<script src="/activity.js"></script>

<!-- 글로벌 변환 스크립트 -->
<script>
if (typeof Global === undefined) {
  window.Global = {
    lang: localStorage.getItem("global_lang") || ko,
    currency: localStorage.getItem("global_currency") || KRW,
    rates: { KRW: { symbol: ₩, rate:1 }, USD: { symbol: $, rate:0.00075 } }
  };
  setTimeout(() => {
    if (!document.querySelector(.global-selector)) {
      let sel = document.createElement(div);
      sel.className = global-selector;
      sel.innerHTML = `
        <select onchange="Global.lang=this.value;localStorage.setItem("global_lang",this.value)">
          <option value="ko" ${Global.lang===ko?selected:}>🇰🇷 한국어</option>
          <option value="en" ${Global.lang===en?selected:}>🇺🇸 English</option>
        </select>
        <select onchange="Global.currency=this.value;localStorage.setItem("global_currency",this.value);Global.updateCurrency?.()">
          <option value="KRW" ${Global.currency===KRW?selected:}>₩ KRW</option>
          <option value="USD" ${Global.currency===USD?selected:}>$ USD</option>
        </select>
      `;
      document.body.appendChild(sel);
    }
    Global.updateCurrency?.();
  }, 100);
}
</script>
</body>
</html>









